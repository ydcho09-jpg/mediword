<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- ★ 보안 헤더 ★ -->
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
<title>MEDI WORLD v5.0</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-Avb2QiuTy/Sz4uFZAAAAAd1+K5R+EUGvKB5BRFGRKpXB0AFrpfEXW0tn7gNHlxPTFQPAhrgzQAK5GFCtyGnhw==" crossorigin="anonymous" referrerpolicy="no-referrer">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3oD+sCoJrzXJ+yKiwusmDXjJh4moNgseTBMFPuOR/KSHhG5R0WgTkw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKnH4rJT6WPAzaBFIBeLs2UjgO3pV0EpKKxDnVXZEHWw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Firebase SDK -->
<script type="module">
// ★★★ 여기에 Firebase 설정값을 붙여넣으세요 ★★★
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, getDocs, getDocFromServer, getDocsFromServer, setDoc, deleteDoc, collection, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ⚠️  보안 안내: Firebase API 키는 클라이언트에 노출됩니다.
//    반드시 Firebase Console에서 아래 설정을 완료하세요:
//    1) Authentication → Sign-in method → [익명(Anonymous)] → 사용 설정 ✅ (필수!)
//    2) Firestore → Rules → 아래 규칙으로 교체 후 게시:
//       rules_version = '2';
//       service cloud.firestore {
//         match /databases/{database}/documents {
//           match /{document=**} {
//             allow read, write: if request.auth != null;
//           }
//         }
//       }
//    3) Google Cloud Console → API 제한 → 허용 도메인 설정
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const firebaseConfig = {
  apiKey: "AIzaSyCFFqFk55POE0wrUyLpbyywQrcDnUki0jE",
  authDomain: "mediworld-51f0f.firebaseapp.com",
  projectId: "mediworld-51f0f",
  storageBucket: "mediworld-51f0f.firebasestorage.app",
  messagingSenderId: "344675244828",
  appId: "1:344675244828:web:451af0cc5d9692e543b8d9"
};

const app = initializeApp(firebaseConfig);
const fsdb = getFirestore(app);

// ── Firestore DB 함수 (기존 IndexedDB 함수를 덮어씁니다) ──
window.fsdb = fsdb;
window.fsGet = async (col, id) => {
  // ★ 캐시 우회: 항상 서버에서 최신 데이터 읽기
  try {
    const snap = await getDocFromServer(doc(fsdb, col, String(id)));
    return snap.exists() ? snap.data() : undefined;
  } catch(e) {
    const snap = await getDoc(doc(fsdb, col, String(id)));
    return snap.exists() ? snap.data() : undefined;
  }
};
window.fsGetAll = async (col) => {
  // ★ 캐시 우회: 항상 서버에서 최신 데이터 읽기
  try {
    const snap = await getDocsFromServer(collection(fsdb, col));
    return snap.docs.map(d => d.data());
  } catch(e) {
    // 오프라인 fallback
    const snap = await getDocs(collection(fsdb, col));
    return snap.docs.map(d => d.data());
  }
};
window.fsPut = async (col, obj) => {
  const key = obj.id !== undefined ? String(obj.id) : String(obj.key);
  await setDoc(doc(fsdb, col, key), obj);
};
window.fsDelete = async (col, id) => {
  await deleteDoc(doc(fsdb, col, String(id)));
};
window.fsAdd = async (col, obj) => {
  if(obj.id !== undefined){
    await setDoc(doc(fsdb, col, String(obj.id)), { ...obj });
  } else {
    await addDoc(collection(fsdb, col), { ...obj, _ts: serverTimestamp() });
  }
};
window.fsGetIndex = async (col, field, val) => {
  const q = query(collection(fsdb, col), where(field, '==', val));
  const snap = await getDocs(q);
  return snap.docs.map(d => d.data());
};

// ★ Firebase Anonymous Auth - Firestore 권한 획득
const _fbAuth = getAuth(app);
window.firebaseReady = false;
signInAnonymously(_fbAuth)
  .then(() => {
    window.firebaseReady = true;
    console.log('[Firebase] 익명 인증 완료 ✅');
  })
  .catch((e) => {
    // Auth 실패해도 Rules가 public이면 동작하도록 fallback
    console.warn('[Firebase] 익명 인증 실패, Rules 확인 필요:', e.message);
    window.firebaseReady = true;
  });
console.log('[Firebase] 연결 완료 ✅');
</script>
<style>
:root{
  --bg:#07080d;--bg2:#0d0f1a;--bg3:#131629;
  --surface:rgba(255,255,255,0.03);--border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --gold:#d4a853;--gold2:#f0c974;--gold-dim:rgba(212,168,83,0.15);
  --green:#3dd68c;--green-dim:rgba(61,214,140,0.12);
  --red:#f05d5d;--red-dim:rgba(240,93,93,0.12);
  --blue:#5b8dee;--blue-dim:rgba(91,141,238,0.12);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,0.12);
  --text:#ffffff;--text2:#c8cfe0;--text3:#8a94ac;
  --r:16px;--r2:24px;--r3:32px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:17px;line-height:1.75;font-weight:500;}
body::before{content:'';position:fixed;inset:0;
  background-image:linear-gradient(rgba(212,168,83,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(212,168,83,0.025) 1px,transparent 1px);
  background-size:60px 60px;pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;top:-30vh;left:50%;transform:translateX(-50%);
  width:80vw;height:80vh;background:radial-gradient(ellipse,rgba(212,168,83,0.05) 0%,transparent 65%);
  pointer-events:none;z-index:0;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:10px;}
h1,h2,h3,.syne{font-family:'Syne',sans-serif;}
.mono{font-family:'Space Mono',monospace;}

/* ── LAYOUT ── */
#app{position:relative;z-index:1;}
.page{display:none;min-height:100vh;}
.page.active{display:block;}

/* TOPBAR */
#topbar{position:fixed;top:0;left:0;right:0;height:64px;background:rgba(7,8,13,0.93);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 28px;z-index:200;}
.topbar-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:20px;letter-spacing:2px;color:var(--gold);cursor:pointer;}
.topbar-logo span{color:var(--text2);font-weight:400;}
.topbar-nav{display:flex;gap:2px;}
.nav-btn{background:none;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;
  color:var(--text2);padding:8px 16px;border-radius:10px;transition:all .2s;letter-spacing:.3px;}
.nav-btn:hover{color:var(--text);background:var(--surface);}
.nav-btn.active{color:var(--gold);background:var(--gold-dim);}
.topbar-right{display:flex;align-items:center;gap:12px;}
.user-chip{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:40px;padding:5px 14px 5px 5px;}
.user-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--blue));
  display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#000;font-family:'Syne',sans-serif;}
.user-name{font-size:15px;font-weight:600;color:var(--text);}
.btn-logout{background:var(--red-dim);border:1px solid rgba(240,93,93,0.2);color:var(--red);font-size:14px;font-weight:700;
  padding:8px 16px;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;}
.btn-logout:hover{background:var(--red);color:#fff;}
.main{padding:88px 28px 48px;}

/* ── CARDS ── */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:24px;transition:border-color .2s;}
.card:hover{border-color:var(--border2);}
.card-sm{border-radius:var(--r);padding:18px;}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;}
.card-title-lg{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--text);}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:22px 24px;}
.stat-label{font-size:14px;font-weight:700;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px;}
.stat-value{font-family:'Space Mono',monospace;font-size:30px;font-weight:700;color:var(--text);line-height:1;}
.stat-sub{font-size:14px;color:var(--text2);margin-top:8px;font-weight:600;}
.stat-badge{display:inline-flex;align-items:center;gap:4px;font-size:15px;font-weight:700;padding:3px 9px;border-radius:20px;font-family:'Space Mono',monospace;}
.badge-up{background:var(--green-dim);color:var(--green);}
.badge-down{background:var(--red-dim);color:var(--red);}
.badge-gold{background:var(--gold-dim);color:var(--gold);}
.badge-blue{background:var(--blue-dim);color:var(--blue);}
.badge-purple{background:var(--purple-dim);color:var(--purple);}
.badge-pend{background:rgba(212,168,83,0.15);color:var(--gold);}
.card-gold{border-left:3px solid var(--gold);}
.card-green{border-left:3px solid var(--green);}
.card-blue{border-left:3px solid var(--blue);}
.card-red{border-left:3px solid var(--red);}
.card-purple{border-left:3px solid var(--purple);}

/* ── BUTTONS ── */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;cursor:pointer;
  font-family:'DM Sans',sans-serif;font-weight:700;font-size:16px;border-radius:var(--r);padding:14px 26px;transition:all .2s;letter-spacing:.3px;}
.btn:active{transform:scale(0.97);}
.btn-primary{background:var(--gold);color:#0a0800;}
.btn-primary:hover{background:var(--gold2);}
.btn-secondary{background:var(--surface);border:1px solid var(--border2);color:var(--text);}
.btn-secondary:hover{border-color:var(--border2);background:var(--bg3);}
.btn-success{background:var(--green-dim);border:1px solid rgba(61,214,140,0.25);color:var(--green);}
.btn-success:hover{background:var(--green);color:#000;}
.btn-danger{background:var(--red-dim);border:1px solid rgba(240,93,93,0.25);color:var(--red);}
.btn-warning{background:#e67e22;border-color:#d35400;color:#fff;}
.btn-danger:hover{background:var(--red);color:#fff;}
.btn-purple{background:var(--purple-dim);border:1px solid rgba(167,139,250,0.25);color:var(--purple);}
.btn-purple:hover{background:var(--purple);color:#fff;}
.btn-sm{padding:9px 18px;font-size:15px;border-radius:10px;font-weight:700;}
.btn-lg{padding:18px 36px;font-size:18px;border-radius:18px;}
.btn-full{width:100%;}
.btn-icon{padding:10px;border-radius:10px;width:42px;height:42px;}
.btn:disabled{opacity:0.4;cursor:not-allowed;}

/* ── FORMS ── */
.form-group{margin-bottom:20px;}
.form-label{display:block;font-size:16px;font-weight:700;color:var(--text);margin-bottom:9px;letter-spacing:.3px;}
.form-input{width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);
  padding:15px 18px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:17px;font-weight:500;outline:none;transition:all .2s;}
.form-input:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(212,168,83,0.15);}
.form-input::placeholder{color:var(--text3);}
.form-input.error{border-color:var(--red);}
.form-select{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%234a5068' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-hint{font-size:14px;color:var(--text3);margin-top:6px;}
.form-error{font-size:14px;color:var(--red);margin-top:6px;font-weight:600;}

/* ── TABLES ── */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead tr{border-bottom:1px solid var(--border);}
th{font-size:13px;font-weight:800;color:var(--text2);letter-spacing:.8px;text-transform:uppercase;padding:12px 16px;text-align:left;}
td{padding:15px 16px;font-size:16px;border-bottom:1px solid var(--border);color:var(--text);}
tr:hover td{background:var(--surface);}
tr:last-child td{border-bottom:none;}
.td-amount{font-family:'Space Mono',monospace;color:var(--text);font-weight:700;}

/* STATUS */
.status{display:inline-flex;align-items:center;gap:5px;font-size:15px;font-weight:700;letter-spacing:.5px;padding:4px 10px;border-radius:20px;text-transform:uppercase;}
.status::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.status-done{background:var(--green-dim);color:var(--green);}
.status-pend{background:var(--gold-dim);color:var(--gold);}
.status-fail{background:var(--red-dim);color:var(--red);}
.status-stop{background:rgba(74,80,104,0.3);color:var(--text3);}

/* ── TABS ── */
.tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:24px;overflow-x:auto;}
.tab{background:none;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;
  color:var(--text2);padding:12px 22px;border-bottom:2px solid transparent;letter-spacing:.2px;transition:all .2s;white-space:nowrap;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--gold);border-bottom-color:var(--gold);}

/* PROGRESS */
.progress-bar{height:6px;background:var(--bg3);border-radius:10px;overflow:hidden;}
.progress-fill{height:100%;border-radius:10px;transition:width .8s ease;}
.fill-gold{background:linear-gradient(90deg,var(--gold),var(--gold2));}
.fill-green{background:var(--green);}
.fill-blue{background:var(--blue);}
.fill-red{background:var(--red);}

/* ALERTS */
.alert{display:flex;align-items:flex-start;gap:10px;padding:14px 18px;border-radius:12px;font-size:16px;line-height:1.6;font-weight:500;}
.alert-info{background:var(--blue-dim);border:1px solid rgba(91,141,238,0.2);color:var(--blue);}
.alert-warning{background:var(--gold-dim);border:1px solid rgba(212,168,83,0.25);color:var(--gold);}
.alert-success{background:var(--green-dim);border:1px solid rgba(61,214,140,0.2);color:var(--green);}
.alert-danger{background:var(--red-dim);border:1px solid rgba(240,93,93,0.2);color:var(--red);}

/* GRID */
.dash-grid{display:grid;gap:20px;}
.dash-row-4{grid-template-columns:repeat(4,1fr);}
.dash-row-3{grid-template-columns:repeat(3,1fr);}
.dash-row-2{grid-template-columns:1fr 1fr;}
.dash-row-main{grid-template-columns:2fr 1fr;}
.page-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;}
.page-title{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;}
.page-title span{color:var(--gold);}
.page-subtitle{font-size:16px;color:var(--text2);margin-top:5px;font-weight:600;}

/* ROI RING */
.roi-ring-wrap{display:flex;align-items:center;gap:28px;}
.roi-ring{position:relative;width:110px;height:110px;flex-shrink:0;}
.roi-ring canvas{position:absolute;inset:0;}
.roi-ring-text{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.roi-pct{font-family:'Space Mono',monospace;font-size:20px;font-weight:700;color:var(--gold);}
.roi-label{font-size:9px;color:var(--text3);letter-spacing:.5px;text-transform:uppercase;margin-top:2px;}

/* TREE */
.tree-node{background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:12px 16px;min-width:150px;position:relative;}
.tree-node.self{border-color:var(--gold);background:var(--gold-dim);}
.tree-node.suspended{border-color:var(--red);opacity:0.6;}
.tree-node-name{font-size:16px;font-weight:700;color:var(--text);}
.tree-node-id{font-size:15px;color:var(--text3);font-family:'Space Mono',monospace;margin-top:2px;}
.tree-node-amount{font-family:'Space Mono',monospace;font-size:14px;color:var(--gold);margin-top:5px;}

/* NETWORK CARD */
.net-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:16px;display:flex;gap:14px;align-items:flex-start;}
.net-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dim),var(--blue-dim));
  display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:var(--gold);flex-shrink:0;}
.net-name{font-size:17px;font-weight:700;}
.net-id{font-size:14px;color:var(--text2);font-family:'Space Mono',monospace;margin-top:3px;font-weight:500;}
.net-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.net-meta-item{font-size:14px;color:var(--text3);background:var(--surface);border:1px solid var(--border);padding:3px 8px;border-radius:20px;}

/* STEP */
.step-indicator{display:flex;align-items:center;gap:0;margin-bottom:28px;}
.step-item{display:flex;align-items:center;gap:8px;flex:1;}
.step-circle{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--text3);flex-shrink:0;}
.step-item.active .step-circle{border-color:var(--gold);color:var(--gold);}
.step-item.done .step-circle{background:var(--gold);border-color:var(--gold);color:#000;}
.step-label{font-size:14px;color:var(--text3);font-weight:500;}
.step-item.active .step-label{color:var(--gold);}
.step-line{flex:1;height:1px;background:var(--border);margin:0 8px;}

/* COIN DOT */
.coin-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);
  animation:pulse 2s infinite;margin-right:4px;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
@keyframes spin{to{transform:rotate(360deg)}}

/* RANK BADGE */
.rank-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;font-size:14px;font-weight:700;letter-spacing:.3px;}
.rank-1{background:rgba(212,168,83,0.15);border:1px solid rgba(212,168,83,0.3);color:var(--gold);}
.rank-2{background:rgba(61,214,140,0.12);border:1px solid rgba(61,214,140,0.25);color:var(--green);}
.rank-3{background:rgba(91,141,238,0.12);border:1px solid rgba(91,141,238,0.25);color:var(--blue);}
.rank-4{background:rgba(167,139,250,0.12);border:1px solid rgba(167,139,250,0.25);color:var(--purple);}
.rank-5{background:rgba(240,93,93,0.12);border:1px solid rgba(240,93,93,0.25);color:var(--red);}
.rank-0{background:var(--surface);border:1px solid var(--border);color:var(--text3);}

/* TOAST */
#toast-container{position:fixed;bottom:28px;right:28px;display:flex;flex-direction:column;gap:10px;z-index:9999;}
.toast{display:flex;align-items:center;gap:12px;background:var(--bg3);border:1px solid var(--border);
  border-radius:14px;padding:14px 18px;font-size:15px;min-width:260px;max-width:360px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:slideIn .3s ease;}
@keyframes slideIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
@keyframes slideOut{from{opacity:1;}to{opacity:0;transform:translateX(20px);}}
.toast i{font-size:16px;flex-shrink:0;}
.toast-success{border-left:3px solid var(--green);}.toast-success i{color:var(--green);}
.toast-error{border-left:3px solid var(--red);}.toast-error i{color:var(--red);}
.toast-info{border-left:3px solid var(--blue);}.toast-info i{color:var(--blue);}
.toast-warning{border-left:3px solid var(--gold);}.toast-warning i{color:var(--gold);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.78);backdrop-filter:blur(6px);
  display:flex;align-items:center;justify-content:center;z-index:500;padding:20px;}
.modal-overlay.hidden{display:none;}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r3);padding:32px;
  min-width:340px;max-width:520px;width:100%;box-shadow:0 40px 80px rgba(0,0,0,0.6);}
.modal-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:10px;}
.modal-sub{font-size:15px;color:var(--text2);line-height:1.6;margin-bottom:24px;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;}
.modal-body-html{font-size:15px;color:var(--text2);line-height:1.7;margin-bottom:24px;}

/* LOGIN */
#page-login{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
.login-wrap{display:grid;grid-template-columns:1fr 1fr;max-width:920px;width:100%;
  background:var(--bg2);border:1px solid var(--border);border-radius:32px;overflow:hidden;
  box-shadow:0 40px 80px rgba(0,0,0,0.6);}
.login-left{background:var(--bg3);padding:60px 50px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden;}
.login-left::before{content:'';position:absolute;top:-50px;right:-50px;width:200px;height:200px;border:1px solid var(--border);border-radius:50%;opacity:.5;}
.login-left::after{content:'';position:absolute;bottom:-80px;left:-30px;width:250px;height:250px;border:1px solid var(--border);border-radius:50%;opacity:.3;}
.login-brand{position:relative;z-index:1;}
.login-brand-name{font-family:'Syne',sans-serif;font-weight:800;font-size:36px;color:var(--gold);letter-spacing:3px;}
.login-brand-sub{font-size:15px;color:var(--text2);letter-spacing:2px;margin-top:8px;text-transform:uppercase;font-weight:600;}
.login-stats{position:relative;z-index:1;display:grid;gap:14px;}
.login-stat{background:rgba(255,255,255,0.04);border:1px solid var(--border2);border-radius:14px;padding:18px 22px;}
.login-stat-label{font-size:15px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;font-weight:600;}
.login-stat-value{font-family:'Space Mono',monospace;font-size:22px;color:var(--gold);font-weight:700;}
.login-right{padding:60px 50px;}
.login-title{font-family:'Syne',sans-serif;font-size:27px;font-weight:800;margin-bottom:8px;color:var(--text);}
.login-sub{font-size:16px;color:var(--text2);margin-bottom:32px;font-weight:500;}
.login-tabs{display:flex;gap:0;margin-bottom:28px;background:var(--bg3);border-radius:12px;padding:4px;}
.login-tab{flex:1;background:none;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:16px;font-weight:700;
  color:var(--text2);padding:11px;border-radius:9px;transition:all .2s;}
.login-tab.active{background:var(--bg2);color:var(--gold);box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.login-form-section{display:none;}
.login-form-section.active{display:block;}
.divider{display:flex;align-items:center;gap:12px;font-size:14px;color:var(--text3);margin:16px 0;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:12px;color:var(--text3);}
.empty i{font-size:28px;opacity:.4;}
.empty p{font-size:15px;}

/* ADMIN OVERRIDE PANEL */
.override-panel{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);padding:18px;margin-bottom:16px;}
.override-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.override-row:last-child{margin-bottom:0;}
.override-label{font-size:14px;color:var(--text2);flex:1;font-weight:500;}
.override-input{width:90px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;
  padding:7px 10px;color:var(--text);font-family:'Space Mono',monospace;font-size:15px;text-align:right;outline:none;}
.override-input:focus{border-color:var(--gold);}
.override-unit{font-size:14px;color:var(--text3);width:24px;}

/* SUSPENDED BANNER */
.suspended-banner{background:var(--red-dim);border:1px solid rgba(240,93,93,0.3);border-radius:var(--r);
  padding:16px 20px;display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.suspended-banner i{color:var(--red);font-size:18px;}

/* RANK PROGRESS */
.rank-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);}
.rank-row:last-child{border-bottom:none;}

/* RESPONSIVE */
/* ── 노인/모바일 가독성 강화 ── */
body{font-size:16px;line-height:1.7;}
.nav-btn{font-size:14px !important;padding:8px 16px !important;}
.user-name{font-size:14px !important;font-weight:600 !important;}
.btn-logout{font-size:15px !important;}
.card-title{font-size:14px !important;}
.card-title-lg{font-size:19px !important;}
.stat-label{font-size:15px !important;font-weight:700 !important;}
.stat-value{font-size:28px !important;}
.stat-sub{font-size:15px !important;}
.btn{font-size:15px !important;padding:13px 24px !important;}
.btn-sm{font-size:14px !important;padding:9px 16px !important;border-radius:10px !important;}
.btn-lg{font-size:17px !important;padding:17px 34px !important;}
.form-label{font-size:14px !important;font-weight:700 !important;margin-bottom:8px !important;}
.form-input{font-size:16px !important;padding:13px 18px !important;}
.form-hint{font-size:14px !important;}
.tab{font-size:14px !important;padding:12px 20px !important;}
th{font-size:14px !important;padding:12px 16px !important;}
td{font-size:14px !important;padding:14px 16px !important;}
.status{font-size:14px !important;padding:5px 12px !important;}
.page-title{font-size:26px !important;}
.page-subtitle{font-size:14px !important;}
.tree-node-name{font-size:15px !important;}
.net-name{font-size:16px !important;}
.net-id{font-size:15px !important;}
.net-meta-item{font-size:15px !important;}
.alert{font-size:14px !important;padding:14px 18px !important;}
/* 텍스트 밝기 강화 */
--text:#f0f2fa;
--text2:#aab0c4;
--text3:#6b7280;

@media(max-width:900px){
  .login-wrap{grid-template-columns:1fr;}.login-left{display:none;}
  .dash-row-4{grid-template-columns:1fr 1fr;}.dash-row-3{grid-template-columns:1fr 1fr;}
  .dash-row-main{grid-template-columns:1fr;}
  .main{padding:80px 16px 40px;}
  #topbar{padding:0 14px;}
  .form-row{grid-template-columns:1fr;}
}
@media(max-width:600px){
  /* ── 모바일 최적화 (노인 친화) ── */
  .dash-row-4{grid-template-columns:1fr 1fr;}
  .dash-row-3{grid-template-columns:1fr 1fr;}
  .dash-row-2{grid-template-columns:1fr;}
  .topbar-nav{display:none;}
  .main{padding:72px 14px 48px !important;}
  #topbar{padding:0 14px !important;height:60px !important;}
  .topbar-logo{font-size:18px !important;}
  .user-name{display:none;}
  /* 페이지 제목 */
  .page-title{font-size:23px !important;}
  .page-subtitle{font-size:15px !important;}
  /* 카드 */
  .card{padding:18px !important;border-radius:16px !important;}
  .card-title-lg{font-size:18px !important;}
  .card-title{font-size:14px !important;}
  /* 통계 카드 */
  .stat-value{font-size:26px !important;}
  .stat-label{font-size:13px !important;}
  .stat-sub{font-size:13px !important;}
  /* 버튼 - 손가락으로 누르기 편하게 */
  .btn{font-size:15px !important;padding:13px 20px !important;min-height:48px !important;}
  .btn-sm{font-size:14px !important;padding:10px 15px !important;min-height:44px !important;}
  .btn-lg{font-size:17px !important;min-height:54px !important;}
  /* 탭 */
  .tabs{gap:0px;overflow-x:auto;}
  .tab{font-size:13px !important;padding:11px 14px !important;min-height:46px !important;}
  /* 테이블 */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
  th{font-size:12px !important;padding:10px 12px !important;}
  td{font-size:14px !important;padding:13px 12px !important;}
  /* 입력 폼 - 자동확대 방지 및 터치 편의 */
  .form-input{font-size:16px !important;padding:14px 16px !important;min-height:52px !important;}
  .form-label{font-size:15px !important;margin-bottom:8px !important;}
  /* 모달 */
  .modal{width:96% !important;max-width:100% !important;margin:8px !important;max-height:88vh !important;overflow-y:auto !important;border-radius:20px !important;}
  /* 알림 */
  .alert{font-size:15px !important;padding:14px 16px !important;}
  /* 상태 배지 */
  .status{font-size:12px !important;padding:5px 10px !important;}
  /* 폰트 자동크기 조절 방지 */
  *{-webkit-text-size-adjust:100% !important;}
  /* 네트워크 카드 */
  .net-name{font-size:16px !important;}
  .net-meta-item{font-size:13px !important;}
}
/* 터치 디바이스 버튼 크기 */
@media(hover:none) and (pointer:coarse){
  .btn{min-height:44px;}
  .btn-sm{min-height:40px;}
  .form-input{min-height:48px;}
  .tab{min-height:44px;}
  .nav-btn{min-height:44px;}
}
</style>
</head>
<body>
<div id="app">

<!-- ═══════════ LOGIN PAGE ═══════════ -->
<div id="page-login" class="page active" style="display:flex;">
  <div class="login-wrap">
    <div class="login-left">
      <div class="login-brand">
        <div class="login-brand-name">MEDI WORLD</div>
        <div class="login-brand-sub">Investment Platform v5.0</div>
        <div style="margin-top:20px;font-size:14px;color:var(--text3);line-height:1.8;">
          바이너리 구조 기반<br>스마트 투자 플랫폼
        </div>
      </div>
      <div class="login-stats">
        <div class="login-stat">
          <div class="login-stat-label">일일 ROI (주 5일)</div>
          <div class="login-stat-value">1.0%/일</div>
        </div>
        <div class="login-stat">
          <div class="login-stat-label">직추천 수당</div>
          <div class="login-stat-value">5.0%</div>
        </div>
        <div class="login-stat">
          <div class="login-stat-label">소실적 수당 (2대)</div>
          <div class="login-stat-value">3.0%</div>
        </div>
        <div class="login-stat">
          <div class="login-stat-label">최대 수익 한도</div>
          <div class="login-stat-value">300%</div>
        </div>
      </div>
    </div>
    <div class="login-right">
      <div class="login-title">안녕하세요</div>
      <div class="login-sub">계정에 로그인하거나 추천코드로 가입하세요</div>
      <div class="login-tabs">
        <button class="login-tab active" onclick="switchLoginTab('login',this)">로그인</button>
        <button class="login-tab" onclick="switchLoginTab('register',this)">회원가입</button>
      </div>

      <!-- LOGIN FORM -->
      <div id="lf-login" class="login-form-section active">
        <div class="form-group">
          <label class="form-label">아이디</label>
          <input class="form-input" id="inp-lid" placeholder="아이디 입력" autocomplete="username" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <div class="form-group">
          <label class="form-label">비밀번호</label>
          <input class="form-input" type="password" id="inp-lpwd" placeholder="비밀번호 입력" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="btn btn-primary btn-full btn-lg" onclick="doLogin()" style="margin-top:4px;">
          <i class="fas fa-sign-in-alt"></i> 로그인
        </button>

      </div>

      <!-- REGISTER FORM -->
      <div id="lf-register" class="login-form-section">
        <div class="alert alert-warning" style="margin-bottom:16px;">
          <i class="fas fa-key"></i>
          <div>누구나 가입할 수 있습니다. 가입 후 <b>관리자 승인</b>이 완료되면 서비스를 이용할 수 있습니다.<br>추천인 코드가 있으면 입력하세요 <span style="color:var(--text3);">(선택사항)</span></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">아이디 *</label>
            <input class="form-input" id="inp-rid" placeholder="영문+숫자, 4~20자">
          </div>
          <div class="form-group">
            <label class="form-label">이름 *</label>
            <input class="form-input" id="inp-rname" placeholder="실명 입력">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">비밀번호 *</label>
            <input class="form-input" type="password" id="inp-rpwd" placeholder="8자 이상">
          </div>
          <div class="form-group">
            <label class="form-label">비밀번호 확인 *</label>
            <input class="form-input" type="password" id="inp-rpwd2" placeholder="재입력">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">이메일</label>
            <input class="form-input" type="email" id="inp-remail" placeholder="example@email.com">
          </div>
          <div class="form-group">
            <label class="form-label">연락처</label>
            <input class="form-input" id="inp-rphone" placeholder="010-0000-0000">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">추천인 코드 <span style="color:var(--text3);font-size:14px;">(선택)</span></label>
          <input class="form-input" id="inp-rref" placeholder="추천인 아이디 입력 (없으면 비워두세요)">
          <div class="form-hint">추천인 코드가 없어도 가입할 수 있습니다</div>
        </div>
        <button class="btn btn-primary btn-full" style="margin-top:4px;" onclick="doRegister()">
          <i class="fas fa-user-plus"></i> 계정 만들기
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ TOPBAR ═══════════ -->
<nav id="topbar" style="display:none;">
  <div class="topbar-logo" onclick="goHome()">MEDI<span>WORLD</span></div>
  <div class="topbar-nav" id="topbar-nav"></div>
  <div class="topbar-right">
    <div class="user-chip">
      <div class="user-avatar" id="top-avatar"></div>
      <div class="user-name" id="top-name"></div>
    </div>
    <button class="btn-logout" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> 로그아웃</button>
  </div>
</nav>

<!-- ═══════════ DASHBOARD ═══════════ -->
<div id="page-dashboard" class="page">
  <div class="main">
    <div class="page-header">
      <div>
        <div class="page-title">대시보드 <span>—</span></div>
        <div class="page-subtitle">투자 현황 및 수익 요약</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="goView('invest')"><i class="fas fa-plus"></i> 투자 신청</button>
    </div>
    <div id="suspended-banner" style="display:none;" class="suspended-banner">
      <i class="fas fa-ban"></i>
      <div><b>계정이 정지되었습니다.</b> 관리자에게 문의하세요.</div>
    </div>
    <div class="dash-grid dash-row-4" style="margin-bottom:20px;" id="dash-kpi"></div>
    <div id="roi-timer-bar" style="display:flex;align-items:center;justify-content:space-between;
      background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--green);
      border-radius:var(--r);padding:12px 20px;margin-bottom:20px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="coin-dot"></span>
        <span style="font-size:14px;font-weight:600;color:var(--green);">자동 ROI 배당 가동 중</span>
        <span style="font-size:14px;color:var(--text3);">— 투자 승인 익일부터 월~금 주 5일 자정 지급</span>
      </div>
      <div id="next-roi-timer" style="font-family:'Space Mono',monospace;font-size:14px;color:var(--text2);"></div>
    </div>
    <div class="dash-grid dash-row-main" style="margin-bottom:20px;">
      <div class="card card-gold">
        <div class="card-header">
          <div class="card-title">수익 진행도</div>
          <span class="stat-badge badge-gold">300% 한도</span>
        </div>
        <div class="roi-ring-wrap">
          <div class="roi-ring">
            <canvas id="roi-ring-canvas"></canvas>
            <div class="roi-ring-text">
              <div class="roi-pct" id="roi-pct-text">0%</div>
              <div class="roi-label">달성</div>
            </div>
          </div>
          <div style="flex:1;">
            <div style="font-size:14px;color:var(--text3);margin-bottom:12px;">수익 정산 현황</div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div>
                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                  <span style="font-size:14px;color:var(--text2);">누적 배당</span>
                  <span class="mono" style="font-size:14px;color:var(--gold);" id="dash-roi-now">₩0</span>
                </div>
                <div class="progress-bar"><div class="progress-fill fill-gold" id="dash-roi-bar" style="width:0%"></div></div>
              </div>
              <div style="display:flex;justify-content:space-between;">
                <span style="font-size:14px;color:var(--text2);">목표 (300%)</span>
                <span class="mono" style="font-size:14px;color:var(--text3);" id="dash-roi-max">₩0</span>
              </div>
              <div style="display:flex;justify-content:space-between;">
                <span style="font-size:14px;color:var(--text2);">잔여 한도</span>
                <span class="mono" style="font-size:14px;color:var(--green);" id="dash-roi-remain">₩0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div class="card card-green">
          <div class="card-title" style="margin-bottom:14px;">출금 가능 잔액</div>
          <div class="mono" style="font-size:28px;color:var(--green);font-weight:700;" id="dash-wallet">₩0</div>
          <button class="btn btn-success btn-full btn-sm" style="margin-top:14px;" onclick="goView('wallet')">
            <i class="fas fa-paper-plane"></i> 출금 신청
          </button>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:12px;">오늘 예상 배당</div>
          <div class="mono" style="font-size:22px;color:var(--blue);font-weight:700;" id="dash-today">₩0</div>
          <div style="font-size:14px;color:var(--text3);margin-top:6px;"><span class="coin-dot"></span>주 5일 운영</div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:10px;">내 직급</div>
          <div id="dash-rank-badge"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title-lg">최근 거래 내역</div>
        <button class="btn btn-secondary btn-sm" onclick="goView('reports')">전체 보기</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>날짜</th><th>유형</th><th>금액</th><th>상태</th><th>설명</th></tr></thead>
          <tbody id="dash-tx-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ INVEST ═══════════ -->
<div id="page-invest" class="page">
  <div class="main">
    <div class="page-header">
      <div>
        <div class="page-title">투자 <span>신청</span></div>
        <div class="page-subtitle">원금을 투자하고 일일 수익을 시작하세요</div>
      </div>
    </div>
    <div class="dash-grid dash-row-2">
      <div class="card">
        <div class="card-title-lg" style="margin-bottom:24px;">신규 투자 신청</div>
        <div class="alert alert-warning" style="margin-bottom:16px;">
          <i class="fas fa-triangle-exclamation"></i>
          <div>최소 투자금액 <b>₩1,000,000</b> — 관리자 승인 후 익일부터 배당 시작</div>
        </div>
        <div class="form-group">
          <label class="form-label">투자 금액 (원)</label>
          <input class="form-input mono" id="inp-invest-amount" type="number" placeholder="1000000" min="1000000" step="100000" oninput="calcSim()">
          <div class="form-hint">₩1,000,000 이상</div>
        </div>
        <div class="form-group">
          <label class="form-label">입금자명</label>
          <input class="form-input" id="inp-invest-name" placeholder="실제 입금자명 입력">
        </div>
        <div class="form-group">
          <label class="form-label">메모 (선택)</label>
          <input class="form-input" id="inp-invest-memo" placeholder="특이사항 기재">
        </div>
        <div class="card" style="background:var(--bg3);margin-bottom:20px;padding:16px;">
          <div style="font-size:14px;color:var(--text3);margin-bottom:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">입금 계좌 정보</div>
          <div id="deposit-account-info" style="display:flex;flex-direction:column;gap:8px;font-size:15px;"></div>
        </div>
        <button class="btn btn-primary btn-full" onclick="submitInvestment()">
          <i class="fas fa-coins"></i> 투자 신청서 제출
        </button>
        <div class="alert alert-info" style="margin-top:14px;">
          <i class="fas fa-circle-info"></i>
          <div>신청 후 관리자 승인 시 익일부터 배당이 시작됩니다. 이미 투자 중인 경우 추가 투자됩니다.</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="card card-gold">
          <div class="card-title" style="margin-bottom:16px;">수익 구조</div>
          <div style="display:flex;flex-direction:column;gap:0;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
              <div><div style="font-size:15px;font-weight:600;">일일 ROI</div><div style="font-size:14px;color:var(--text3);">월~금 주 5일</div></div>
              <span class="stat-badge badge-gold">+1.0%/일</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
              <div><div style="font-size:15px;font-weight:600;">소실적 수당 (3%)</div><div style="font-size:14px;color:var(--text3);">2대 추천인 투자 승인 시 즉시</div></div>
              <span class="stat-badge badge-up">+5.0%</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
              <div><div style="font-size:15px;font-weight:600;">소실적 수당 (2대)</div><div style="font-size:14px;color:var(--text3);">2대 추천인에게 3%</div></div>
              <span class="stat-badge badge-blue">+3.0%</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
              <div><div style="font-size:15px;font-weight:600;">최대 수익 한도</div><div style="font-size:14px;color:var(--text3);">300% 도달 시 모든 수당 중단</div></div>
              <span class="stat-badge badge-gold">300%</span>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:14px;">수익 시뮬레이터</div>
          <div class="form-group">
            <label class="form-label">투자 예정 금액</label>
            <input class="form-input mono" id="sim-amount" type="number" placeholder="10000000" oninput="calcSimBox()">
          </div>
          <div id="sim-result" style="display:none;margin-top:4px;display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;justify-content:space-between;font-size:14px;"><span style="color:var(--text2);">일일 수익</span><b class="mono" id="sim-daily" style="color:var(--gold);">₩0</b></div>
            <div style="display:flex;justify-content:space-between;font-size:14px;"><span style="color:var(--text2);">월 수익 (22일)</span><b class="mono" id="sim-monthly">₩0</b></div>
            <div style="display:flex;justify-content:space-between;font-size:14px;"><span style="color:var(--text2);">최대 수익 (300%)</span><b class="mono" id="sim-max" style="color:var(--green);">₩0</b></div>
            <div style="display:flex;justify-content:space-between;font-size:14px;"><span style="color:var(--text2);">원금 회수 예상일</span><b class="mono" id="sim-days">약 0일</b></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:14px;">내 투자 현황</div>
          <div id="invest-current"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ NETWORK ═══════════ -->
<div id="page-network" class="page">
  <div class="main">
    <div class="page-header">
      <div><div class="page-title">조직 <span>관리</span></div><div class="page-subtitle">내 추천 네트워크 현황</div></div>
      <div id="my-invite-code" class="stat-badge badge-gold" style="font-size:14px;padding:8px 14px;cursor:pointer;" onclick="copyInvite()">
        <i class="fas fa-copy"></i> 초대코드 복사
      </div>
    </div>
    <div class="dash-grid dash-row-4" style="margin-bottom:20px;">
      <div class="stat-card card-blue"><div class="stat-label">직추천 수</div><div class="stat-value" id="net-direct-cnt">0</div><div class="stat-sub">명</div></div>
      <div class="stat-card card-gold"><div class="stat-label">L팀 총투자</div><div class="stat-value mono" id="net-left-pt">₩0</div></div>
      <div class="stat-card card-green"><div class="stat-label">R팀 총투자</div><div class="stat-value mono" id="net-right-pt">₩0</div></div>
      <div class="stat-card card-purple"><div class="stat-label">소라인 기준</div><div class="stat-value mono" id="net-small-line">₩0</div></div>
    </div>
    <div class="card" style="margin-bottom:20px;">
      <div class="card-header"><div class="card-title-lg">직급 현황</div></div>
      <div id="rank-progress-section"></div>
    </div>
    <div class="card" style="margin-bottom:20px;">
      <div class="card-header"><div class="card-title-lg">네트워크 트리</div></div>
      <div id="network-tree" style="overflow-x:auto;padding:20px 0;"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title-lg">하위 전체 목록</div></div>
      <div id="downline-list" style="display:flex;flex-direction:column;gap:10px;"></div>
    </div>
  </div>
</div>

<!-- ═══════════ WALLET ═══════════ -->
<div id="page-wallet" class="page">
  <div class="main">
    <div class="page-header">
      <div><div class="page-title">수익 <span>출금</span></div><div class="page-subtitle">수익금을 안전하게 출금하세요</div></div>
    </div>
    <div class="dash-grid dash-row-2">
      <div>
        <!-- STEP INDICATOR -->
        <div class="step-indicator">
          <div class="step-item" id="step1"><div class="step-circle">1</div><div class="step-label">금액 입력</div></div>
          <div class="step-line"></div>
          <div class="step-item" id="step2"><div class="step-circle">2</div><div class="step-label">계좌 확인</div></div>
          <div class="step-line"></div>
          <div class="step-item" id="step3"><div class="step-circle">3</div><div class="step-label">최종 확인</div></div>
        </div>
        <!-- STEP 1 -->
        <div id="wd-step1" class="card">
          <div class="card-title-lg" style="margin-bottom:20px;">출금 금액 입력</div>
          <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:20px;">
            <div style="font-size:14px;color:var(--text3);margin-bottom:6px;">출금 가능 잔액</div>
            <div class="mono" style="font-size:28px;font-weight:700;color:var(--green);" id="wd-balance">₩0</div>
          </div>
          <div class="form-group">
            <label class="form-label">출금 신청액 (원)</label>
            <input class="form-input mono" id="wd-amount" type="number" placeholder="출금 금액 입력" min="10000" oninput="calcWdFee()">
          </div>
          <div id="wd-fee-preview" style="display:none;background:var(--bg3);border-radius:var(--r);padding:16px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;font-size:15px;margin-bottom:8px;"><span style="color:var(--text2);">신청액</span><b class="mono" id="wd-fee-req">₩0</b></div>
            <div style="display:flex;justify-content:space-between;font-size:15px;margin-bottom:8px;"><span style="color:var(--text2);">수수료 (5%)</span><b class="mono" style="color:var(--red);" id="wd-fee-fee">-₩0</b></div>
            <div style="border-top:1px solid var(--border);padding-top:8px;display:flex;justify-content:space-between;font-size:14px;"><span>실수령 예상</span><b class="mono" style="color:var(--green);" id="wd-fee-net">₩0</b></div>
          </div>
          <button class="btn btn-primary btn-full" onclick="wdNextStep(2)"><i class="fas fa-arrow-right"></i> 다음</button>
        </div>
        <!-- STEP 2 -->
        <div id="wd-step2" class="card" style="display:none;">
          <div class="card-title-lg" style="margin-bottom:20px;">계좌 정보 확인</div>
          <div id="wd-bank-info" style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;"></div>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-secondary" onclick="showWdStep(1)"><i class="fas fa-arrow-left"></i> 이전</button>
            <button class="btn btn-primary btn-full" onclick="wdNextStep(3)">다음 <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>
        <!-- STEP 3 -->
        <div id="wd-step3" class="card" style="display:none;">
          <div class="card-title-lg" style="margin-bottom:20px;">최종 확인</div>
          <div id="wd-final-summary" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;"></div>
          <div class="alert alert-warning" style="margin-bottom:16px;">
            <i class="fas fa-triangle-exclamation"></i>
            <div>출금 신청 후 관리자 승인이 필요합니다. 영업일 1~2일 내 처리됩니다.</div>
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-secondary" onclick="showWdStep(2)"><i class="fas fa-arrow-left"></i> 이전</button>
            <button class="btn btn-success btn-full" onclick="submitWithdrawal()"><i class="fas fa-paper-plane"></i> 출금 신청 완료</button>
          </div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="card card-blue">
          <div class="card-title" style="margin-bottom:14px;">계좌 정보 등록</div>
          <div class="form-group">
            <label class="form-label">은행명</label>
            <input class="form-input" id="bank-name" placeholder="예) 국민은행">
          </div>
          <div class="form-group">
            <label class="form-label">예금주</label>
            <input class="form-input" id="bank-holder" placeholder="예금주명">
          </div>
          <div class="form-group">
            <label class="form-label">계좌번호</label>
            <input class="form-input mono" id="bank-account" placeholder="000-0000-0000000">
          </div>
          <button class="btn btn-secondary btn-full btn-sm" onclick="updateBank()"><i class="fas fa-save"></i> 저장</button>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title-lg">출금 내역</div></div>
          <div id="wd-history-list" style="display:flex;flex-direction:column;gap:8px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ REPORTS ═══════════ -->
<div id="page-reports" class="page">
  <div class="main">
    <div class="page-header">
      <div><div class="page-title">거래 <span>내역</span></div><div class="page-subtitle">모든 수익 및 거래 기록</div></div>
      <button class="btn btn-secondary btn-sm" onclick="exportReports()"><i class="fas fa-download"></i> CSV 다운로드</button>
    </div>
    <div class="dash-grid dash-row-3" style="margin-bottom:20px;" id="report-kpi"></div>
    <div class="card">
      <div id="report-tabs" class="tabs">
        <button class="tab active" onclick="filterReport('all',this)">전체</button>
        <button class="tab" onclick="filterReport('roi',this)">ROI 배당</button>
        <button class="tab" onclick="filterReport('bonus',this)">추천수당</button>
        <button class="tab" onclick="filterReport('binary',this)">바이너리</button>
        <button class="tab" onclick="filterReport('rank',this)">직급수당</button>
        <button class="tab" onclick="filterReport('withdrawal',this)">출금</button>
        <button class="tab" onclick="filterReport('invest',this)">투자</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>날짜</th><th>유형</th><th>내용</th><th>금액</th><th>수수료</th><th>실수령</th><th>상태</th></tr></thead>
          <tbody id="report-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ PROFILE ═══════════ -->
<div id="page-profile" class="page">
  <div class="main">
    <div class="page-header">
      <div><div class="page-title">내 <span>정보</span></div><div class="page-subtitle">계정 설정 및 보안</div></div>
    </div>
    <div class="dash-grid dash-row-2">
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="card">
          <div class="card-title-lg" style="margin-bottom:20px;">기본 정보</div>
          <div class="form-group"><label class="form-label">이름</label><input class="form-input" id="prof-name" placeholder="이름"></div>
          <div class="form-group"><label class="form-label">이메일</label><input class="form-input" type="email" id="prof-email" placeholder="이메일"></div>
          <div class="form-group"><label class="form-label">연락처</label><input class="form-input" id="prof-phone" placeholder="연락처"></div>
          <button class="btn btn-secondary btn-sm" onclick="saveProfile()"><i class="fas fa-save"></i> 저장</button>
        </div>
        <div class="card">
          <div class="card-title-lg" style="margin-bottom:20px;">비밀번호 변경</div>
          <div class="form-group"><label class="form-label">현재 비밀번호</label><input class="form-input" type="password" id="pw-current" placeholder="현재 비밀번호"></div>
          <div class="form-group"><label class="form-label">새 비밀번호</label><input class="form-input" type="password" id="pw-new" placeholder="8자 이상"></div>
          <div class="form-group"><label class="form-label">새 비밀번호 확인</label><input class="form-input" type="password" id="pw-confirm" placeholder="재입력"></div>
          <button class="btn btn-primary btn-sm" onclick="changePassword()"><i class="fas fa-lock"></i> 변경</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title-lg" style="margin-bottom:20px;">계정 정보</div>
        <div id="profile-info"></div>
        <div style="margin-top:20px;font-size:14px;color:var(--text3);">마지막 로그인: <span id="prof-last-login">-</span></div>
      </div>
    </div>
  </div>
</div>

<!-- ═══════════ ADMIN ═══════════ -->
<div id="page-admin_dash" class="page">
  <div class="main">
    <!-- ★ 보안 경고 배너 (초기 비밀번호 미변경 시 표시) -->
    <div id="admin-pwd-warn" style="display:none;align-items:center;gap:12px;padding:14px 20px;margin-bottom:20px;
      background:rgba(240,93,93,0.12);border:1px solid rgba(240,93,93,0.35);border-left:4px solid var(--red);
      border-radius:var(--r);">
      <i class="fas fa-shield-halved" style="color:var(--red);font-size:20px;flex-shrink:0;"></i>
      <div style="flex:1;">
        <div style="font-weight:800;color:var(--red);font-size:16px;">⚠️ 보안 경고: 초기 비밀번호를 즉시 변경하세요!</div>
        <div style="font-size:14px;color:var(--text2);margin-top:3px;">기본 비밀번호(admin123!)를 사용 중입니다. 해킹 위험이 있습니다. 아래 비밀번호 변경 탭에서 즉시 변경해 주세요.</div>
      </div>
    </div>
    <div class="page-header">
      <div><div class="page-title">관리자 <span>패널</span></div><div class="page-subtitle">전체 회원 및 시스템 관리</div></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-success btn-sm" onclick="runSettlement()"><i class="fas fa-bolt"></i> 전체 정산</button>
        <button class="btn btn-secondary btn-sm" onclick="exportReports()"><i class="fas fa-download"></i> 거래 CSV</button>
        <button class="btn btn-sm" onclick="exportMembersExcel()" style="background:var(--green);color:#000;font-weight:800;"><i class="fas fa-file-excel"></i> 회원 엑셀</button>
      </div>
    </div>

    <!-- KPI -->
    <div class="dash-grid dash-row-4" style="margin-bottom:20px;" id="admin-kpi"></div>

    <!-- 관리자 비밀번호 변경 -->
    <div class="card" style="margin-bottom:20px;" id="admin-pwd-section">
      <div class="card-header">
        <div class="card-title-lg">🔑 관리자 비밀번호 변경</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;align-items:end;">
        <div class="form-group" style="margin:0;">
          <label class="form-label">현재 비밀번호</label>
          <input class="form-input" type="password" id="admin-pw-current" placeholder="현재 비밀번호">
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">새 비밀번호 (8자 이상)</label>
          <input class="form-input" type="password" id="admin-pw-new" placeholder="새 비밀번호">
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">새 비밀번호 확인</label>
          <input class="form-input" type="password" id="admin-pw-confirm" placeholder="재입력">
        </div>
      </div>
      <button class="btn btn-primary btn-sm" style="margin-top:14px;" onclick="changeAdminPassword()">
        <i class="fas fa-lock"></i> 비밀번호 변경
      </button>
    </div>

    <!-- 수당 설정 패널 -->
    <div class="card" style="margin-bottom:20px;border-color:rgba(212,168,83,0.3);">
      <div class="card-header">
        <div class="card-title-lg">⚙️ 수당 비율 실시간 조정</div>
        <button class="btn btn-primary btn-sm" onclick="saveOverrides()"><i class="fas fa-save"></i> 저장 적용</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
        <div class="override-panel">
          <div style="font-size:14px;color:var(--text3);margin-bottom:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">ROI 배당</div>
          <div class="override-row"><div class="override-label">일일 ROI (%)</div><input class="override-input" id="ov-roi" type="number" step="0.1" min="0" max="10"><div class="override-unit">%</div></div>
        </div>
        <div class="override-panel">
          <div style="font-size:14px;color:var(--text3);margin-bottom:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">추천 수당</div>
          <div class="override-row"><div class="override-label">직추천 수당 (%)</div><input class="override-input" id="ov-direct" type="number" step="0.1" min="0" max="50"><div class="override-unit">%</div></div>
          <div class="override-row"><div class="override-label">소실적 2대 수당 (%)</div><input class="override-input" id="ov-binary" type="number" step="0.1" min="0" max="50"><div class="override-unit">%</div></div>
        </div>
        <div class="override-panel">
          <div style="font-size:14px;color:var(--text3);margin-bottom:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">기타 설정</div>
          <div class="override-row"><div class="override-label">최대 수익 한도 (%)</div><input class="override-input" id="ov-maxpayout" type="number" step="10" min="100" max="1000"><div class="override-unit">%</div></div>
          <div class="override-row"><div class="override-label">출금 수수료 (%)</div><input class="override-input" id="ov-wdfee" type="number" step="0.5" min="0" max="30"><div class="override-unit">%</div></div>
        </div>
      </div>
    </div>

    <!-- 입금 계좌 설정 -->
    <div class="card" style="margin-bottom:20px;">
      <div class="card-header">
        <div class="card-title-lg">🏦 입금 계좌 설정</div>
        <button class="btn btn-secondary btn-sm" onclick="saveDepositAccount()"><i class="fas fa-save"></i> 저장</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;">
        <div class="form-group" style="margin:0;"><label class="form-label">은행명</label><input class="form-input" id="admin-bank-name" placeholder="국민은행"></div>
        <div class="form-group" style="margin:0;"><label class="form-label">계좌번호</label><input class="form-input mono" id="admin-bank-account" placeholder="123-456-789012"></div>
        <div class="form-group" style="margin:0;"><label class="form-label">예금주</label><input class="form-input" id="admin-bank-holder" placeholder="예금주"></div>
      </div>
    </div>

    <!-- TABS -->
    <div id="admin-tabs" class="tabs">
      <button class="tab active" onclick="switchAdminTab('overview',this)">📊 개요</button>
      <button class="tab" onclick="switchAdminTab('approval',this)">✅ 가입승인 <span id="appr-badge" class="stat-badge badge-pend" style="margin-left:4px;"></span></button>
      <button class="tab" onclick="switchAdminTab('members',this)">👥 회원관리</button>
      <button class="tab" onclick="switchAdminTab('investments',this)">💰 투자승인 <span id="inv-badge" class="stat-badge badge-pend" style="margin-left:4px;"></span></button>
      <button class="tab" onclick="switchAdminTab('withdrawals',this)">🏧 출금승인 <span id="wd-badge" class="stat-badge badge-pend" style="margin-left:4px;"></span></button>
      <button class="tab" onclick="switchAdminTab('logs',this)">📋 거래로그</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div id="admin-tab-overview">
      <div class="dash-grid dash-row-2">
        <div class="card">
          <div class="card-header"><div class="card-title-lg">회원 투자 현황</div></div>
          <canvas id="admin-bar-chart" height="240"></canvas>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title-lg">직급별 현황</div></div>
          <div id="admin-rank-overview"></div>
        </div>
      </div>
    </div>

    <!-- MEMBERS TAB -->
    <!-- APPROVAL TAB -->
    <div id="admin-tab-approval" style="display:none;">
      <div class="card">
        <div class="card-header"><div class="card-title-lg">가입 승인 대기 회원</div></div>
        <div id="admin-approval-list"></div>
      </div>
    </div>

    <div id="admin-tab-members" style="display:none;">
      <div class="card">
        <div class="card-header">
          <div class="card-title-lg">회원 목록</div>
          <div style="display:flex;gap:8px;">
            <input class="form-input" id="member-search" placeholder="이름/아이디 검색" style="width:200px;padding:8px 12px;font-size:14px;" oninput="searchMembers()">
            <select class="form-input form-select" id="member-status-filter" style="width:120px;padding:8px 12px;font-size:14px;" onchange="searchMembers()">
              <option value="all">전체</option>
              <option value="active">투자중</option>
              <option value="inactive">미투자</option>
              <option value="suspended">정지</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>회원</th><th>추천인</th><th>투자금</th><th>누적ROI</th><th>잔액</th><th>직급</th><th>상태</th><th>관리</th></tr></thead>
            <tbody id="admin-member-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- INVESTMENTS TAB -->
    <div id="admin-tab-investments" style="display:none;">
      <div class="card">
        <div class="card-header"><div class="card-title-lg">투자 승인 대기</div></div>
        <div id="admin-invest-list"></div>
      </div>
    </div>

    <!-- WITHDRAWALS TAB -->
    <div id="admin-tab-withdrawals" style="display:none;">
      <div class="card">
        <div class="card-header"><div class="card-title-lg">출금 승인 대기</div></div>
        <div id="admin-wd-list"></div>
      </div>
    </div>

    <!-- LOGS TAB -->
    <div id="admin-tab-logs" style="display:none;">
      <div class="card">
        <div class="card-header" style="flex-wrap:wrap;gap:10px;">
          <div class="card-title-lg">📋 전체 거래내역 관리</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <input class="form-input" id="log-search" placeholder="회원ID / 내용 검색" style="width:155px;padding:8px 12px;font-size:14px;" oninput="searchLogs()">
            <select class="form-input form-select" id="log-type-filter" style="width:110px;padding:8px 12px;font-size:14px;" onchange="searchLogs()">
              <option value="all">전체유형</option>
              <option value="투자">투자</option>
              <option value="ROI">ROI</option>
              <option value="보너스">보너스</option>
              <option value="출금">출금</option>
              <option value="직급수당">직급수당</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="openAddTxModal('')" style="min-height:40px;white-space:nowrap;padding:0 16px;"><i class="fas fa-plus"></i> 거래 추가</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>날짜</th><th>회원</th><th>유형</th><th>금액</th><th>수수료</th><th>내용</th><th>상태</th><th style="min-width:120px;">관리</th></tr></thead>
            <tbody id="admin-log-body"></tbody>
          </table>
        </div>
        <div id="log-count" style="padding:8px 0 2px;font-size:13px;color:var(--text3);"></div>
      </div>
    </div>

  </div>
</div>

<!-- ★ 거래내역 수정/추가 모달 -->
<div id="modal-tx-edit" class="modal-overlay hidden" onclick="if(event.target===this)closeTxEdit()">
  <div class="modal" style="max-width:500px;width:96%;padding:28px;max-height:92vh;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;">
      <div id="tx-edit-title" style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--text);">거래내역 수정</div>
      <button class="btn btn-secondary btn-sm" onclick="closeTxEdit()"><i class="fas fa-times"></i></button>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="form-group" style="margin:0;">
        <label class="form-label">회원 ID *</label>
        <input class="form-input" id="tx-edit-userId" placeholder="회원 아이디">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group" style="margin:0;">
          <label class="form-label">유형 *</label>
          <select class="form-input form-select" id="tx-edit-type">
            <option value="투자">투자</option>
            <option value="ROI">ROI</option>
            <option value="보너스">보너스</option>
            <option value="출금">출금</option>
            <option value="직급수당">직급수당</option>
            <option value="기타">기타</option>
          </select>
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">날짜 *</label>
          <input class="form-input" id="tx-edit-date" type="date">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
        <div class="form-group" style="margin:0;">
          <label class="form-label">금액 (원)</label>
          <input class="form-input mono" id="tx-edit-amount" type="number" min="0" placeholder="0" oninput="txAutoNet()">
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">수수료 (원)</label>
          <input class="form-input mono" id="tx-edit-fee" type="number" min="0" placeholder="0" oninput="txAutoNet()">
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">실지급 (원)</label>
          <input class="form-input mono" id="tx-edit-net" type="number" min="0" placeholder="자동">
        </div>
      </div>
      <div class="form-group" style="margin:0;">
        <label class="form-label">내용 / 메모</label>
        <input class="form-input" id="tx-edit-desc" placeholder="거래 내용 입력">
      </div>
      <div class="form-group" style="margin:0;">
        <label class="form-label">상태</label>
        <select class="form-input form-select" id="tx-edit-status">
          <option value="completed">완료</option>
          <option value="pending">대기</option>
          <option value="cancelled">취소</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;">
      <button class="btn btn-primary" style="flex:1;min-height:48px;" onclick="saveTxEdit()"><i class="fas fa-save"></i> 저장</button>
      <button class="btn btn-secondary" style="min-height:48px;padding:0 20px;" onclick="closeTxEdit()">취소</button>
    </div>
    <input type="hidden" id="tx-edit-id">
  </div>
</div>

<!-- MEMBER DETAIL MODAL -->
<div id="modal-member-detail" class="modal-overlay hidden" onclick="if(event.target===this)closeMemberDetail()">
  <div class="modal" style="max-width:720px;width:96%;max-height:92vh;overflow-y:auto;padding:28px;">

    <!-- 헤더 -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;border-bottom:1px solid var(--border);padding-bottom:16px;">
      <div>
        <div id="mmd-title" style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--text);">회원 상세</div>
        <div id="mmd-subtitle" style="font-size:15px;color:var(--text2);margin-top:4px;"></div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="closeMemberDetail()"><i class="fas fa-times"></i> 닫기</button>
    </div>

    <!-- 탭 -->
    <div style="display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:20px;overflow-x:auto;">
      <button class="tab active" id="mmd-tab-info" onclick="switchMmdTab('info',this)">📋 기본정보</button>
      <button class="tab" id="mmd-tab-finance" onclick="switchMmdTab('finance',this)">💰 금융정보</button>
      <button class="tab" id="mmd-tab-tx" onclick="switchMmdTab('tx',this)">📄 거래내역</button>
      <button class="tab" id="mmd-tab-account" onclick="switchMmdTab('account',this)">🔐 계정관리</button>
    </div>

    <!-- 탭 내용 -->
    <div id="mmd-tab-info-body"><!-- 기본정보 --></div>
    <div id="mmd-tab-finance-body" style="display:none;"><!-- 금융정보 --></div>
    <div id="mmd-tab-tx-body" style="display:none;"><!-- 거래내역 --></div>
    <div id="mmd-tab-account-body" style="display:none;"><!-- 계정관리 --></div>

  </div>
</div>

</div><!-- /#app -->

<!-- TOAST -->
<div id="toast-container"></div>

<!-- 회원 상세 모달 -->
<div id="modal-member-detail" class="modal-overlay hidden" onclick="if(event.target===this)closeMemberDetail()">
  <div class="modal" style="max-width:520px;width:95%;max-height:85vh;overflow-y:auto;">
    <div class="modal-title" id="mmd-title">회원 상세</div>
    <div id="mmd-body" style="font-size:15px;color:var(--text2);line-height:1.7;margin-bottom:16px;"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-purple btn-sm" onclick="adminManualRoi()" id="mmd-roi-btn"><i class="fas fa-coins"></i> ROI 수동 지급</button>
      <button class="btn btn-success btn-sm" onclick="adminAddWallet()" id="mmd-wallet-btn"><i class="fas fa-plus"></i> 잔액 추가</button>
      <button class="btn btn-danger btn-sm" id="mmd-suspend-btn"><i class="fas fa-ban"></i> 계정 정지</button>
      <button class="btn btn-secondary btn-sm" onclick="closeMemberDetail()"><i class="fas fa-times"></i> 닫기</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div id="modal-confirm" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title" id="modal-title">확인</div>
    <div class="modal-sub" id="modal-body">계속하시겠습니까?</div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">취소</button>
      <button class="btn btn-primary" id="modal-confirm-btn" onclick="confirmModal()">확인</button>
    </div>
  </div>
</div>

<script>
'use strict';
// ═══════════════════════════════════════════════════════
//  보안 설정 — XSS 방지, CSRF 토큰
// ═══════════════════════════════════════════════════════
const _esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
let _sessionToken = null;
let _sessionStartTime = null;
const _SESSION_TIMEOUT_MS = 2 * 60 * 60 * 1000; // ★ 2시간 세션 만료
function _genToken(){ return Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function _validateSession(){
  if(!_sessionToken || !currentUser){ doLogout(); return false; }
  // ★ 세션 만료 체크 (2시간)
  if(_sessionStartTime && Date.now() - _sessionStartTime > _SESSION_TIMEOUT_MS){
    toast('세션이 만료되었습니다. 다시 로그인해주세요.','warning');
    doLogout(); return false;
  }
  return true;
}

// ═══════════════════════════════════════════════════════
//  DB — Firebase Firestore (클라우드 저장)
// ═══════════════════════════════════════════════════════
async function waitFirebase(timeout=8000){
  const start=Date.now();
  while(!window.firebaseReady){
    if(Date.now()-start>timeout) throw new Error('Firebase 연결 실패');
    await new Promise(r=>setTimeout(r,100));
  }
}
async function initDB(){ await waitFirebase(); console.log('[DB] Firebase 준비 완료'); }
const dbGet=(s,k)=>window.fsGet(s,k);
const dbGetAll=(s)=>window.fsGetAll(s);
const dbPut=(s,o)=>window.fsPut(s,o);
const dbDelete=(s,k)=>window.fsDelete(s,k);
const dbAdd=(s,o)=>window.fsAdd(s,o);
const dbGetIndex=(s,idx,val)=>window.fsGetIndex(s,idx,val);

async function audit(action, detail, userId=null){
  try{
    await dbAdd('auditLog',{ id:Date.now()+'_'+Math.random().toString(36).slice(2,7), ts:Date.now(), date:localDateStr(new Date()), action, detail, by:userId||(currentUser?currentUser.id:'system') });
  }catch(e){}
}

// ═══════════════════════════════════════════════════════
//  SETTINGS (수당 비율 - 관리자 조정 가능)
// ═══════════════════════════════════════════════════════
let CFG = {
  DAILY_ROI:    0.01,    // 1%
  DIRECT_BONUS: 0.05,    // 5%
  BINARY_BONUS: 0.03,    // 3%
  MAX_PAYOUT:   3.00,    // 300%
  WD_FEE:       0.05,    // 5%
  MIN_INVEST:   1000000,
  DEPOSIT_BANK: '국민은행',
  DEPOSIT_ACCOUNT: '123-456-789012',
  DEPOSIT_HOLDER: 'Medi World',
};
async function loadSettings(){
  try{
    const s=await dbGetAll('settings');
    s.forEach(item=>{ if(item && item.key && item.key in CFG) CFG[item.key]=item.value; });
  }catch(e){ console.warn('설정 로드 실패, 기본값 사용'); }
}
async function saveSetting(key,val){ await dbPut('settings',{id:key, key, value:val}); CFG[key]=val; }

// ═══════════════════════════════════════════════════════
//  직급 테이블 (소라인 기준 투자금)
// ═══════════════════════════════════════════════════════
const RANK_TABLE=[
  { rank:0, label:'일반', minSmall:0,         bonus:0,         class:'rank-0' },
  { rank:1, label:'브론즈', minSmall:30000000,   bonus:1000000,   class:'rank-1' },
  { rank:2, label:'실버',   minSmall:60000000,   bonus:2000000,   class:'rank-2' },
  { rank:3, label:'골드',   minSmall:120000000,  bonus:3000000,   class:'rank-3' },
  { rank:4, label:'플래티넘',minSmall:240000000,  bonus:6000000,   class:'rank-4' },
  { rank:5, label:'다이아',  minSmall:480000000,  bonus:12000000,  class:'rank-5' },
];

function calcRank(smallLineAmt){
  let r=RANK_TABLE[0];
  for(const rr of RANK_TABLE){ if(smallLineAmt>=rr.minSmall) r=rr; }
  return r;
}

// ═══════════════════════════════════════════════════════
//  SEED DATA
// ═══════════════════════════════════════════════════════
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
// ⚠️  보안 경고: 아래 초기 데이터는 최초 1회만 사용됩니다.
//    배포 후 즉시 관리자 페이지에서 비밀번호를 변경하세요!
//    기본 관리자 계정: admin / admin123!  ← 반드시 변경!
//    기본 테스트 계정: ydcho, userA, userB / pass1234! ← 실서비스에서 삭제!
// ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
const SEED_USERS=[
  {id:'admin',pwd:_hashPwd('admin123!'),role:'admin',name:'최고관리자',inviteCode:'SYSTEM-ROOT',sponsorCode:null,
   wallet:0,investment:0,roi:0,leftPoints:0,rightPoints:0,leftInvest:0,rightInvest:0,
   paidRanks:[],children:{left:null,right:null},email:'admin@mediworld.net',phone:'010-0000-0000',
   bankName:'',accountNumber:'',accountHolder:'',registeredAt:'2026-01-01',lastLogin:null,suspended:false,approvalStatus:'approved',
   _pwdChangedAt:null, _mustChangePwd:true},
  {id:'ydcho',pwd:_hashPwd('pass1234!'),role:'member',name:'조영덕',inviteCode:'ydcho',sponsorCode:'admin',
   wallet:5000000,investment:10000000,roi:1200000,leftPoints:50000000,rightPoints:20000000,
   leftInvest:50000000,rightInvest:20000000,
   paidRanks:[],children:{left:'userA',right:'userB'},email:'ydcho@medi.net',phone:'010-1234-5678',
   bankName:'국민은행',accountNumber:'110-123-456789',accountHolder:'조영덕',
   registeredAt:'2026-01-10',lastLogin:null,lastInvestmentDate:'2026-01-10',lastRoiDate:null,suspended:false,approvalStatus:'approved'},
  {id:'userA',pwd:_hashPwd('pass1234!'),role:'member',name:'파트너A',inviteCode:'userA',sponsorCode:'ydcho',
   wallet:1500000,investment:50000000,roi:500000,leftPoints:0,rightPoints:0,leftInvest:0,rightInvest:0,
   paidRanks:[],children:{left:null,right:null},email:'',phone:'',bankName:'',accountNumber:'',accountHolder:'',
   registeredAt:'2026-01-12',lastLogin:null,lastInvestmentDate:'2026-01-12',lastRoiDate:null,suspended:false,approvalStatus:'approved'},
  {id:'userB',pwd:_hashPwd('pass1234!'),role:'member',name:'파트너B',inviteCode:'userB',sponsorCode:'ydcho',
   wallet:800000,investment:20000000,roi:200000,leftPoints:0,rightPoints:0,leftInvest:0,rightInvest:0,
   paidRanks:[],children:{left:null,right:null},email:'',phone:'',bankName:'',accountNumber:'',accountHolder:'',
   registeredAt:'2026-01-15',lastLogin:null,lastInvestmentDate:'2026-01-15',lastRoiDate:null,suspended:false,approvalStatus:'approved'},
];
const SEED_TX=[
  {id:1001,userId:'ydcho',type:'투자',amount:10000000,fee:0,netAmount:10000000,date:'2026-01-10',status:'completed',desc:'최초 투자 승인'},
  {id:1002,userId:'ydcho',type:'ROI',amount:100000,fee:0,netAmount:100000,date:'2026-01-13',status:'completed',desc:'자동 ROI 1.0%'},
  {id:1003,userId:'ydcho',type:'보너스',amount:2500000,fee:0,netAmount:2500000,date:'2026-01-12',status:'completed',desc:'직추천 수당 (파트너A 5천만 투자 5%)'},
  {id:1004,userId:'userA',type:'투자',amount:50000000,fee:0,netAmount:50000000,date:'2026-01-12',status:'completed',desc:'투자 승인'},
];
async function seedIfEmpty(){
  try{
    const ex=await dbGetAll('users');
    if(ex.length===0){
      console.log('[Seed] Firebase에 초기 데이터 저장 중...');
      for(const u of SEED_USERS) await dbPut('users',u);
      for(const t of SEED_TX) await dbPut('transactions',t);
      console.log('[Seed] 초기 데이터 저장 완료 ✅');
    }
  }catch(e){ console.error('[Seed] 초기화 실패:', e); }
}

// ═══════════════════════════════════════════════════════
//  보안 — 비밀번호 해싱 (Web Crypto API SHA-256 + Salt)
// ═══════════════════════════════════════════════════════
// ⚠️ 동기 해시 → SHA-256 기반 강화 버전
// 실서비스 최고 보안 = Firebase Authentication 이전 권장
const _HASH_VER = 'MW5v2'; // 버전 태그 (구 해시와 구별)
const _APP_SALT = 'MediWorld2026!SecureSalt$#@'; // 앱 고정 솔트

// SHA-256 동기 대체 (Web Crypto는 비동기라 기존 코드와 호환 유지)
// + 기존 해시 하위호환 유지를 위해 두 함수 모두 보존
function _hashPwd(pw){
  // 구버전 해시 (기존 DB 데이터 호환용 — 신규 저장 시 _hashPwdV2 사용)
  let h=0;
  const s='MW5_SALT_'+pw+'_2026';
  for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  return 'mw5$'+Math.abs(h).toString(36)+'$'+btoa(pw.split('').reverse().join('')).replace(/=/g,'');
}
async function _hashPwdSecure(pw){
  // ★ 강화된 SHA-256 해시 (신규 비밀번호 저장 시 사용)
  const salt = _APP_SALT + pw.length;
  const msgBuffer = new TextEncoder().encode(salt + pw + _APP_SALT);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return _HASH_VER + '$' + hashHex;
}
async function _verifyPwdSecure(plain, hash){
  if(hash.startsWith(_HASH_VER)){
    // 신규 SHA-256 해시 검증
    const computed = await _hashPwdSecure(plain);
    return computed === hash;
  } else {
    // 구버전 해시 하위호환 (기존 회원 로그인 가능하도록)
    return _hashPwd(plain) === hash;
  }
}
function _verifyPwd(plain,hash){ return _hashPwd(plain)===hash; }
// 입력 검증
function _sanitizeId(v){ return /^[a-zA-Z0-9_]{4,20}$/.test(v); }
function _sanitizePwd(v){
  // ★ 강화된 비밀번호 정책: 8자 이상 + 숫자 포함
  if(v.length < 8) return false;
  if(!/[0-9]/.test(v)) return false; // 숫자 1개 이상 필수
  return true;
}

// ═══════════════════════════════════════════════════════
//  APP STATE
// ═══════════════════════════════════════════════════════
let currentUser=null, currentView='login', wdStep=1, wdAmountVal=0;
let adminCurrentTab='overview', modalCallback=null, reportFilter='all';
let roiRingChart=null, adminBarChart=null;
let _detailUserId=null;

// ═══════════════════════════════════════════════════════
//  UTILS
// ═══════════════════════════════════════════════════════
function fmt(n){ n=Math.round(n||0); if(Math.abs(n)>=100000000) return '₩'+(n/100000000).toFixed(2).replace(/\.?0+$/,'')+'억'; if(Math.abs(n)>=10000000) return '₩'+(n/10000000).toFixed(1).replace(/\.?0+$/,'')+'천만'; if(Math.abs(n)>=10000) return '₩'+(n/10000).toFixed(0)+'만'; return '₩'+n.toLocaleString(); }
function fmtFull(n){ return '₩'+(Math.round(n||0)).toLocaleString(); }
function localDateStr(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function isWeekday(d){ const w=d.getDay(); return w>=1&&w<=5; } // 월~금
function typeColor(t){ const m={ROI:'var(--gold)',보너스:'var(--green)',바이너리:'var(--blue)',직급수당:'var(--purple)',출금:'var(--red)',투자:'var(--text)'}; return m[t]||'var(--text2)'; }
function typeLabel(t){ const m={ROI:'ROI 배당',보너스:'추천수당',바이너리:'소실적수당',직급수당:'직급수당',출금:'출금',투자:'투자'}; return m[t]||t; }
function statusHtml(s){ const m={completed:'done',pending:'pend',rejected:'fail',suspended:'stop',cancelled:'fail'}; const l={completed:'완료',pending:'대기',rejected:'거부',suspended:'정지',cancelled:'취소'}; return `<span class="status status-${m[s]||'pend'}">${l[s]||s}</span>`; }

// ═══════════════════════════════════════════════════════
//  TOAST & MODAL
// ═══════════════════════════════════════════════════════
function toast(msg,type='info'){
  const icons={info:'fa-circle-info',success:'fa-circle-check',error:'fa-circle-xmark',warning:'fa-triangle-exclamation'};
  const el=document.createElement('div');
  el.className=`toast toast-${type}`;
  el.innerHTML=`<i class="fas ${icons[type]||icons.info}"></i><span>${_esc(msg)}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>{ el.style.animation='slideOut .3s ease forwards'; setTimeout(()=>el.remove(),300); },3500);
}
function showModal(title,body,cb,btnLabel='확인',btnClass='btn-primary'){
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-body').textContent=body;
  document.getElementById('modal-confirm-btn').className=`btn ${btnClass}`;
  document.getElementById('modal-confirm-btn').textContent=btnLabel;
  modalCallback=cb;
  document.getElementById('modal-confirm').classList.remove('hidden');
}
function closeModal(){ document.getElementById('modal-confirm').classList.add('hidden'); modalCallback=null; }
async function confirmModal(){
  const btn=document.getElementById('modal-confirm-btn');
  if(!modalCallback||btn.disabled)return;
  btn.disabled=true; btn.style.opacity='0.5';
  const origTxt=btn.textContent; btn.textContent='처리 중...';
  const cb=modalCallback;
  closeModal();
  try{ await cb(); }
  catch(e){ console.error('[confirmModal]',e); toast('처리 중 오류: '+e.message,'error'); }
  finally{ btn.disabled=false; btn.style.opacity=''; btn.textContent=origTxt; }
}

// ═══════════════════════════════════════════════════════
//  ROUTING
// ═══════════════════════════════════════════════════════
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='none';});
  const pg=document.getElementById('page-'+name);
  if(pg){pg.style.display='block';pg.classList.add('active');}
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(`.nav-btn[data-view="${name}"]`).forEach(b=>b.classList.add('active'));
  currentView=name; window.scrollTo(0,0);
}
function goView(name){ showPage(name); renderPage(name); }
function goHome(){ if(!currentUser)return; goView(currentUser.role==='admin'?'admin_dash':'dashboard'); }
function renderPage(name){
  if(name==='dashboard') renderDashboard();
  else if(name==='invest') renderInvest();
  else if(name==='network') renderNetwork();
  else if(name==='wallet') renderWallet();
  else if(name==='reports') renderReports();
  else if(name==='profile') renderProfile();
  else if(name==='admin_dash') renderAdmin();
}

// ═══════════════════════════════════════════════════════
//  AUTH
// ═══════════════════════════════════════════════════════
function switchLoginTab(tab,btn){
  document.querySelectorAll('.login-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.login-form-section').forEach(s=>s.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('lf-'+tab).classList.add('active');
}
async function doLogin(){
  const id=document.getElementById('inp-lid').value.trim();
  const pwd=document.getElementById('inp-lpwd').value;
  if(!id||!pwd){toast('아이디와 비밀번호를 입력하세요','error');return;}

  // ★ 강화된 브루트포스 방지 (sessionStorage 사용 — 새로고침해도 유지)
  const _attemptKey = 'mw_login_attempts';
  const _lockKey = 'mw_login_locktime';
  const lockUntil = parseInt(sessionStorage.getItem(_lockKey)||'0');
  if(Date.now() < lockUntil){
    const remain = Math.ceil((lockUntil - Date.now())/1000);
    toast(`⛔ 로그인이 잠겼습니다. ${remain}초 후 다시 시도하세요`,'error');
    return;
  }
  const attempts = parseInt(sessionStorage.getItem(_attemptKey)||'0');
  if(attempts >= 5){
    sessionStorage.setItem(_lockKey, String(Date.now() + 5*60*1000)); // 5분 잠금
    sessionStorage.setItem(_attemptKey, '0');
    toast('⛔ 로그인 시도 5회 초과. 5분간 잠깁니다','error');
    return;
  }

  const user=await dbGet('users',id);
  // ★ 보안: 존재하지 않는 ID도 동일한 에러 메시지 (ID 존재 여부 노출 방지)
  const pwdOk = user ? await _verifyPwdSecure(pwd, user.pwd) : false;
  if(!user||!pwdOk){
    const newAttempts = attempts + 1;
    sessionStorage.setItem(_attemptKey, String(newAttempts));
    const remain = 5 - newAttempts;
    toast(`아이디 또는 비밀번호가 틀립니다 (남은 시도: ${remain}회)`,'error');
    return;
  }
  // 로그인 성공 → 시도 횟수 초기화
  sessionStorage.removeItem(_attemptKey);
  sessionStorage.removeItem(_lockKey);

  if(user.suspended&&user.role!=='admin'){toast('계정이 정지되었습니다. 관리자에게 문의하세요','error');return;}
  if(user.approvalStatus==='pending'&&user.role!=='admin'){toast('⏳ 가입 승인 대기 중입니다. 관리자 승인 후 이용 가능합니다','error');return;}

  // ★ 최초 로그인 시 비밀번호 변경 강제 (관리자 계정)
  if(user._mustChangePwd && user.role==='admin'){
    await loginUser(user);
    toast('⚠️ 초기 비밀번호를 반드시 변경해주세요!','warning');
    setTimeout(()=>goView('admin_dash'),500);
    return;
  }
  await loginUser(user);
}
// ★ quickLogin 함수 보안상 제거됨 (자동 로그인 기능은 보안 위험)
async function loginUser(user){
  user.lastLogin=localDateStr(new Date());
  await dbPut('users',user);
  _sessionToken=_genToken();
  _sessionStartTime=Date.now(); // ★ 세션 시작 시간 기록
  currentUser=user;
  setupTopbar();
  document.getElementById('page-login').style.display='none';
  document.getElementById('page-login').classList.remove('active');
  document.getElementById('topbar').style.display='flex';
  goView(user.role==='admin'?'admin_dash':'dashboard');
  toast(`안녕하세요, ${_esc(user.name)}님!`,'success');
  await audit('LOGIN','로그인',user.id);
  setTimeout(()=>catchUpRoi(),800);
}
function doLogout(){
  currentUser=null; _sessionToken=null; _sessionStartTime=null;
  // ★ 로그아웃 시 로그인 시도 기록 초기화
  sessionStorage.removeItem('mw_login_attempts');
  sessionStorage.removeItem('mw_login_locktime');
  document.getElementById('topbar').style.display='none';
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='none';});
  document.getElementById('page-login').style.display='flex';
  document.getElementById('page-login').classList.add('active');
  document.getElementById('inp-lid').value=''; document.getElementById('inp-lpwd').value='';
}
async function doRegister(){
  const id=document.getElementById('inp-rid').value.trim();
  const name=document.getElementById('inp-rname').value.trim();
  const pwd=document.getElementById('inp-rpwd').value;
  const pwd2=document.getElementById('inp-rpwd2').value;
  const email=document.getElementById('inp-remail').value.trim();
  const phone=document.getElementById('inp-rphone').value.trim();
  const ref=document.getElementById('inp-rref').value.trim();
  // 보안 검증
  if(!id||!name||!pwd){toast('필수 항목을 모두 입력하세요','error');return;}
  if(!_sanitizeId(id)){toast('아이디는 영문/숫자 4~20자입니다','error');return;}
  if(!_sanitizePwd(pwd)){toast('비밀번호는 8자 이상, 숫자 포함이어야 합니다','error');return;}
  if(pwd!==pwd2){toast('비밀번호가 일치하지 않습니다','error');return;}
  // ★ 이름 길이 제한
  if(name.length > 30){toast('이름은 30자 이하로 입력하세요','error');return;}
  const existing=await dbGet('users',id);
  if(existing){toast('이미 사용 중인 아이디입니다','error');return;}
  // 추천인 코드 — 입력 시에만 유효성 검사 (선택사항)
  if(ref){
    const refUser=await dbGet('users',ref);
    if(!refUser||refUser.suspended){toast('유효하지 않은 추천인 코드입니다','error');return;}
  }
  // ★ 신규 가입 시 강화된 SHA-256 해시 사용
  const hashedPwd = await _hashPwdSecure(pwd);
  const newUser={
    id, pwd:hashedPwd, role:'member', name,
    inviteCode:id, sponsorCode:ref||'',
    wallet:0, investment:0, roi:0,
    leftPoints:0, rightPoints:0, leftInvest:0, rightInvest:0,
    paidRanks:[], children:{left:null,right:null},
    email, phone, bankName:'', accountNumber:'', accountHolder:'',
    registeredAt:localDateStr(new Date()), lastLogin:null, suspended:false,
    approvalStatus:'pending',
  };
  await dbPut('users',newUser);
  await audit('REGISTER',`신규 가입 (승인대기) 추천인:${ref||'없음'}`,id);
  toast('🎉 가입 신청 완료! 관리자 승인 후 로그인하실 수 있습니다','success');
  document.querySelectorAll('.login-tab').forEach((t,i)=>{t.classList.remove('active');if(i===0)t.classList.add('active');});
  document.querySelectorAll('.login-form-section').forEach((s,i)=>{s.classList.remove('active');if(i===0)s.classList.add('active');});
  document.getElementById('inp-lid').value=id;
}
function setupTopbar(){
  document.getElementById('top-avatar').textContent=currentUser.name.charAt(0);
  document.getElementById('top-name').textContent=currentUser.name+' ('+currentUser.id+')';
  const nav=document.getElementById('topbar-nav'); nav.innerHTML='';
  const views=currentUser.role==='admin'
    ?[{id:'admin_dash',label:'관리자홈'}]
    :[{id:'dashboard',label:'대시보드'},{id:'invest',label:'투자하기'},{id:'network',label:'조직관리'},{id:'wallet',label:'수익출금'},{id:'reports',label:'거래내역'},{id:'profile',label:'내정보'}];
  views.forEach(v=>{
    const b=document.createElement('button');
    b.className='nav-btn'; b.dataset.view=v.id; b.textContent=v.label;
    b.onclick=()=>goView(v.id); nav.appendChild(b);
  });
}

// ═══════════════════════════════════════════════════════
//  DASHBOARD
// ═══════════════════════════════════════════════════════
async function renderDashboard(){
  const u=await dbGet('users',currentUser.id); currentUser=u;
  const susp=u.suspended;
  document.getElementById('suspended-banner').style.display=susp?'flex':'none';
  const max=u.investment*CFG.MAX_PAYOUT;
  const roiPct=max>0?Math.min(100,(u.roi/max*100)):0;
  const daily=susp?0:Math.round(u.investment*CFG.DAILY_ROI);
  document.getElementById('dash-kpi').innerHTML=`
    <div class="stat-card card-gold"><div class="stat-label">총 투자금</div><div class="stat-value">${fmt(u.investment)}</div><div class="stat-sub">원금</div></div>
    <div class="stat-card card-green"><div class="stat-label">누적 ROI</div><div class="stat-value">${fmt(u.roi)}</div><div class="stat-sub">${roiPct.toFixed(1)}% 달성</div></div>
    <div class="stat-card card-blue"><div class="stat-label">출금 잔액</div><div class="stat-value">${fmt(u.wallet)}</div></div>
    <div class="stat-card"><div class="stat-label">일일 배당</div><div class="stat-value">${fmt(daily)}</div><div class="stat-sub">주 5일 지급</div></div>
  `;
  document.getElementById('dash-wallet').textContent=fmtFull(u.wallet);
  document.getElementById('dash-today').textContent=fmtFull(daily);
  document.getElementById('dash-roi-now').textContent=fmtFull(u.roi);
  document.getElementById('dash-roi-max').textContent=fmtFull(max);
  document.getElementById('dash-roi-remain').textContent=fmtFull(Math.max(0,max-u.roi));
  document.getElementById('dash-roi-bar').style.width=roiPct+'%';
  document.getElementById('roi-pct-text').textContent=roiPct.toFixed(1)+'%';
  // 직급
  const smallLine=Math.min(u.leftInvest||0,u.rightInvest||0);
  const rank=calcRank(smallLine);
  document.getElementById('dash-rank-badge').innerHTML=`<div class="rank-badge ${rank.class}"><i class="fas fa-star"></i>${rank.label}</div><div style="font-size:14px;color:var(--text3);margin-top:6px;">소라인: ${fmt(smallLine)}</div>`;
  // ROI ring
  if(roiRingChart){ roiRingChart.destroy(); roiRingChart=null; }
  const ctx=document.getElementById('roi-ring-canvas').getContext('2d');
  roiRingChart=new Chart(ctx,{type:'doughnut',data:{datasets:[{data:[roiPct,100-roiPct],backgroundColor:['rgba(212,168,83,0.9)','rgba(255,255,255,0.05)'],borderWidth:0,circumference:360}]},options:{cutout:'78%',plugins:{legend:{display:false},tooltip:{enabled:false}},animation:{duration:800}}});
  // TX
  const allTx=await dbGetAll('transactions');
  const myTx=allTx.filter(t=>t.userId===u.id).sort((a,b)=>b.id-a.id).slice(0,8);
  const tbody=document.getElementById('dash-tx-body');
  tbody.innerHTML=myTx.length===0?'<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text3);">거래 내역이 없습니다</td></tr>':myTx.map(t=>`<tr><td style="color:var(--text3);font-size:14px;">${t.date}</td><td><span style="color:${typeColor(t.type)};font-size:14px;font-weight:600;">${typeLabel(t.type)}</span></td><td class="td-amount">${fmt(t.amount)}</td><td>${statusHtml(t.status)}</td><td style="font-size:14px;color:var(--text3);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${_esc(t.desc||'')}</td></tr>`).join('');
}

// ═══════════════════════════════════════════════════════
//  INVEST
// ═══════════════════════════════════════════════════════
async function renderInvest(){
  const u=await dbGet('users',currentUser.id);
  // 입금 계좌 표시
  document.getElementById('deposit-account-info').innerHTML=`
    <div style="display:flex;justify-content:space-between;"><span style="color:var(--text2);">은행</span><b>${_esc(CFG.DEPOSIT_BANK)}</b></div>
    <div style="display:flex;justify-content:space-between;"><span style="color:var(--text2);">계좌번호</span><b class="mono">${_esc(CFG.DEPOSIT_ACCOUNT)}</b></div>
    <div style="display:flex;justify-content:space-between;"><span style="color:var(--text2);">예금주</span><b>${_esc(CFG.DEPOSIT_HOLDER)}</b></div>
  `;
  const max=u.investment*CFG.MAX_PAYOUT;
  document.getElementById('invest-current').innerHTML=u.investment>0?`
    <div style="display:flex;justify-content:space-between;font-size:15px;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="color:var(--text2);">현재 투자금</span><b class="mono" style="color:var(--gold);">${fmtFull(u.investment)}</b>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:15px;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="color:var(--text2);">일일 배당</span><b class="mono" style="color:var(--gold);">${fmtFull(Math.round(u.investment*CFG.DAILY_ROI))}</b>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:15px;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="color:var(--text2);">누적 ROI</span><b class="mono">${fmtFull(u.roi)}</b>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:15px;padding:10px 0;">
      <span style="color:var(--text2);">잔여 한도</span><b class="mono" style="color:var(--green);">${fmtFull(Math.max(0,max-u.roi))}</b>
    </div>
    <div class="progress-bar" style="margin-top:10px;"><div class="progress-fill fill-gold" style="width:${Math.min(100,u.roi/max*100)}%"></div></div>
    <div style="font-size:15px;color:var(--text3);margin-top:5px;text-align:right;">${(u.roi/max*100).toFixed(1)}% / 300%</div>
  `:'<div class="empty"><i class="fas fa-chart-line"></i><p>투자를 시작하세요</p></div>';
}
function calcSim(){
  const amt=parseInt(document.getElementById('inp-invest-amount').value)||0;
  const sim=document.getElementById('sim-result');
  if(amt<CFG.MIN_INVEST){sim.style.display='none';return;}
  sim.style.display='flex';
  const daily=Math.round(amt*CFG.DAILY_ROI);
  document.getElementById('sim-daily').textContent=fmt(daily);
  document.getElementById('sim-monthly').textContent=fmt(daily*22);
  document.getElementById('sim-max').textContent=fmt(amt*CFG.MAX_PAYOUT);
  document.getElementById('sim-days').textContent=`약 ${Math.ceil(amt/daily)}일`;
}
function calcSimBox(){ const a=parseInt(document.getElementById('sim-amount').value)||0; const sim=document.getElementById('sim-result'); if(a<CFG.MIN_INVEST){sim.style.display='none';return;} sim.style.display='flex'; const d=Math.round(a*CFG.DAILY_ROI); document.getElementById('sim-daily').textContent=fmt(d); document.getElementById('sim-monthly').textContent=fmt(d*22); document.getElementById('sim-max').textContent=fmt(a*CFG.MAX_PAYOUT); document.getElementById('sim-days').textContent=`약 ${Math.ceil(a/d)}일`; }
async function submitInvestment(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  if(u.suspended){toast('계정이 정지되어 투자할 수 없습니다','error');return;}
  const amt=parseInt(document.getElementById('inp-invest-amount').value)||0;
  const iname=document.getElementById('inp-invest-name').value.trim();
  if(amt<CFG.MIN_INVEST){toast(`최소 투자금액은 ${fmt(CFG.MIN_INVEST)}입니다`,'error');return;}
  if(!iname){toast('입금자명을 입력하세요','error');return;}

  // ★ 이미 대기 중인 신청이 있으면 차단
  const allPend=await dbGetAll('pendingInvestments');
  if(allPend.some(p=>p.userId===currentUser.id)){
    toast('이미 대기 중인 투자 신청이 있습니다.\n관리자 승인 후 다시 신청해 주세요.','error');
    return;
  }

  const inv={id:Date.now(),userId:currentUser.id,userName:currentUser.name,amount:amt,depositorName:_esc(iname),memo:_esc(document.getElementById('inp-invest-memo').value.trim()),requestedAt:localDateStr(new Date()),status:'pending'};
  await dbPut('pendingInvestments',inv);
  await audit('INVEST_REQUEST',`투자신청 ${fmt(amt)}`,currentUser.id);
  document.getElementById('inp-invest-amount').value='';
  document.getElementById('inp-invest-name').value='';
  document.getElementById('inp-invest-memo').value='';
  toast('투자 신청이 접수되었습니다. 관리자 승인 후 배당이 시작됩니다','success');
}

// ═══════════════════════════════════════════════════════
//  NETWORK
// ═══════════════════════════════════════════════════════
async function renderNetwork(){
  const u=await dbGet('users',currentUser.id); currentUser=u;
  const allUsers=await dbGetAll('users');
  // 하위 전체 집계
  function getDownlineIds(uid,acc=[]){
    const ur=allUsers.find(x=>x.id===uid); if(!ur)return acc;
    const directs=allUsers.filter(x=>x.sponsorCode===uid&&x.role==='member');
    directs.forEach(d=>{ acc.push(d.id); getDownlineIds(d.id,acc); });
    return acc;
  }
  const downlineAll=allUsers.filter(x=>x.sponsorCode===u.id&&x.role==='member');
  const smallLine=Math.min(u.leftInvest||0,u.rightInvest||0);
  document.getElementById('net-direct-cnt').textContent=downlineAll.length;
  document.getElementById('net-left-pt').textContent=fmt(u.leftInvest||0);
  document.getElementById('net-right-pt').textContent=fmt(u.rightInvest||0);
  document.getElementById('net-small-line').textContent=fmt(smallLine);
  document.getElementById('my-invite-code').innerHTML=`<i class="fas fa-copy"></i> ${_esc(u.inviteCode)}`;
  // 직급 진행
  const rank=calcRank(smallLine);
  const nextRank=RANK_TABLE[rank.rank+1];
  const rankHtml=RANK_TABLE.slice(1).map(r=>{
    const achieved=smallLine>=r.minSmall;
    const isPaid=(u.paidRanks||[]).includes(r.rank);
    return `<div class="rank-row">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="rank-badge ${r.class}"><i class="fas fa-star"></i>${r.label}</div>
        <div style="font-size:14px;color:var(--text2);">소라인 ${fmt(r.minSmall)}</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:15px;font-weight:700;color:var(--gold);">${fmt(r.bonus)}</div>
        ${achieved?(isPaid?'<span class="stat-badge badge-up"><i class="fas fa-check"></i>지급완료</span>':'<span class="stat-badge badge-pend">지급대기</span>'):('<div style="flex:1;max-width:160px;"><div class="progress-bar"><div class="progress-fill fill-gold" style="width:'+Math.min(100,smallLine/r.minSmall*100).toFixed(1)+'%"></div></div><div style="font-size:15px;color:var(--text3);margin-top:3px;">'+fmt(Math.max(0,r.minSmall-smallLine))+' 더 필요</div></div>')}
      </div>
    </div>`;
  }).join('');
  document.getElementById('rank-progress-section').innerHTML=rankHtml;
  // 트리
  const userMap={}; allUsers.forEach(x=>userMap[x.id]=x);
  renderTreeNode(u,userMap);
  // 하위 목록
  const dl=document.getElementById('downline-list');
  if(downlineAll.length===0){ dl.innerHTML='<div class="empty"><i class="fas fa-network-wired"></i><p>직추천 회원이 없습니다</p></div>'; }
  else{ dl.innerHTML=downlineAll.map(d=>`
    <div class="net-card">
      <div class="net-avatar">${d.name.charAt(0)}</div>
      <div style="flex:1;">
        <div class="net-name">${_esc(d.name)} ${d.suspended?'<span class="stat-badge badge-down">정지</span>':''}</div>
        <div class="net-id">${_esc(d.id)}</div>
        <div class="net-meta">
          <div class="net-meta-item">투자: <b>${fmt(d.investment)}</b></div>
          <div class="net-meta-item">가입: <b>${d.registeredAt}</b></div>
          <div class="net-meta-item">잔액: <b>${fmt(d.wallet)}</b></div>
        </div>
      </div>
    </div>`).join(''); }
}
function renderTreeNode(u,userMap){
  const tree=document.getElementById('network-tree');
  const build=(uid,depth)=>{
    if(!uid||depth>4)return'';
    const user=userMap[uid]; if(!user)return'';
    const isSelf=uid===currentUser.id;
    const left=build(user.children?.left,depth+1);
    const right=build(user.children?.right,depth+1);
    const hasC=left||right;
    return `<div style="display:flex;flex-direction:column;align-items:center;">
      <div class="tree-node${isSelf?' self':''}${user.suspended?' suspended':''}">
        <div class="tree-node-name">${_esc(user.name)}</div>
        <div class="tree-node-id">${_esc(user.id)}</div>
        ${user.investment>0?`<div class="tree-node-amount">${fmt(user.investment)}</div>`:''}
      </div>
      ${hasC?`<div style="width:1px;height:20px;background:var(--border);"></div>
        <div style="display:flex;align-items:flex-start;gap:32px;">
          ${left?`<div style="display:flex;flex-direction:column;align-items:center;"><div style="height:20px;width:1px;background:var(--border);"></div>${left}</div>`:''}
          ${right?`<div style="display:flex;flex-direction:column;align-items:center;"><div style="height:20px;width:1px;background:var(--border);"></div>${right}</div>`:''}
        </div>`:''}
    </div>`;
  };
  tree.innerHTML=`<div style="display:flex;justify-content:center;">${build(u.id,0)}</div>`;
}
function copyInvite(){ navigator.clipboard.writeText(currentUser.inviteCode).then(()=>toast('초대 코드가 복사되었습니다: '+currentUser.inviteCode,'success')); }

// ═══════════════════════════════════════════════════════
//  WALLET
// ═══════════════════════════════════════════════════════
async function renderWallet(){
  const u=await dbGet('users',currentUser.id); currentUser=u;
  wdStep=1; showWdStep(1);
  document.getElementById('wd-balance').textContent=fmtFull(u.wallet);
  document.getElementById('bank-name').value=u.bankName||'';
  document.getElementById('bank-holder').value=u.accountHolder||'';
  document.getElementById('bank-account').value=u.accountNumber||'';
  const allTx=await dbGetAll('transactions');
  const wdTx=allTx.filter(t=>t.userId===u.id&&t.type==='출금').sort((a,b)=>b.id-a.id);
  const pendingWd=await dbGetAll('pendingWithdrawals');
  const myPend=pendingWd.filter(w=>w.userId===u.id);
  const all=[...myPend.map(w=>({...w,status:'pending'})),...wdTx];
  const wdList=document.getElementById('wd-history-list');
  if(all.length===0){ wdList.innerHTML='<div class="empty"><i class="fas fa-inbox"></i><p>출금 내역이 없습니다</p></div>'; }
  else{ wdList.innerHTML=all.slice(0,10).map(w=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--border);">
      <div><div style="font-size:15px;font-weight:600;" class="mono">${fmtFull(w.amount)}</div>
        <div style="font-size:14px;color:var(--text3);margin-top:2px;">${w.requestedAt||w.date} · 수수료 ${fmt(w.fee||0)}</div></div>
      <div style="text-align:right;">${statusHtml(w.status)}
        ${w.status==='completed'?`<div class="mono" style="font-size:14px;color:var(--green);margin-top:4px;">실수령 ${fmt(w.netAmount||w.net)}</div>`:''}
      </div>
    </div>`).join(''); }
}
function calcWdFee(){
  const amt=parseInt(document.getElementById('wd-amount').value)||0;
  const prev=document.getElementById('wd-fee-preview');
  if(amt<=0){prev.style.display='none';return;}
  const fee=Math.floor(amt*CFG.WD_FEE);
  document.getElementById('wd-fee-req').textContent=fmtFull(amt);
  document.getElementById('wd-fee-fee').textContent='-'+fmtFull(fee);
  document.getElementById('wd-fee-net').textContent=fmtFull(amt-fee);
  prev.style.display='block';
}
function showWdStep(n){
  for(let i=1;i<=3;i++){
    document.getElementById('wd-step'+i).style.display=i===n?'block':'none';
    const s=document.getElementById('step'+i); s.classList.remove('active','done');
    if(i<n) s.classList.add('done'); else if(i===n) s.classList.add('active');
  }
  wdStep=n;
}
async function wdNextStep(n){
  if(n===2){
    wdAmountVal=parseInt(document.getElementById('wd-amount').value)||0;
    const u=await dbGet('users',currentUser.id);
    if(wdAmountVal<=0){toast('출금 금액을 입력하세요','error');return;}
    if(wdAmountVal>u.wallet){toast('잔액이 부족합니다','error');return;}
    if(!u.bankName||!u.accountNumber){toast('먼저 계좌 정보를 등록하세요','error');return;}
    document.getElementById('wd-bank-info').innerHTML=`
      <div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:10px;font-size:15px;"><span style="color:var(--text2);">은행</span><b>${_esc(u.bankName)}</b></div>
      <div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:10px;font-size:15px;"><span style="color:var(--text2);">계좌번호</span><b class="mono">${_esc(u.accountNumber)}</b></div>
      <div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:10px;font-size:15px;"><span style="color:var(--text2);">예금주</span><b>${_esc(u.accountHolder)}</b></div>
    `;
  }
  if(n===3){
    const fee=Math.floor(wdAmountVal*CFG.WD_FEE);
    document.getElementById('wd-final-summary').innerHTML=`
      <div style="display:flex;justify-content:space-between;font-size:15px;"><span style="color:var(--text2);">출금 신청액</span><b class="mono">${fmtFull(wdAmountVal)}</b></div>
      <div style="display:flex;justify-content:space-between;font-size:15px;"><span style="color:var(--text2);">수수료 (${(CFG.WD_FEE*100).toFixed(1)}%)</span><b class="mono" style="color:var(--red);">-${fmtFull(fee)}</b></div>
      <div style="border-top:1px solid var(--border);padding-top:10px;display:flex;justify-content:space-between;font-size:14px;"><span>실수령 예상액</span><b class="mono" style="color:var(--green);">${fmtFull(wdAmountVal-fee)}</b></div>
    `;
  }
  showWdStep(n);
}
async function submitWithdrawal(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  if(u.suspended){toast('계정이 정지되어 출금할 수 없습니다','error');return;}
  if(wdAmountVal>u.wallet){toast('잔액이 부족합니다','error');return;}
  const fee=Math.floor(wdAmountVal*CFG.WD_FEE);
  const wd={id:Date.now(),userId:u.id,userName:u.name,amount:wdAmountVal,fee,net:wdAmountVal-fee,
    bankName:u.bankName,accountNumber:u.accountNumber,accountHolder:u.accountHolder,
    requestedAt:localDateStr(new Date()),status:'pending'};
  await dbPut('pendingWithdrawals',wd);  // id 있으므로 fsPut 사용
  u.wallet-=wdAmountVal;
  await dbPut('users',u); currentUser=u;
  await audit('WITHDRAW_REQUEST',`출금신청 ${fmt(wdAmountVal)}`,u.id);
  toast('출금 신청이 접수되었습니다. 관리자 승인 후 처리됩니다','success');
  renderWallet();
}
async function updateBank(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  u.bankName=document.getElementById('bank-name').value.trim();
  u.accountHolder=document.getElementById('bank-holder').value.trim();
  u.accountNumber=document.getElementById('bank-account').value.trim();
  if(!u.bankName||!u.accountHolder||!u.accountNumber){toast('모든 계좌 정보를 입력하세요','error');return;}
  await dbPut('users',u); currentUser=u;
  toast('계좌 정보가 저장되었습니다','success');
}

// ═══════════════════════════════════════════════════════
//  REPORTS & PROFILE
// ═══════════════════════════════════════════════════════
async function renderReports(){
  const u=await dbGet('users',currentUser.id);
  const allTx=await dbGetAll('transactions');
  const myTx=allTx.filter(t=>t.userId===u.id);
  const roiTotal=myTx.filter(t=>t.type==='ROI').reduce((a,c)=>a+c.amount,0);
  const bonusTotal=myTx.filter(t=>['보너스','바이너리','직급수당'].includes(t.type)).reduce((a,c)=>a+c.amount,0);
  const wdTotal=myTx.filter(t=>t.type==='출금').reduce((a,c)=>a+c.amount,0);
  document.getElementById('report-kpi').innerHTML=`
    <div class="stat-card card-gold"><div class="stat-label">ROI 누적</div><div class="stat-value">${fmt(roiTotal)}</div></div>
    <div class="stat-card card-green"><div class="stat-label">수당 합계</div><div class="stat-value">${fmt(bonusTotal)}</div></div>
    <div class="stat-card card-red"><div class="stat-label">총 출금</div><div class="stat-value">${fmt(wdTotal)}</div></div>
  `;
  renderReportTable(myTx,reportFilter);
}
function filterReport(type,btn){
  reportFilter=type;
  document.querySelectorAll('#report-tabs .tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  dbGetAll('transactions').then(allTx=>{ const myTx=allTx.filter(t=>t.userId===currentUser.id); renderReportTable(myTx,type); });
}
function renderReportTable(myTx,filter){
  let filtered=myTx;
  if(filter==='roi') filtered=myTx.filter(t=>t.type==='ROI');
  else if(filter==='bonus') filtered=myTx.filter(t=>t.type==='보너스');
  else if(filter==='binary') filtered=myTx.filter(t=>t.type==='바이너리');
  else if(filter==='rank') filtered=myTx.filter(t=>t.type==='직급수당');
  else if(filter==='withdrawal') filtered=myTx.filter(t=>t.type==='출금');
  else if(filter==='invest') filtered=myTx.filter(t=>t.type==='투자');
  const sorted=filtered.sort((a,b)=>b.id-a.id);
  const tbody=document.getElementById('report-table-body');
  if(sorted.length===0){ tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3);">내역이 없습니다</td></tr>'; return; }
  tbody.innerHTML=sorted.map(t=>`<tr>
    <td style="color:var(--text3);font-size:14px;white-space:nowrap;">${t.date}</td>
    <td><span style="color:${typeColor(t.type)};font-size:14px;font-weight:600;">${typeLabel(t.type)}</span></td>
    <td style="font-size:14px;color:var(--text2);max-width:200px;overflow:hidden;">${_esc(t.desc||'')}</td>
    <td class="td-amount">${fmt(t.amount)}</td>
    <td class="td-amount" style="color:var(--red);">${t.fee>0?'-'+fmt(t.fee):'-'}</td>
    <td class="td-amount" style="color:var(--green);">${fmt(t.netAmount||t.amount)}</td>
    <td>${statusHtml(t.status)}</td>
  </tr>`).join('');
}
async function exportMembersExcel(){
  toast('회원 목록 엑셀 생성 중...','info');
  try {
    const allUsers = await dbGetAll('users');
    // 가입일 순서로 정렬
    const members = allUsers
      .filter(u => u.role === 'member')
      .sort((a,b) => (a.registeredAt||'').localeCompare(b.registeredAt||''));

    const RANK_LABELS = ['일반','브론즈','실버','골드','플래티넘','다이아'];

    // 헤더 정의
    const headers = [
      '번호','아이디','이름','이메일','전화번호',
      '추천인','가입일','승인상태','계정상태',
      '투자금(원)','누적ROI(원)','출금잔액(원)','잔여한도(원)',
      '은행명','계좌번호','예금주',
      '직급','좌측투자(원)','우측투자(원)',
      '마지막ROI일','마지막투자일','마지막로그인'
    ];

    // 데이터 행 생성
    const rows = members.map((u, i) => {
      const sl = Math.min(u.leftInvest||0, u.rightInvest||0);
      const rankObj = calcRank(sl);
      const maxPayout = u.investment * (CFG.MAX_PAYOUT||3);
      const remaining = Math.max(0, maxPayout - (u.roi||0));
      return [
        i + 1,
        u.id || '',
        u.name || '',
        u.email || '',
        u.phone || '',
        (u.sponsorCode && u.sponsorCode !== 'SYSTEM-ROOT') ? u.sponsorCode : '직가입',
        u.registeredAt || '',
        u.approvalStatus === 'approved' ? '승인' : u.approvalStatus === 'pending' ? '대기중' : '거부',
        u.suspended ? '정지' : '정상',
        u.investment || 0,
        u.roi || 0,
        u.wallet || 0,
        remaining,
        u.bankName || '',
        u.accountNumber || '',
        u.accountHolder || '',
        rankObj.label || '일반',
        u.leftInvest || 0,
        u.rightInvest || 0,
        u.lastRoiDate || '',
        u.lastInvestmentDate || '',
        u.lastLogin || ''
      ];
    });

    // 워크북 생성
    const wb = XLSX.utils.book_new();
    const wsData = [headers, ...rows];
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // 컬럼 너비 설정
    ws['!cols'] = [
      {wch:6},{wch:14},{wch:12},{wch:26},{wch:16},
      {wch:12},{wch:14},{wch:10},{wch:8},
      {wch:16},{wch:16},{wch:16},{wch:16},
      {wch:12},{wch:18},{wch:12},
      {wch:10},{wch:16},{wch:16},
      {wch:14},{wch:14},{wch:18}
    ];

    // 헤더 행 스타일 (배경색)
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let C = range.s.c; C <= range.e.c; C++){
      const cellAddr = XLSX.utils.encode_cell({r:0, c:C});
      if(!ws[cellAddr]) continue;
      ws[cellAddr].s = {
        fill:{fgColor:{rgb:'1A1A2E'}},
        font:{bold:true, color:{rgb:'D4A853'}, sz:12},
        alignment:{horizontal:'center', vertical:'center'},
        border:{bottom:{style:'medium', color:{rgb:'D4A853'}}}
      };
    }

    // 숫자 컬럼 천 단위 포맷
    const numCols = [9,10,11,12,17,18]; // 0-indexed
    for(let R = 1; R <= rows.length; R++){
      for(const C of numCols){
        const cellAddr = XLSX.utils.encode_cell({r:R, c:C});
        if(ws[cellAddr] && typeof ws[cellAddr].v === 'number'){
          ws[cellAddr].z = '#,##0';
        }
      }
    }

    XLSX.utils.book_append_sheet(wb, ws, '회원목록');

    // 요약 시트 추가
    const today = localDateStr(new Date());
    const totalInvest = members.reduce((s,u) => s+(u.investment||0), 0);
    const totalWallet = members.reduce((s,u) => s+(u.wallet||0), 0);
    const totalRoi = members.reduce((s,u) => s+(u.roi||0), 0);
    const activeCount = members.filter(u => u.investment > 0 && !u.suspended).length;
    const pendingCount = members.filter(u => u.approvalStatus === 'pending').length;
    const suspendedCount = members.filter(u => u.suspended).length;

    const summaryData = [
      ['MEDI WORLD 회원 현황 요약', ''],
      ['추출일', today],
      ['', ''],
      ['항목', '수치'],
      ['전체 회원 수', members.length],
      ['투자 중 회원', activeCount],
      ['승인 대기', pendingCount],
      ['계정 정지', suspendedCount],
      ['', ''],
      ['총 투자금', totalInvest],
      ['총 누적ROI', totalRoi],
      ['총 출금잔액', totalWallet],
    ];
    const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
    ws2['!cols'] = [{wch:20},{wch:20}];
    XLSX.utils.book_append_sheet(wb, ws2, '요약');

    // 다운로드
    const filename = `MEDIWORLD_회원목록_${today.replace(/-/g,'')}.xlsx`;
    XLSX.writeFile(wb, filename);
    toast(`✅ 엑셀 다운로드 완료! (${members.length}명)`, 'success');

  } catch(e) {
    console.error(e);
    toast('엑셀 생성 중 오류가 발생했습니다', 'error');
  }
}

async function exportReports(){
  const allTx=await dbGetAll('transactions');
  const myTx=currentUser.role==='admin'?allTx:allTx.filter(t=>t.userId===currentUser.id);
  const header='날짜,회원ID,유형,내용,금액,수수료,실수령,상태\n';
  const rows=myTx.map(t=>`${t.date},${t.userId},${typeLabel(t.type)},"${(t.desc||'').replace(/"/g,'""')}",${t.amount},${t.fee||0},${t.netAmount||t.amount},${t.status}`).join('\n');
  const blob=new Blob(['\uFEFF'+header+rows],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mediworld_report.csv'; a.click();
  toast('CSV 다운로드 시작','success');
}
async function renderProfile(){
  const u=await dbGet('users',currentUser.id);
  document.getElementById('prof-name').value=u.name;
  document.getElementById('prof-email').value=u.email||'';
  document.getElementById('prof-phone').value=u.phone||'';
  document.getElementById('prof-last-login').textContent=u.lastLogin||'기록 없음';
  document.getElementById('profile-info').innerHTML=`
    <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);"><span style="font-size:14px;color:var(--text3);">아이디</span><span class="mono" style="font-size:15px;">${_esc(u.id)}</span></div>
    <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);"><span style="font-size:14px;color:var(--text3);">초대 코드</span><span class="mono" style="font-size:15px;color:var(--gold);">${_esc(u.inviteCode)}</span></div>
    <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);"><span style="font-size:14px;color:var(--text3);">추천인</span><span style="font-size:15px;">${u.sponsorCode==='SYSTEM-ROOT'||!u.sponsorCode?'직가입':_esc(u.sponsorCode)}</span></div>
    <div style="display:flex;justify-content:space-between;padding:12px 0;"><span style="font-size:14px;color:var(--text3);">가입일</span><span style="font-size:15px;">${u.registeredAt}</span></div>
  `;
}
async function saveProfile(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  u.name=document.getElementById('prof-name').value.trim()||u.name;
  u.email=document.getElementById('prof-email').value.trim();
  u.phone=document.getElementById('prof-phone').value.trim();
  await dbPut('users',u); currentUser=u; setupTopbar();
  toast('프로필이 저장되었습니다','success');
}
// ── 회원 상세 모달 함수들 ──
async function openMemberDetail(uid){
  _detailUserId=uid;
  const u=await dbGet('users',uid);
  if(!u){toast('회원 정보를 불러올 수 없습니다','error');return;}
  const sl=Math.min(u.leftInvest||0,u.rightInvest||0);
  const rank=calcRank(sl);
  const max=u.investment*(CFG.MAX_PAYOUT||3);
  const statusHtml2=u.suspended?'<span class="status status-fail">정지</span>':
    u.approvalStatus==='pending'?'<span class="status status-pend">승인대기</span>':
    u.investment>0?'<span class="status status-done">투자중</span>':'<span class="status status-stop">미투자</span>';

  // 헤더
  document.getElementById('mmd-title').textContent=`${_esc(u.name)} (${_esc(u.id)})`;
  document.getElementById('mmd-subtitle').innerHTML=`${statusHtml2} &nbsp; 가입일: ${u.registeredAt||'-'} &nbsp; 마지막 로그인: ${u.lastLogin||'-'}`;

  // 첫 탭으로 초기화
  switchMmdTab('info', document.getElementById('mmd-tab-info'));

  // ── 탭1: 기본 정보 (수정 가능) ──
  document.getElementById('mmd-tab-info-body').innerHTML=`
    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;color:var(--gold);margin-bottom:14px;">👤 개인 정보 수정</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">이름</div>
          <input class="form-input" id="edit-name" value="${_esc(u.name||'')}" placeholder="이름">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">아이디 (변경불가)</div>
          <input class="form-input" value="${_esc(u.id)}" disabled style="opacity:0.5;cursor:not-allowed;">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">이메일</div>
          <input class="form-input" id="edit-email" type="email" value="${_esc(u.email||'')}" placeholder="이메일 주소">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">연락처 (전화번호)</div>
          <input class="form-input" id="edit-phone" type="tel" value="${_esc(u.phone||'')}" placeholder="010-0000-0000">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">추천인 코드</div>
          <input class="form-input" id="edit-sponsor" value="${_esc(u.sponsorCode&&u.sponsorCode!=='SYSTEM-ROOT'?u.sponsorCode:'')}" placeholder="추천인 아이디">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">초대 코드</div>
          <input class="form-input" value="${_esc(u.inviteCode||u.id)}" disabled style="opacity:0.5;">
        </div>
      </div>
      <div style="margin-top:12px;">
        <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">새 비밀번호 (변경 시에만 입력)</div>
        <input class="form-input" id="edit-newpwd" type="password" placeholder="새 비밀번호 (8자 이상, 비워두면 변경 안 함)">
      </div>
      <button class="btn btn-primary btn-sm" style="margin-top:14px;width:100%;" onclick="adminSaveBasicInfo()">
        <i class="fas fa-save"></i> 기본 정보 저장
      </button>
    </div>

    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;">
      <div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:14px;">📊 투자 현황 (읽기 전용)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div style="background:var(--bg2);border-radius:12px;padding:14px;text-align:center;">
          <div style="font-size:13px;color:var(--text2);margin-bottom:6px;">직급</div>
          <div class="rank-badge ${rank.class}" style="font-size:14px;display:inline-flex;">${rank.label}</div>
        </div>
        <div style="background:var(--bg2);border-radius:12px;padding:14px;text-align:center;">
          <div style="font-size:13px;color:var(--text2);margin-bottom:6px;">L/R 투자</div>
          <div class="mono" style="font-size:16px;font-weight:700;">${fmt(u.leftInvest||0)} / ${fmt(u.rightInvest||0)}</div>
        </div>
        <div style="background:var(--bg2);border-radius:12px;padding:14px;text-align:center;">
          <div style="font-size:13px;color:var(--text2);margin-bottom:6px;">마지막 ROI</div>
          <div style="font-size:15px;font-weight:700;">${u.lastRoiDate||'-'}</div>
        </div>
        <div style="background:var(--bg2);border-radius:12px;padding:14px;text-align:center;">
          <div style="font-size:13px;color:var(--text2);margin-bottom:6px;">가입일</div>
          <div style="font-size:15px;font-weight:700;">${u.registeredAt||'-'}</div>
        </div>
      </div>
    </div>
  `;

  // ── 탭2: 금융 정보 (수정 가능) ──
  document.getElementById('mmd-tab-finance-body').innerHTML=`
    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;color:var(--green);margin-bottom:14px;">💳 출금 계좌 정보</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">은행명</div>
          <input class="form-input" id="edit-bank" value="${_esc(u.bankName||'')}" placeholder="국민은행">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">계좌번호</div>
          <input class="form-input mono" id="edit-account" value="${_esc(u.accountNumber||'')}" placeholder="000-0000-0000">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">예금주</div>
          <input class="form-input" id="edit-holder" value="${_esc(u.accountHolder||'')}" placeholder="홍길동">
        </div>
      </div>
      <button class="btn btn-success btn-sm" style="margin-top:14px;width:100%;" onclick="adminSaveBankInfo()">
        <i class="fas fa-save"></i> 계좌 정보 저장
      </button>
    </div>

    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;color:var(--gold);margin-bottom:14px;">✏️ 금액 직접 수정</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">투자금 (원)</div>
          <input class="form-input mono" id="admin-edit-investment" type="number" value="${u.investment}">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">누적ROI (원)</div>
          <input class="form-input mono" id="admin-edit-roi" type="number" value="${u.roi}">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">출금잔액 (원)</div>
          <input class="form-input mono" id="admin-edit-wallet" type="number" value="${u.wallet}">
        </div>
      </div>
      <button class="btn btn-sm" style="margin-top:14px;width:100%;background:var(--gold);color:#000;font-weight:800;" onclick="adminEditAmounts()">
        <i class="fas fa-edit"></i> 금액 수정 저장
      </button>
    </div>

    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;">
      <div style="font-size:16px;font-weight:800;color:var(--blue);margin-bottom:14px;">💸 잔액 긴급 추가</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">추가 금액 (원)</div>
          <input class="form-input mono" id="admin-add-wallet-amount" type="number" placeholder="금액 입력">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">지급 사유</div>
          <input class="form-input" id="admin-add-wallet-desc" placeholder="예: 이벤트 보너스">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;">
        <button class="btn btn-success btn-sm" onclick="adminAddWallet()">
          <i class="fas fa-plus"></i> 잔액 추가
        </button>
        <button class="btn btn-purple btn-sm" onclick="adminManualRoi()">
          <i class="fas fa-coins"></i> ROI 수동 지급
        </button>
      </div>
    </div>
  `;

  // ── 탭3: 계정 관리 ──
  document.getElementById('mmd-tab-account-body').innerHTML=`
    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:16px;">🔐 계정 상태</div>
      <div style="display:flex;flex-direction:column;gap:10px;font-size:16px;margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:12px;">
          <span style="color:var(--text2);font-weight:600;">현재 상태</span>
          <span>${statusHtml2}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:12px;">
          <span style="color:var(--text2);font-weight:600;">가입 승인 상태</span>
          <span class="mono" style="font-weight:700;">${u.approvalStatus==='approved'?'✅ 승인됨':'⏳ 대기중'}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:12px;">
          <span style="color:var(--text2);font-weight:600;">계정 정지 여부</span>
          <span class="mono" style="font-weight:700;color:${u.suspended?'var(--red)':'var(--green)'};">${u.suspended?'🚫 정지됨':'✅ 정상'}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:12px;">
          <span style="color:var(--text2);font-weight:600;">마지막 로그인</span>
          <span style="font-weight:700;">${u.lastLogin||'-'}</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <button class="btn btn-sm ${u.suspended?'btn-success':'btn-danger'}" style="min-height:52px;" onclick="toggleSuspend('${_esc(uid)}')">
          <i class="fas fa-${u.suspended?'unlock':'ban'}"></i>
          ${u.suspended?'계정 정지 해제':'계정 정지'}
        </button>
        <button class="btn btn-danger btn-sm" style="min-height:52px;" onclick="adminDeleteMember('${_esc(uid)}')">
          <i class="fas fa-trash"></i> 회원 삭제
        </button>
      </div>
    </div>

    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;">
      <div style="font-size:16px;font-weight:800;color:var(--red);margin-bottom:10px;">⚠️ 주의사항</div>
      <div style="font-size:15px;color:var(--text2);line-height:1.8;">
        • 계정 정지: 해당 회원은 로그인 불가<br>
        • 회원 삭제: 모든 데이터 영구 삭제 (복구 불가)<br>
        • 금액 수정: 거래 내역은 자동 기록됨
      </div>
    </div>
  `;

  document.getElementById('modal-member-detail').classList.remove('hidden');
}

function closeMemberDetail(){
  document.getElementById('modal-member-detail').classList.add('hidden');
  _detailUserId=null;
}
async function adminSaveBasicInfo(){
  if(!_detailUserId)return;
  const u=await dbGet('users',_detailUserId);
  if(!u){toast('회원 정보를 불러올 수 없습니다','error');return;}
  const newName=document.getElementById('edit-name').value.trim();
  const newEmail=document.getElementById('edit-email').value.trim();
  const newPhone=document.getElementById('edit-phone').value.trim();
  const newSponsor=document.getElementById('edit-sponsor').value.trim();
  const newPwd=document.getElementById('edit-newpwd').value;
  if(!newName){toast('이름을 입력하세요','error');return;}
  u.name=newName;
  u.email=newEmail;
  u.phone=newPhone;
  if(newSponsor) u.sponsorCode=newSponsor;
  if(newPwd){
    if(!_sanitizePwd(newPwd)){toast('비밀번호는 8자 이상, 숫자 포함이어야 합니다','error');return;}
    u.pwd=await _hashPwdSecure(newPwd);
  }
  await dbPut('users',u);
  await audit('ADMIN_EDIT_INFO',`기본정보 수정 [${u.id}] 이름:${newName} 이메일:${newEmail} 전화:${newPhone}`,'admin');
  toast(`✅ ${newName} 기본 정보 저장 완료`,'success');
  openMemberDetail(_detailUserId);
}

async function adminSaveBankInfo(){
  if(!_detailUserId)return;
  const u=await dbGet('users',_detailUserId);
  if(!u){toast('회원 정보를 불러올 수 없습니다','error');return;}
  u.bankName=document.getElementById('edit-bank').value.trim();
  u.accountNumber=document.getElementById('edit-account').value.trim();
  u.accountHolder=document.getElementById('edit-holder').value.trim();
  await dbPut('users',u);
  await audit('ADMIN_EDIT_BANK',`계좌 수정 [${u.id}] ${u.bankName} ${u.accountNumber} ${u.accountHolder}`,'admin');
  toast(`✅ ${u.name} 계좌 정보 저장 완료`,'success');
  openMemberDetail(_detailUserId);
}

async function adminDeleteMember(uid){
  showModal('회원 삭제',`[${uid}] 회원의 모든 데이터를 영구 삭제합니다. 이 작업은 되돌릴 수 없습니다. 정말 삭제하시겠습니까?`,async()=>{
    await dbDelete('users',uid);
    await audit('DELETE_MEMBER',`회원 삭제: ${uid}`,'admin');
    toast(`회원 [${uid}]이 삭제되었습니다`,'success');
    closeMemberDetail();
    renderAdmin();
  },'삭제','btn-danger');
}

async function toggleSuspend(uid){
  const u=await dbGet('users',uid);
  u.suspended=!u.suspended;
  await dbPut('users',u);
  await audit('SUSPEND',`계정 ${u.suspended?'정지':'해제'} 대상:${uid}`,'admin');
  toast(`${u.name} 계정이 ${u.suspended?'정지':'활성화'}되었습니다`,u.suspended?'error':'success');
  openMemberDetail(uid);
}
async function adminManualRoi(){
  if(!_detailUserId)return;
  const u=await dbGet('users',_detailUserId);
  if(!u||u.investment===0){toast('투자 원금이 없습니다','error');return;}
  const max=u.investment*(CFG.MAX_PAYOUT||3);
  if(u.roi>=max){toast('이미 최대 수익 한도에 도달했습니다','error');return;}
  const payout=Math.round(u.investment*(CFG.DAILY_ROI||0.01));
  const actual=Math.min(payout,max-u.roi);
  const today=localDateStr(new Date());
  u.roi+=actual; u.wallet+=actual; u.lastRoiDate=today;
  await dbPut('users',u);
  await dbPut('transactions',{id:Date.now(),userId:u.id,type:'ROI',amount:actual,fee:0,netAmount:actual,date:today,status:'completed',desc:'관리자 수동 배당 지급'});
  await audit('MANUAL_ROI',`수동배당 ${fmt(actual)} 대상:${u.id}`,'admin');
  toast(`${u.name}에게 ${fmt(actual)} 수동 지급 완료`,'success');
  closeMemberDetail(); renderAdmin();
}
async function adminAddWallet(){
  if(!_detailUserId)return;
  const amt=parseInt(document.getElementById('admin-add-wallet-amount').value)||0;
  const desc=document.getElementById('admin-add-wallet-desc').value.trim();
  if(amt<=0){toast('금액을 입력하세요','error');return;}
  const u=await dbGet('users',_detailUserId);
  u.wallet+=amt; u.roi+=amt;
  await dbPut('users',u);
  await dbPut('transactions',{id:Date.now(),userId:u.id,type:'ROI',amount:amt,fee:0,netAmount:amt,date:localDateStr(new Date()),status:'completed',desc:desc||'관리자 수동 잔액 추가'});
  await audit('ADD_WALLET',`잔액추가 ${fmt(amt)} 대상:${u.id} 사유:${desc}`,'admin');
  toast(`${u.name}에게 ${fmt(amt)} 추가 완료`,'success');
  closeMemberDetail(); renderAdmin();
}
async function adminEditAmounts(){
  if(!_detailUserId)return;
  const u=await dbGet('users',_detailUserId);
  if(!u){toast('회원 정보를 불러올 수 없습니다','error');return;}

  const newInvestment=parseInt(document.getElementById('admin-edit-investment').value);
  const newRoi=parseInt(document.getElementById('admin-edit-roi').value);
  const newWallet=parseInt(document.getElementById('admin-edit-wallet').value);

  if(isNaN(newInvestment)||isNaN(newRoi)||isNaN(newWallet)){
    toast('올바른 숫자를 입력하세요','error');return;
  }
  if(newInvestment<0||newRoi<0||newWallet<0){
    toast('금액은 0 이상이어야 합니다','error');return;
  }

  const oldInv=u.investment, oldRoi=u.roi, oldWallet=u.wallet;
  u.investment=newInvestment;
  u.roi=newRoi;
  u.wallet=newWallet;
  await dbPut('users',u);

  const today=localDateStr(new Date());
  await audit('ADMIN_EDIT_AMOUNTS',
    `금액수정 [${u.id}] 투자:${fmt(oldInv)}→${fmt(newInvestment)} ROI:${fmt(oldRoi)}→${fmt(newRoi)} 잔액:${fmt(oldWallet)}→${fmt(newWallet)}`,
    'admin');

  toast(`✅ ${u.name} 금액 수정 완료`,'success');
  closeMemberDetail();
  renderAdmin();
}
async function rejectInvestment(id){
  const invId=String(id);
  showModal('투자 거부','이 투자 신청을 거부하시겠습니까?',async()=>{
    try{
      await dbDelete('pendingInvestments',invId);
      await audit('INV_REJECT','투자 거부','admin');
      // DOM 즉시 제거
      const itemEl=document.querySelector(`[data-inv-id="${invId}"]`);
      if(itemEl) itemEl.remove();
      const list=document.getElementById('admin-invest-list');
      if(list&&list.children.length===0) list.innerHTML='<div class="empty"><i class="fas fa-check-circle" style="color:var(--green);"></i><p>대기 중인 투자 신청이 없습니다</p></div>';
      toast('투자 신청이 거부되었습니다');
      await renderAdmin();
    }catch(e){ toast('거부 오류: '+e.message,'error'); }
  },'거부','btn-danger');
}
async function rejectWithdrawal(id){
  showModal('출금 거부','출금을 거부하고 잔액을 반환하시겠습니까?',async()=>{
    const wd=await dbGet('pendingWithdrawals',id); if(!wd)return;
    const user=await dbGet('users',wd.userId);
    if(user){user.wallet+=wd.amount; await dbPut('users',user);}
    await dbDelete('pendingWithdrawals',id);
    await audit('WD_REJECT',`출금 거부+반환 ${fmt(wd.amount)} 회원:${wd.userId}`,'admin');
    toast('출금이 거부되었고 잔액이 반환되었습니다');
    renderAdmin();
  },'거부 및 반환','btn-danger');
}

async function changeAdminPassword(){
  if(!_validateSession())return;
  const cur=document.getElementById('admin-pw-current').value;
  const nw=document.getElementById('admin-pw-new').value;
  const cf=document.getElementById('admin-pw-confirm').value;
  if(!cur||!nw||!cf){toast('모든 항목을 입력하세요','error');return;}
  const u=await dbGet('users',currentUser.id);
  if(!u){toast('사용자 정보를 불러올 수 없습니다','error');return;}
  if(!await _verifyPwdSecure(cur,u.pwd)){toast('현재 비밀번호가 틀립니다','error');return;}
  if(!_sanitizePwd(nw)){toast('새 비밀번호는 8자 이상, 숫자 포함이어야 합니다','error');return;}
  if(nw!==cf){toast('새 비밀번호가 일치하지 않습니다','error');return;}
  if(nw===cur){toast('현재 비밀번호와 다른 비밀번호를 입력하세요','error');return;}
  u.pwd=await _hashPwdSecure(nw);
  u._mustChangePwd=false;
  u._pwdChangedAt=localDateStr(new Date());
  await dbPut('users',u);
  currentUser=u;
  document.getElementById('admin-pw-current').value='';
  document.getElementById('admin-pw-new').value='';
  document.getElementById('admin-pw-confirm').value='';
  await audit('PWD_CHANGE','관리자 비밀번호 변경',u.id);
  toast('✅ 비밀번호가 성공적으로 변경되었습니다!','success');
}
async function changePassword(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  const cur=document.getElementById('pw-current').value;
  const nw=document.getElementById('pw-new').value;
  const cf=document.getElementById('pw-confirm').value;
  if(!await _verifyPwdSecure(cur,u.pwd)){toast('현재 비밀번호가 틀립니다','error');return;}
  if(!_sanitizePwd(nw)){toast('새 비밀번호는 8자 이상, 숫자 포함이어야 합니다','error');return;}
  if(nw!==cf){toast('새 비밀번호가 일치하지 않습니다','error');return;}
  if(nw===cur){toast('현재 비밀번호와 다른 비밀번호를 입력하세요','error');return;}
  u.pwd=await _hashPwdSecure(nw);
  await dbPut('users',u); currentUser=u;
  document.getElementById('pw-current').value='';document.getElementById('pw-new').value='';document.getElementById('pw-confirm').value='';
  await audit('PWD_CHANGE','비밀번호 변경',u.id);
  toast('비밀번호가 변경되었습니다','success');
}

// ═══════════════════════════════════════════════════════
//  ADMIN
// ═══════════════════════════════════════════════════════
async function renderAdmin(){
  if(currentUser.role!=='admin')return;

  // ★ 초기 비밀번호 변경 경고
  const adminUser=await dbGet('users',currentUser.id);
  if(adminUser && adminUser._mustChangePwd){
    const warnEl=document.getElementById('admin-pwd-warn');
    if(warnEl) warnEl.style.display='flex';
  }

  const allUsers=await dbGetAll('users');
  const members=allUsers.filter(u=>u.role==='member');
  const pendInv=await dbGetAll('pendingInvestments');
  const pendWd=await dbGetAll('pendingWithdrawals');
  const allTx=await dbGetAll('transactions');
  const totalInvest=members.reduce((a,u)=>a+u.investment,0);
  const totalRoi=members.reduce((a,u)=>a+u.roi,0);
  const totalWallet=members.reduce((a,u)=>a+u.wallet,0);
  document.getElementById('admin-kpi').innerHTML=`
    <div class="stat-card card-gold"><div class="stat-label">총 회원</div><div class="stat-value">${members.length}</div><div class="stat-sub">명</div></div>
    <div class="stat-card card-blue"><div class="stat-label">총 투자금</div><div class="stat-value">${fmt(totalInvest)}</div></div>
    <div class="stat-card card-green"><div class="stat-label">총 ROI 지급</div><div class="stat-value">${fmt(totalRoi)}</div></div>
    <div class="stat-card"><div class="stat-label">총 잔액</div><div class="stat-value">${fmt(totalWallet)}</div></div>
  `;
  // 배지
  const pendApproval=allUsers.filter(u=>u.role==='member'&&u.approvalStatus==='pending');
  document.getElementById('appr-badge').textContent=pendApproval.length>0?pendApproval.length:'';
  document.getElementById('inv-badge').textContent=pendInv.length>0?pendInv.length:'';
  document.getElementById('wd-badge').textContent=pendWd.length>0?pendWd.length:'';
  // 수당 설정
  document.getElementById('ov-roi').value=(CFG.DAILY_ROI*100).toFixed(1);
  document.getElementById('ov-direct').value=(CFG.DIRECT_BONUS*100).toFixed(1);
  document.getElementById('ov-binary').value=(CFG.BINARY_BONUS*100).toFixed(1);
  document.getElementById('ov-maxpayout').value=(CFG.MAX_PAYOUT*100).toFixed(0);
  document.getElementById('ov-wdfee').value=(CFG.WD_FEE*100).toFixed(1);
  // 입금 계좌
  document.getElementById('admin-bank-name').value=CFG.DEPOSIT_BANK;
  document.getElementById('admin-bank-account').value=CFG.DEPOSIT_ACCOUNT;
  document.getElementById('admin-bank-holder').value=CFG.DEPOSIT_HOLDER;
  // 탭
  const tab=adminCurrentTab;
  ['overview','approval','members','investments','withdrawals','logs'].forEach(t=>{
    const el=document.getElementById('admin-tab-'+t); if(el) el.style.display=t===tab?'block':'none';
  });
  if(tab==='overview') renderAdminOverview(members);
  if(tab==='approval') renderAdminApproval(pendApproval);
  if(tab==='members') renderAdminMembers(members);
  if(tab==='investments') renderAdminInvestments(pendInv);
  if(tab==='withdrawals') renderAdminWithdrawals(pendWd);
  if(tab==='logs') renderAdminLogs(allTx);
}
function renderAdminApproval(pendList){
  const el=document.getElementById('admin-approval-list');
  if(!pendList||pendList.length===0){
    el.innerHTML='<div style="padding:40px;text-align:center;color:var(--text3);font-size:14px;">✅ 승인 대기 중인 가입 신청이 없습니다</div>';
    return;
  }
  el.innerHTML=`
    <div class="table-wrap">
      <table>
        <thead><tr><th>아이디</th><th>이름</th><th>연락처</th><th>이메일</th><th>추천인</th><th>신청일</th><th>처리</th></tr></thead>
        <tbody>
          ${pendList.map(u=>`
            <tr>
              <td><span style="font-weight:700;font-family:monospace;">${_esc(u.id)}</span></td>
              <td>${_esc(u.name)}</td>
              <td>${_esc(u.phone||'-')}</td>
              <td style="font-size:14px;">${_esc(u.email||'-')}</td>
              <td>${u.sponsorCode?_esc(u.sponsorCode):'<span style="color:var(--text3);">없음</span>'}</td>
              <td style="font-size:14px;color:var(--text3);">${_esc(u.registeredAt)}</td>
              <td>
                <div style="display:flex;gap:6px;">
                  <button class="btn btn-success btn-sm" onclick="approveUser('${u.id}')">✅ 승인</button>
                  <button class="btn btn-danger btn-sm" onclick="rejectUser('${u.id}')">❌ 거부</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}
async function approveUser(userId){
  if(!confirm(`[${userId}] 회원의 가입을 승인하시겠습니까?`))return;
  const u=await dbGet('users',userId);
  if(!u)return;
  u.approvalStatus='approved';
  await dbPut('users',u);
  await audit('APPROVE_MEMBER','가입 승인: '+userId,currentUser.id);
  toast('✅ '+u.name+' 회원의 가입이 승인되었습니다','success');
  renderAdmin();
}
async function rejectUser(userId){
  if(!confirm(`[${userId}] 회원의 가입을 거부하고 계정을 삭제하시겠습니까?`))return;
  const u=await dbGet('users',userId);
  if(!u)return;
  await dbDelete('users',userId);
  await audit('REJECT_MEMBER','가입 거부 삭제: '+userId,currentUser.id);
  toast('❌ '+u.name+' 회원의 가입이 거부되었습니다','error');
  renderAdmin();
}
function renderAdminOverview(members){
  // bar chart
  if(adminBarChart){ adminBarChart.destroy(); adminBarChart=null; }
  const top=members.filter(m=>m.investment>0).sort((a,b)=>b.investment-a.investment).slice(0,8);
  const ctx=document.getElementById('admin-bar-chart')?.getContext('2d');
  if(ctx&&top.length>0){
    adminBarChart=new Chart(ctx,{type:'bar',
      data:{labels:top.map(u=>u.name),datasets:[{label:'투자금',data:top.map(u=>u.investment),backgroundColor:'rgba(212,168,83,0.6)',borderColor:'var(--gold)',borderWidth:1},{label:'ROI',data:top.map(u=>u.roi),backgroundColor:'rgba(61,214,140,0.5)',borderColor:'var(--green)',borderWidth:1}]},
      options:{responsive:true,plugins:{legend:{labels:{color:'#8890a4',font:{size:11}}}},scales:{x:{ticks:{color:'#4a5068',font:{size:10}},grid:{color:'rgba(255,255,255,0.04)'}},y:{ticks:{color:'#4a5068',font:{size:10},callback:v=>fmt(v)},grid:{color:'rgba(255,255,255,0.04)'}}}}
    });
  }
  // 직급 현황
  const rankCounts={}; RANK_TABLE.forEach(r=>rankCounts[r.rank]=0);
  members.forEach(u=>{ const sl=Math.min(u.leftInvest||0,u.rightInvest||0); rankCounts[calcRank(sl).rank]++; });
  document.getElementById('admin-rank-overview').innerHTML=RANK_TABLE.map(r=>`
    <div class="rank-row">
      <div class="rank-badge ${r.class}"><i class="fas fa-star"></i>${r.label}</div>
      <div style="font-size:14px;color:var(--text2);">${rankCounts[r.rank]}명</div>
      ${r.rank>0?`<div style="font-size:14px;color:var(--text3);">수당 ${fmt(r.bonus)}</div>`:''}
    </div>`).join('');
}
function renderAdminMembers(members){
  const tbody=document.getElementById('admin-member-body');
  tbody.innerHTML=members.map(u=>{
    const sl=Math.min(u.leftInvest||0,u.rightInvest||0);
    const rank=calcRank(sl);
    const maxPayout=u.investment*CFG.MAX_PAYOUT;
    const isMaxed=u.roi>=maxPayout&&maxPayout>0;
    return `<tr>
      <td><div style="font-weight:600;">${_esc(u.name)}</div><div style="font-size:14px;color:var(--text3);font-family:'Space Mono',monospace;">${_esc(u.id)}</div></td>
      <td style="font-size:14px;color:var(--text3);">${u.sponsorCode&&u.sponsorCode!=='SYSTEM-ROOT'?_esc(u.sponsorCode):'-'}</td>
      <td class="td-amount">${fmt(u.investment)}</td>
      <td class="td-amount" style="color:var(--gold);">${fmt(u.roi)}${isMaxed?'<span class="stat-badge badge-down" style="margin-left:4px;font-size:9px;">300%</span>':''}</td>
      <td class="td-amount" style="color:var(--green);">${fmt(u.wallet)}</td>
      <td><div class="rank-badge ${rank.class}" style="font-size:15px;">${rank.label}</div></td>
      <td>${u.approvalStatus==='pending'?'<span class="status status-pend">승인대기</span>':u.suspended?'<span class="status status-fail">정지</span>':u.investment>0?'<span class="status status-done">투자중</span>':'<span class="status status-stop">미투자</span>'}</td>
      <td><button class="btn btn-secondary btn-sm" onclick="openMemberDetail('${_esc(u.id)}')"><i class="fas fa-cog"></i> 관리</button></td>
    </tr>`;
  }).join('');
  if(members.length===0) tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3);">회원이 없습니다</td></tr>';
}
function renderAdminInvestments(pendInv){
  const list=document.getElementById('admin-invest-list');
  if(pendInv.length===0){list.innerHTML='<div class="empty"><i class="fas fa-check-circle" style="color:var(--green);"></i><p>대기 중인 투자 신청이 없습니다</p></div>';return;}
  list.innerHTML=pendInv.map(inv=>`
    <div data-inv-id="${inv.id}" style="display:flex;justify-content:space-between;align-items:center;padding:18px 20px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;flex-wrap:wrap;gap:10px;">
      <div>
        <div style="font-size:16px;font-weight:700;" class="mono">${fmtFull(inv.amount)}</div>
        <div style="font-size:14px;color:var(--text3);margin-top:4px;">${_esc(inv.userId)} (${_esc(inv.userName)}) · 신청일: ${inv.requestedAt}</div>
        <div style="font-size:14px;color:var(--text2);margin-top:2px;">입금자: ${_esc(inv.depositorName)} ${inv.memo?'· '+_esc(inv.memo):''}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-success btn-sm" onclick="approveInvestment('${inv.id}')"><i class="fas fa-check"></i> 승인</button>
        <button class="btn btn-danger btn-sm" onclick="rejectInvestment('${inv.id}')"><i class="fas fa-times"></i> 거부</button>
      </div>
    </div>`).join('');
}
function renderAdminWithdrawals(pendWd){
  const list=document.getElementById('admin-wd-list');
  if(pendWd.length===0){list.innerHTML='<div class="empty"><i class="fas fa-check-circle" style="color:var(--green);"></i><p>대기 중인 출금 신청이 없습니다</p></div>';return;}
  list.innerHTML=pendWd.map(wd=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 20px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;">
      <div>
        <div style="font-size:16px;font-weight:700;" class="mono">${fmtFull(wd.amount)}</div>
        <div style="font-size:14px;color:var(--text3);margin-top:4px;">${_esc(wd.userId)} (${_esc(wd.userName)}) · ${wd.requestedAt}</div>
        <div style="font-size:14px;color:var(--text2);margin-top:2px;">${_esc(wd.bankName)} ${_esc(wd.accountNumber)} (${_esc(wd.accountHolder)})</div>
        <div style="font-size:14px;margin-top:2px;">실지급: <span class="mono" style="color:var(--green);">${fmtFull(wd.net)}</span> · 수수료: ${fmtFull(wd.fee)}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-success btn-sm" onclick="approveWithdrawal(${wd.id})"><i class="fas fa-check"></i> 승인</button>
        <button class="btn btn-danger btn-sm" onclick="rejectWithdrawal(${wd.id})"><i class="fas fa-times"></i> 거부</button>
      </div>
    </div>`).join('');
}
function renderAdminLogs(allTx){
  const sorted=allTx.sort((a,b)=>b.id-a.id).slice(0,500);
  const c=document.getElementById('log-count');
  if(c) c.textContent=`전체 ${allTx.length}건`;
  document.getElementById('admin-log-body').innerHTML=sorted.length===0
    ?'<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3);">거래내역이 없습니다</td></tr>'
    :sorted.map(t=>`<tr style="${t.status==='cancelled'?'opacity:0.55;':''}">
    <td style="font-size:13px;color:var(--text3);white-space:nowrap;">${t.date}</td>
    <td style="font-size:13px;font-family:monospace;">${_esc(t.userId||'')}</td>
    <td><span style="color:${typeColor(t.type)};font-size:13px;font-weight:700;">${typeLabel(t.type)}</span></td>
    <td class="td-amount" style="font-size:13px;${t.status==='cancelled'?'text-decoration:line-through;color:var(--text3);':''}">
      ${t.status==='cancelled'?'<span style="color:var(--red);font-size:11px;font-weight:700;">✗ 취소</span> ':''} ${fmt(t.amount)}</td>
    <td style="font-size:13px;color:var(--text3);">${t.fee>0?fmt(t.fee):'-'}</td>
    <td style="font-size:13px;color:var(--text3);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${_esc(t.desc||'')}">${_esc(t.desc||'')}</td>
    <td>${statusHtml(t.status)}</td>
    <td><div style="display:flex;gap:4px;flex-wrap:wrap;">
      ${t.status!=='cancelled'?`<button class="btn btn-secondary btn-sm" style="padding:4px 8px;font-size:11px;" onclick="openTxEditModal('${String(t.id)}')"><i class="fas fa-edit"></i></button>`:''}
      ${t.status==='completed'?`<button class="btn btn-warning btn-sm" style="padding:4px 8px;font-size:11px;background:#e67e22;border-color:#e67e22;color:#fff;" onclick="cancelTxLog('${String(t.id)}')"><i class="fas fa-undo"></i> 취소</button>`:''}
      <button class="btn btn-danger btn-sm" style="padding:4px 8px;font-size:11px;" onclick="deleteTxLog('${String(t.id)}')"><i class="fas fa-trash"></i></button>
    </div></td>
  </tr>`).join('');
}

// ── 거래내역 검색 (유형 필터 포함) ──
function searchLogs(){
  const q=(document.getElementById('log-search')?.value||'').toLowerCase();
  const tf=document.getElementById('log-type-filter')?.value||'all';
  dbGetAll('transactions').then(all=>{
    let r=all;
    if(q) r=r.filter(t=>(t.userId||'').toLowerCase().includes(q)||(t.desc||'').toLowerCase().includes(q));
    if(tf!=='all') r=r.filter(t=>t.type===tf);
    renderAdminLogs(r);
  });
}

// ── 거래내역 수정 모달 열기 ──
async function openTxEditModal(txId){
  const tx=await dbGet('transactions',String(txId));
  if(!tx){toast('거래내역을 찾을 수 없습니다','error');return;}
  document.getElementById('tx-edit-title').textContent='거래내역 수정';
  document.getElementById('tx-edit-id').value=String(tx.id);
  document.getElementById('tx-edit-userId').value=tx.userId||'';
  document.getElementById('tx-edit-type').value=tx.type||'기타';
  document.getElementById('tx-edit-date').value=tx.date||localDateStr(new Date());
  document.getElementById('tx-edit-amount').value=tx.amount||0;
  document.getElementById('tx-edit-fee').value=tx.fee||0;
  document.getElementById('tx-edit-net').value=tx.netAmount!=null?tx.netAmount:tx.amount||0;
  document.getElementById('tx-edit-desc').value=tx.desc||'';
  document.getElementById('tx-edit-status').value=tx.status||'completed';
  document.getElementById('modal-tx-edit').classList.remove('hidden');
}

// ── 새 거래 추가 모달 열기 ──
function openAddTxModal(prefillUid){
  document.getElementById('tx-edit-title').textContent='거래내역 추가';
  document.getElementById('tx-edit-id').value='';
  document.getElementById('tx-edit-userId').value=prefillUid||'';
  document.getElementById('tx-edit-type').value='ROI';
  document.getElementById('tx-edit-date').value=localDateStr(new Date());
  document.getElementById('tx-edit-amount').value='';
  document.getElementById('tx-edit-fee').value='0';
  document.getElementById('tx-edit-net').value='';
  document.getElementById('tx-edit-desc').value='';
  document.getElementById('tx-edit-status').value='completed';
  document.getElementById('modal-tx-edit').classList.remove('hidden');
}

function closeTxEdit(){ document.getElementById('modal-tx-edit').classList.add('hidden'); }

function txAutoNet(){
  const a=parseInt(document.getElementById('tx-edit-amount').value)||0;
  const f=parseInt(document.getElementById('tx-edit-fee').value)||0;
  document.getElementById('tx-edit-net').value=Math.max(0,a-f);
}

// ── 거래내역 저장 (수정 / 추가) ──
async function saveTxEdit(){
  const txId=document.getElementById('tx-edit-id').value;
  const userId=document.getElementById('tx-edit-userId').value.trim();
  const type=document.getElementById('tx-edit-type').value;
  const date=document.getElementById('tx-edit-date').value;
  const amount=parseInt(document.getElementById('tx-edit-amount').value)||0;
  const fee=parseInt(document.getElementById('tx-edit-fee').value)||0;
  const net=parseInt(document.getElementById('tx-edit-net').value)||Math.max(0,amount-fee);
  const desc=document.getElementById('tx-edit-desc').value.trim();
  const status=document.getElementById('tx-edit-status').value;
  if(!userId){toast('회원 ID를 입력하세요','error');return;}
  if(!date){toast('날짜를 선택하세요','error');return;}
  try{
    const ux=await dbGet('users',userId);
    if(!ux){toast(`회원 [${userId}] 을 찾을 수 없습니다`,'error');return;}
    const isNew=!txId;
    const id=isNew?Date.now():(parseInt(txId)||txId);
    await dbPut('transactions',{id,userId,type,date,amount,fee,netAmount:net,desc,status});
    await audit(isNew?'TX_ADD':'TX_EDIT',`거래 ${isNew?'추가':'수정'} [${id}] ${userId} ${type} ${fmt(amount)}`,'admin');
    toast(isNew?'✅ 거래내역 추가 완료':'✅ 거래내역 수정 완료','success');
    closeTxEdit();
    if(_detailUserId) await renderMemberTxTab(_detailUserId);
    await renderAdmin();
  }catch(e){
    console.error('저장 오류:',e);
    toast('저장 오류: '+e.message,'error');
  }
}

// ── 거래내역 삭제 (로그 탭) ──
// ── 거래내역 취소 (역차감) ──
async function cancelTxLog(txId){
  const tx = await dbGet('transactions', String(txId));
  if(!tx){ toast('거래내역을 찾을 수 없습니다','error'); return; }
  if(tx.status === 'cancelled'){ toast('이미 취소된 거래입니다','error'); return; }

  const typeStr = tx.type || '거래';
  const amtStr = fmt(tx.amount);
  const userStr = tx.userId;

  showModal(
    `${typeStr} 취소`,
    `[${userStr}] ${typeStr} ${amtStr} 을 취소합니다.<br><br>` +
    `<b style="color:var(--red);">⚠️ 해당 금액이 회원 잔액/투자금에서 역차감됩니다.</b><br>` +
    `대시보드 집계도 즉시 반영됩니다.`,
    async()=>{
      try{
        const user = await dbGet('users', tx.userId);
        if(user){
          const amt = tx.amount || 0;
          const net = tx.netAmount || tx.amount || 0;

          if(tx.type === '투자'){
            // 투자금 차감 (0 미만 방지)
            user.investment = Math.max(0, (user.investment||0) - amt);
          } else if(tx.type === 'ROI'){
            // ROI는 wallet + roi 차감
            user.wallet = Math.max(0, (user.wallet||0) - net);
            user.roi    = Math.max(0, (user.roi||0)    - net);
          } else if(tx.type === '보너스'){
            // 추천 수당: wallet + roi 차감
            user.wallet = Math.max(0, (user.wallet||0) - net);
            user.roi    = Math.max(0, (user.roi||0)    - net);
          } else if(tx.type === '직급수당'){
            // 직급 수당: wallet + roi 차감
            user.wallet = Math.max(0, (user.wallet||0) - net);
            user.roi    = Math.max(0, (user.roi||0)    - net);
          } else if(tx.type === '출금'){
            // 출금 취소: wallet 복원
            user.wallet = (user.wallet||0) + net;
          }
          await dbPut('users', user);
        }

        // 거래 상태를 'cancelled'로 변경 (삭제 X - 감사 추적 보존)
        const updated = { ...tx, status:'cancelled', cancelledAt: localDateStr(new Date()), cancelledBy:'admin', cancelDesc:`[관리자 취소] 원거래: ${tx.desc||''}` };
        await dbPut('transactions', updated);

        // 취소 감사 로그
        await audit('TX_CANCEL', `거래취소 [${txId}] ${tx.userId} ${tx.type} ${fmt(tx.amount)} → 역차감 완료`, 'admin');

        toast(`✅ ${typeStr} 취소 완료 - ${userStr} 잔액 반영됨`, 'success');
        await renderAdmin();
      }catch(e){
        console.error('취소 오류:',e);
        toast('취소 오류: '+e.message,'error');
      }
    },
    '취소 실행', 'btn-danger'
  );
}

async function deleteTxLog(txId){
  showModal('거래내역 삭제','이 거래내역을 영구 삭제합니다. 되돌릴 수 없습니다.',async()=>{
    try{
      await dbDelete('transactions',String(txId));
      await audit('TX_DELETE',`거래내역 삭제 [${txId}]`,'admin');
      toast('삭제되었습니다','success');
      await renderAdmin();
    }catch(e){
      console.error('삭제 오류:',e);
      toast('삭제 오류: '+e.message,'error');
    }
  },'삭제','btn-danger');
}

// ── switchMmdTab (거래내역 탭 포함) ──
function switchMmdTab(tab,btn){
  ['info','finance','tx','account'].forEach(t=>{
    document.getElementById('mmd-tab-'+t+'-body').style.display=t===tab?'block':'none';
    document.getElementById('mmd-tab-'+t).classList.toggle('active',t===tab);
  });
  if(tab==='tx') renderMemberTxTab(_detailUserId);
}

// ── 회원별 거래내역 탭 렌더 ──
async function renderMemberTxTab(uid){
  const body=document.getElementById('mmd-tab-tx-body');
  if(!body||!uid) return;
  body.innerHTML='<div style="padding:30px;text-align:center;color:var(--text3);"><i class="fas fa-spinner fa-spin"></i> 불러오는 중...</div>';
  const all=await dbGetAll('transactions');
  const txs=all.filter(t=>t.userId===uid).sort((a,b)=>b.id-a.id);
  body.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <span style="font-size:14px;color:var(--text2);">총 <b style="color:var(--text);">${txs.length}건</b></span>
      <button class="btn btn-primary btn-sm" onclick="openAddTxModal('${_esc(uid)}')"><i class="fas fa-plus"></i> 거래 추가</button>
    </div>
    <div class="table-wrap" style="max-height:380px;overflow-y:auto;">
      <table>
        <thead><tr><th>날짜</th><th>유형</th><th>금액</th><th>내용</th><th>상태</th><th>관리</th></tr></thead>
        <tbody>${txs.length===0
          ?'<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text3);">거래내역이 없습니다</td></tr>'
          :txs.map(t=>`<tr>
          <td style="font-size:13px;color:var(--text3);white-space:nowrap;">${t.date}</td>
          <td><span style="color:${typeColor(t.type)};font-size:13px;font-weight:700;">${typeLabel(t.type)}</span></td>
          <td style="font-size:13px;text-align:right;font-family:monospace;">${fmt(t.amount)}</td>
          <td style="font-size:12px;color:var(--text3);max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${_esc(t.desc||'')}">${_esc(t.desc||'')}</td>
          <td>${statusHtml(t.status)}</td>
          <td><div style="display:flex;gap:3px;flex-wrap:wrap;">
            ${t.status!=='cancelled'?`<button class="btn btn-secondary btn-sm" style="padding:3px 7px;font-size:11px;" onclick="openTxEditModal('${String(t.id)}')"><i class="fas fa-edit"></i></button>`:''}
            ${t.status==='completed'?`<button class="btn btn-sm" style="padding:3px 7px;font-size:11px;background:#e67e22;border:1px solid #e67e22;color:#fff;border-radius:var(--r);" onclick="cancelTxLog('${String(t.id)}')"><i class="fas fa-undo"></i></button>`:''}
            <button class="btn btn-danger btn-sm" style="padding:3px 7px;font-size:11px;" onclick="deleteTxMember('${String(t.id)}','${_esc(uid)}')"><i class="fas fa-trash"></i></button>
          </div></td>
        </tr>`).join('')}</tbody>
      </table>
    </div>`;
}

// ── 회원 상세에서 거래내역 삭제 ──
async function deleteTxMember(txId,uid){
  showModal('거래내역 삭제','이 거래내역을 영구 삭제합니다.',async()=>{
    try{
      await dbDelete('transactions',String(txId));
      await audit('TX_DELETE',`거래내역 삭제 [${txId}] 회원:${uid}`,'admin');
      toast('삭제되었습니다','success');
      await renderMemberTxTab(uid);
      await renderAdmin();
    }catch(e){
      console.error('삭제 오류:',e);
      toast('삭제 오류: '+e.message,'error');
    }
  },'삭제','btn-danger');
}

// ═══════════════════════════════════════════════════════
//  ADMIN ACTIONS
// ═══════════════════════════════════════════════════════
function switchAdminTab(tab,btn){
  ['overview','approval','members','investments','withdrawals','logs'].forEach(t=>{
    const el=document.getElementById('admin-tab-'+t); if(el) el.style.display=t===tab?'block':'none';
  });
  document.querySelectorAll('#admin-tabs .tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); adminCurrentTab=tab;
  renderAdmin();
}
function searchMembers(){
  const q=document.getElementById('member-search').value.toLowerCase();
  const status=document.getElementById('member-status-filter').value;
  dbGetAll('users').then(allUsers=>{
    let members=allUsers.filter(u=>u.role==='member');
    if(q) members=members.filter(u=>u.name.toLowerCase().includes(q)||u.id.toLowerCase().includes(q));
    if(status==='active') members=members.filter(u=>u.investment>0&&!u.suspended);
    if(status==='inactive') members=members.filter(u=>u.investment===0);
    if(status==='suspended') members=members.filter(u=>u.suspended);
    renderAdminMembers(members);
  });
}
async function saveOverrides(){
  const roi=parseFloat(document.getElementById('ov-roi').value)/100;
  const direct=parseFloat(document.getElementById('ov-direct').value)/100;
  const binary=parseFloat(document.getElementById('ov-binary').value)/100;
  const maxP=parseFloat(document.getElementById('ov-maxpayout').value)/100;
  const wdfee=parseFloat(document.getElementById('ov-wdfee').value)/100;
  if(isNaN(roi)||isNaN(direct)||isNaN(binary)||isNaN(maxP)||isNaN(wdfee)){toast('올바른 숫자를 입력하세요','error');return;}
  await saveSetting('DAILY_ROI',roi); await saveSetting('DIRECT_BONUS',direct);
  await saveSetting('BINARY_BONUS',binary); await saveSetting('MAX_PAYOUT',maxP); await saveSetting('WD_FEE',wdfee);
  await audit('SETTINGS','수당 비율 변경','admin');
  toast('수당 설정이 저장되었습니다','success');
}
async function saveDepositAccount(){
  const bank=document.getElementById('admin-bank-name').value.trim();
  const acc=document.getElementById('admin-bank-account').value.trim();
  const holder=document.getElementById('admin-bank-holder').value.trim();
  if(!bank||!acc||!holder){toast('모든 항목을 입력하세요','error');return;}
  await saveSetting('DEPOSIT_BANK',bank); await saveSetting('DEPOSIT_ACCOUNT',acc); await saveSetting('DEPOSIT_HOLDER',holder);
  toast('입금 계좌가 저장되었습니다','success');
}
// ★ 투자 승인 처리 중 ID 집합 (중복 방지)
const _invProcessing = new Set();

async function approveInvestment(id){
  const invId = String(id);
  if(_invProcessing.has(invId)){ toast('이미 처리 중입니다.','error'); return; }

  showModal('투자 승인','이 투자 신청을 승인하시겠습니까?', async()=>{
    if(_invProcessing.has(invId)){ toast('이미 처리 중입니다.','error'); return; }
    _invProcessing.add(invId);

    // 승인 버튼 즉시 비활성화
    const itemEl = document.querySelector(`[data-inv-id="${invId}"]`);
    if(itemEl) itemEl.querySelectorAll('button').forEach(b=>{b.disabled=true; b.style.opacity='0.4';});

    try{
      // DB 재조회 — 이미 처리됐는지 최종 확인
      const inv = await dbGet('pendingInvestments', invId);
      if(!inv){
        toast('이미 처리된 신청입니다.','error');
        if(itemEl) itemEl.remove();
        renderAdmin(); return;
      }
      const user = await dbGet('users', inv.userId);
      if(!user){ toast('회원 정보를 찾을 수 없습니다','error'); return; }

      const today = localDateStr(new Date());
      user.investment += inv.amount;
      user.lastInvestmentDate = today;
      await dbPut('users', user);

      const txBase = Date.now();
      await dbPut('transactions',{id:txBase,userId:inv.userId,type:'투자',amount:inv.amount,fee:0,netAmount:inv.amount,date:today,status:'completed',desc:'투자 승인 완료'});

      if(user.sponsorCode&&user.sponsorCode!=='SYSTEM-ROOT'){
        const sponsor1 = await dbGet('users', user.sponsorCode);
        if(sponsor1&&!sponsor1.suspended){
          const max1 = sponsor1.investment*CFG.MAX_PAYOUT;
          if(sponsor1.roi<max1||sponsor1.investment===0){
            const bonus1=Math.floor(inv.amount*CFG.DIRECT_BONUS);
            const actual1=sponsor1.investment>0?Math.min(bonus1,max1-sponsor1.roi):bonus1;
            if(actual1>0){
              sponsor1.wallet+=actual1; sponsor1.roi+=actual1;
              await dbPut('users',sponsor1);
              await dbPut('transactions',{id:txBase+1+Math.floor(Math.random()*9999),userId:sponsor1.id,type:'보너스',amount:actual1,fee:0,netAmount:actual1,date:today,status:'completed',desc:`직추천 수당 1대 (${user.id} 투자금의 ${(CFG.DIRECT_BONUS*100).toFixed(0)}%)`});
            }
          }
          if(sponsor1.sponsorCode&&sponsor1.sponsorCode!=='SYSTEM-ROOT'){
            const sponsor2 = await dbGet('users', sponsor1.sponsorCode);
            if(sponsor2&&!sponsor2.suspended){
              const max2=sponsor2.investment*CFG.MAX_PAYOUT;
              if(sponsor2.roi<max2||sponsor2.investment===0){
                const bonus2=Math.floor(inv.amount*CFG.BINARY_BONUS);
                const actual2=sponsor2.investment>0?Math.min(bonus2,max2-sponsor2.roi):bonus2;
                if(actual2>0){
                  sponsor2.wallet+=actual2; sponsor2.roi+=actual2;
                  await dbPut('users',sponsor2);
                  await dbPut('transactions',{id:txBase+2+Math.floor(Math.random()*9999),userId:sponsor2.id,type:'보너스',amount:actual2,fee:0,netAmount:actual2,date:today,status:'completed',desc:`소실적 수당 2대 (${user.id} 투자금의 ${(CFG.BINARY_BONUS*100).toFixed(0)}%)`});
                }
              }
            }
          }
        }
      }

      // ★ 라인 포인트/직급 수당은 부가기능 - 에러나도 승인은 계속
      try{ await updateLinePoints(user.id, inv.amount); }
      catch(e){ console.warn('[라인포인트 오류 무시]', e.message); }
      try{ await checkRankBonuses(user.id, today); }
      catch(e){ console.warn('[직급수당 오류 무시]', e.message); }

      // ★ pending 삭제 (핵심 - 여기서 실패하면 진짜 실패)
      await dbDelete('pendingInvestments', invId);
      await audit('INV_APPROVE',`투자 승인 ${fmt(inv.amount)} 회원:${inv.userId}`,'admin');
      toast(`✅ ${inv.userName||inv.userId} 투자 승인 완료 (${fmt(inv.amount)})`,'success');

      // ★ DOM에서 즉시 제거 후 목록 새로고침
      if(itemEl) itemEl.remove();
      const list = document.getElementById('admin-invest-list');
      if(list&&!list.querySelector('[data-inv-id]')){
        list.innerHTML='<div class="empty"><i class="fas fa-check-circle" style="color:var(--green);"></i><p>대기 중인 투자 신청이 없습니다</p></div>';
      }
      await renderAdmin();

    } catch(err){
      console.error('투자 승인 오류:',err);
      toast('승인 오류: '+err.message,'error');
      if(itemEl) itemEl.querySelectorAll('button').forEach(b=>{b.disabled=false; b.style.opacity='';});
    } finally{
      _invProcessing.delete(invId);
    }
  },'승인','btn-success');
}
async function updateLinePoints(newUserId,amount){
  // 추천 체인 올라가면서 좌우 포인트 업데이트
  const newUser=await dbGet('users',newUserId);
  if(!newUser||!newUser.sponsorCode)return;
  const allUsers=await dbGetAll('users');
  // BFS로 상위 추천인들 찾기 - 최대 10레벨
  let curId=newUser.sponsorCode;
  for(let i=0;i<10&&curId;i++){
    const cur=await dbGet('users',curId);
    if(!cur)break;
    // 이 회원의 왼쪽/오른쪽 중 newUserId가 어느쪽?
    // 단순화: 직접 왼쪽 자식의 하위면 leftInvest, 아니면 rightInvest
    const leftDown=getDownlineIds(cur.children?.left,allUsers);
    if(leftDown.includes(newUserId)||cur.children?.left===newUserId){
      cur.leftInvest=(cur.leftInvest||0)+amount;
      cur.leftPoints=(cur.leftPoints||0)+amount;
    } else {
      cur.rightInvest=(cur.rightInvest||0)+amount;
      cur.rightPoints=(cur.rightPoints||0)+amount;
    }
    await dbPut('users',cur);
    curId=cur.sponsorCode;
  }
}
function getDownlineIds(uid,allUsers){
  if(!uid)return[];
  const acc=[uid];
  const children=allUsers.filter(u=>u.sponsorCode===uid);
  children.forEach(c=>{ acc.push(...getDownlineIds(c.id,allUsers)); });
  return acc;
}
async function checkRankBonuses(newUserId,date){
  // 추천 라인 상위 모두 직급 수당 체크
  let curId=(await dbGet('users',newUserId))?.sponsorCode;
  let depth=0;
  while(curId&&depth<10){
    const cur=await dbGet('users',curId);
    if(!cur||cur.role==='admin')break;
    const sl=Math.min(cur.leftInvest||0,cur.rightInvest||0);
    const rank=calcRank(sl);
    if(rank.rank>0&&!( (cur.paidRanks||[]).includes(rank.rank) )){
      // 미지급 직급 수당 지급
      const max=cur.investment*CFG.MAX_PAYOUT;
      if(cur.investment===0||cur.roi<max){
        const actual=cur.investment>0?Math.min(rank.bonus,max-cur.roi):rank.bonus;
        if(actual>0){
          cur.wallet+=actual; cur.roi+=actual;
          if(!cur.paidRanks) cur.paidRanks=[];
          cur.paidRanks.push(rank.rank);
          await dbPut('users',cur);
          await dbPut('transactions',{id:Date.now()+depth,userId:cur.id,type:'직급수당',amount:actual,fee:0,netAmount:actual,date,status:'completed',desc:`${rank.label} 직급 수당 달성 (소라인 ${fmt(sl)})`});
          toast(`${cur.name}님 ${rank.label} 직급 달성! ${fmt(actual)} 지급`,'success');
        }
      }
    }
    curId=cur.sponsorCode; depth++;
  }
}
async function approveWithdrawal(id){
  showModal('출금 승인','이 출금 신청을 승인하시겠습니까?',async()=>{
    const wd=await dbGet('pendingWithdrawals',id); if(!wd)return;
    const today=localDateStr(new Date());
    await dbPut('transactions',{id:Date.now(),userId:wd.userId,type:'출금',amount:wd.amount,fee:wd.fee,netAmount:wd.net,date:today,status:'completed',desc:'출금 승인 완료'});
    await dbDelete('pendingWithdrawals',id);
    await audit('WD_APPROVE',`출금 승인 ${fmt(wd.amount)} 회원:${wd.userId}`,'admin');
    toast('출금이 승인되었습니다','success');
    await renderAdmin();
  },'승인','btn-success');
}
async function runSettlement(){
  const today=new Date();
  const dow=today.getDay();
  if(dow===0||dow===6){toast('주말(토/일)은 배당일이 아닙니다','error');return;}
  showModal('전체 정산 실행',`오늘(${localDateStr(today)}) 전체 회원 ROI ${(CFG.DAILY_ROI*100).toFixed(1)}% 배당을 지급하겠습니까?`,async()=>{
    const allUsers=await dbGetAll('users');
    const todayStr=localDateStr(today);
    let count=0;
    for(const u of allUsers){
      if(u.role!=='member'||u.investment===0||u.suspended)continue;
      const max=u.investment*CFG.MAX_PAYOUT;
      if(u.roi>=max)continue;
      const payout=Math.round(u.investment*CFG.DAILY_ROI);
      const actual=Math.min(payout,max-u.roi);
      if(actual<=0)continue;
      u.roi+=actual; u.wallet+=actual; u.lastRoiDate=todayStr;
      await dbPut('users',u);
      await dbPut('transactions',{id:Date.now()+count,userId:u.id,type:'ROI',amount:actual,fee:0,netAmount:actual,date:todayStr,status:'completed',desc:`일괄 자동 정산 ROI ${(CFG.DAILY_ROI*100).toFixed(1)}%`});
      count++;
    }
    await audit('SETTLEMENT',`전체 정산 ${count}명 완료`,'admin');
    toast(`정산 완료 — ${count}명에게 ROI 지급됨`,'success');
    renderAdmin();
  },'정산 실행','btn-primary');
}

//  ROI AUTO SCHEDULER (주 5일 월~금)
// ═══════════════════════════════════════════════════════
function getPayableDates(lastPaidDate,approvedDate,todayDate){
  const dates=[];
  const start=new Date(approvedDate); start.setDate(start.getDate()+1);
  const last=lastPaidDate?new Date(lastPaidDate):null;
  const end=new Date(todayDate);
  let cur=new Date(start);
  while(cur<=end){
    const dow=cur.getDay();
    const curStr=localDateStr(cur);
    if(dow>=1&&dow<=5&&(!last||cur>last)) dates.push(curStr); // 월~금만
    cur.setDate(cur.getDate()+1);
  }
  return dates;
}
async function processUserRoi(userId){
  const u=await dbGet('users',userId);
  if(!u||u.role!=='member'||u.investment===0||u.suspended)return 0;
  const max=u.investment*CFG.MAX_PAYOUT;
  if(u.roi>=max)return 0;
  const today=localDateStr(new Date());
  const approvedDate=u.lastInvestmentDate; if(!approvedDate)return 0;
  const payableDates=getPayableDates(u.lastRoiDate||null,approvedDate,today);
  if(payableDates.length===0)return 0;
  let totalPaid=0; let upd={...u};
  for(const dateStr of payableDates){
    if(upd.roi>=max)break;
    const payout=Math.round(upd.investment*CFG.DAILY_ROI);
    const actual=Math.min(payout,max-upd.roi);
    if(actual<=0)break;
    upd.roi+=actual; upd.wallet+=actual; upd.lastRoiDate=dateStr; totalPaid+=actual;
    await dbPut('transactions',{id:Date.now()+Math.floor(Math.random()*9999),userId:u.id,type:'ROI',amount:actual,fee:0,netAmount:actual,date:dateStr,status:'completed',desc:`자동 ROI ${(CFG.DAILY_ROI*100).toFixed(1)}% — ${dateStr}`});
    await new Promise(r=>setTimeout(r,2));
  }
  if(totalPaid>0) await dbPut('users',upd);
  return totalPaid;
}
async function catchUpRoi(){
  if(!currentUser||currentUser.role==='admin')return;
  const paid=await processUserRoi(currentUser.id);
  if(paid>0){
    const u=await dbGet('users',currentUser.id); currentUser=u;
    toast(`미지급 ROI ${fmt(paid)} 자동 보정 완료`,'success');
    if(currentView==='dashboard') renderDashboard();
  }
}
async function autoSettleAll(label){
  // 승인된 투자 회원만 자동 정산 (주 5일 월~금 자동 실행)
  const allUsers=await dbGetAll('users');
  let count=0, totalAmt=0;
  for(const u of allUsers){
    if(u.role!=='member') continue;
    if(u.approvalStatus!=='approved') continue; // 미승인 제외
    if(u.suspended) continue;                   // 정지 회원 제외
    if(!u.investment||u.investment<=0) continue;// 미투자 제외
    const paid=await processUserRoi(u.id);
    if(paid>0){ count++; totalAmt+=paid; }
  }
  // 정산 로그 저장
  const runTime=new Date().toLocaleString('ko-KR');
  await dbPut('settings',{key:'__scheduler__',value:{lastRun:localDateStr(new Date()),runTime,count,totalAmt,ts:Date.now()}});
  console.log(`[자동정산 ${label}] ${runTime} — ${count}명 / ${fmt(totalAmt)} 지급 완료`);
  if(count>0){
    if(currentUser&&currentUser.role!=='admin'&&currentUser.investment>0){
      const myPayout=Math.round(currentUser.investment*CFG.DAILY_ROI);
      toast(`💰 오늘의 ROI ${fmt(myPayout)}이 지급되었습니다!`,'success');
      if(currentView==='dashboard') renderDashboard();
    }
    if(currentUser&&currentUser.role==='admin'){
      toast(`✅ 자동 정산 완료 — ${count}명 / ${fmt(totalAmt)}`, 'success');
      renderAdmin();
    }
  }
}
let _schedulerTimer=null;

function startScheduler(){
  // 정확히 다음날 00:00:01에 실행되도록 setTimeout 계산
  scheduleNextRun();
  updateNextRoiTimer();
}

function scheduleNextRun(){
  if(_schedulerTimer) clearTimeout(_schedulerTimer);
  const now=new Date();
  // 다음날 00:00:01 계산
  const next=new Date(now);
  next.setDate(next.getDate()+1);
  next.setHours(0,0,1,0); // 오전 12시 00분 01초
  const msUntilNext=next-now;
  console.log(`[Scheduler] 다음 정산 예정: ${next.toLocaleString('ko-KR')} (${Math.round(msUntilNext/1000)}초 후)`);
  _schedulerTimer=setTimeout(async()=>{
    const now2=new Date();
    const today=localDateStr(now2);
    const dow=now2.getDay();
    console.log(`[Scheduler] ${today} 자정 정산 실행 (요일:${dow})`);
    if(dow>=1&&dow<=5){
      // 월~금: 정산 실행
      await autoSettleAll(today);
    } else {
      // 토/일: 정산 없음 — 로그만
      console.log(`[Scheduler] 주말(${today}) — 배당 없음`);
    }
    updateNextRoiTimer();
    scheduleNextRun(); // 다음날 예약 재설정
  }, msUntilNext);
}
let _timerInterval=null;
function updateNextRoiTimer(){
  if(_timerInterval) clearInterval(_timerInterval);
  _timerInterval=setInterval(()=>{
    const el=document.getElementById('next-roi-timer'); if(!el)return;
    const now=new Date(); const dow=now.getDay();
    // 다음 정산일 계산 (항상 내일 00:00:01)
    let daysAhead=1;
    if(dow===5) daysAhead=3;      // 금요일 → 월요일
    else if(dow===6) daysAhead=2; // 토요일 → 월요일
    const next=new Date(now);
    next.setDate(next.getDate()+daysAhead);
    next.setHours(0,0,1,0); // 00:00:01
    const diff=Math.max(0,next-now);
    const h=String(Math.floor(diff/3600000)).padStart(2,'0');
    const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
    const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    const dayNames=['일','월','화','수','목','금','토'];
    const targetDow=(dow+daysAhead)%7;
    const dayLabel=daysAhead===1?'내일':dayNames[targetDow]+'요일';
    el.textContent=`다음 배당 (${dayLabel} 오전 12시 01초) — ${h}:${m}:${s}`;
  },1000);
}

// ═══════════════════════════════════════════════════════
//  INIT
// ═══════════════════════════════════════════════════════
async function init(){
  // 로딩 표시
  document.body.insertAdjacentHTML('beforeend',`
    <div id="fb-loading" style="position:fixed;inset:0;background:#07080d;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:20px;text-align:center;">
      <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:#d4a853;margin-bottom:20px;letter-spacing:2px;">MEDI WORLD</div>
      <div id="fb-spinner" style="width:44px;height:44px;border:3px solid rgba(212,168,83,0.2);border-top-color:#d4a853;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
      <div id="fb-status" style="margin-top:18px;font-size:16px;color:#6b7280;">서버에 연결하는 중입니다...</div>
      <button id="fb-retry-btn" onclick="location.reload()" style="display:none;margin-top:22px;padding:14px 32px;background:#d4a853;color:#07080d;border:none;border-radius:12px;font-size:16px;font-weight:800;cursor:pointer;min-height:52px;">&#128260; 다시 시도</button>
    </div>
  `);
  try{
    await initDB();
    await loadSettings();
    await seedIfEmpty();
  }catch(e){
    console.error('초기화 오류:', e);
    const st=document.getElementById('fb-status');
    const sp=document.getElementById('fb-spinner');
    const rb=document.getElementById('fb-retry-btn');
    if(st){st.textContent='연결 실패. 인터넷 연결을 확인해 주세요.';st.style.color='#f05d5d';}
    if(sp) sp.style.display='none';
    if(rb) rb.style.display='block';
    return;
  }
  document.getElementById('fb-loading').remove();
  startScheduler();
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='none';});
  document.getElementById('page-login').style.display='flex';
  document.getElementById('page-login').classList.add('active');
  console.log('[MEDI WORLD v5.0] Firebase 연결 완료 ✅');
}
init();
</script>
</body>
</html>
