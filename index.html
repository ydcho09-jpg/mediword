<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<!-- â˜… ë³´ì•ˆ í—¤ë” â˜… -->
<meta http-equiv="X-XSS-Protection" content="1; mode=block">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="X-Frame-Options" content="DENY">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
<title>MEDI WORLD v5.0</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-Avb2QiuTy/Sz4uFZAAAAAd1+K5R+EUGvKB5BRFGRKpXB0AFrpfEXW0tn7gNHlxPTFQPAhrgzQAK5GFCtyGnhw==" crossorigin="anonymous" referrerpolicy="no-referrer">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js" integrity="sha512-ZwR1/gSZM3ai6vCdI+LVF1zSq/5HznD3oD+sCoJrzXJ+yKiwusmDXjJh4moNgseTBMFPuOR/KSHhG5R0WgTkw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKnH4rJT6WPAzaBFIBeLs2UjgO3pV0EpKKxDnVXZEHWw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Firebase SDK -->
<script type="module">
// â˜…â˜…â˜… ì—¬ê¸°ì— Firebase ì„¤ì •ê°’ì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” â˜…â˜…â˜…
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, getDoc, getDocs, getDocFromServer, getDocsFromServer, setDoc, deleteDoc, collection, query, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// âš ï¸  ë³´ì•ˆ ì•ˆë‚´: Firebase API í‚¤ëŠ” í´ë¼ì´ì–¸íŠ¸ì— ë…¸ì¶œë©ë‹ˆë‹¤.
//    ë°˜ë“œì‹œ Firebase Consoleì—ì„œ ì•„ë˜ ì„¤ì •ì„ ì™„ë£Œí•˜ì„¸ìš”:
//    1) Authentication â†’ Sign-in method â†’ [ìµëª…(Anonymous)] â†’ ì‚¬ìš© ì„¤ì • âœ… (í•„ìˆ˜!)
//    2) Firestore â†’ Rules â†’ ì•„ë˜ ê·œì¹™ìœ¼ë¡œ êµì²´ í›„ ê²Œì‹œ:
//       rules_version = '2';
//       service cloud.firestore {
//         match /databases/{database}/documents {
//           match /{document=**} {
//             allow read, write: if request.auth != null;
//           }
//         }
//       }
//    3) Google Cloud Console â†’ API ì œí•œ â†’ í—ˆìš© ë„ë©”ì¸ ì„¤ì •
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const firebaseConfig = {
  apiKey: "AIzaSyCFFqFk55POE0wrUyLpbyywQrcDnUki0jE",
  authDomain: "mediworld-51f0f.firebaseapp.com",
  projectId: "mediworld-51f0f",
  storageBucket: "mediworld-51f0f.firebasestorage.app",
  messagingSenderId: "344675244828",
  appId: "1:344675244828:web:451af0cc5d9692e543b8d9"
};

const app = initializeApp(firebaseConfig);
const fsdb = getFirestore(app);

// â”€â”€ Firestore DB í•¨ìˆ˜ (ê¸°ì¡´ IndexedDB í•¨ìˆ˜ë¥¼ ë®ì–´ì”ë‹ˆë‹¤) â”€â”€
window.fsdb = fsdb;
window.fsGet = async (col, id) => {
  // â˜… ìºì‹œ ìš°íšŒ: í•­ìƒ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ì½ê¸°
  try {
    const snap = await getDocFromServer(doc(fsdb, col, String(id)));
    return snap.exists() ? snap.data() : undefined;
  } catch(e) {
    const snap = await getDoc(doc(fsdb, col, String(id)));
    return snap.exists() ? snap.data() : undefined;
  }
};
window.fsGetAll = async (col) => {
  // â˜… ìºì‹œ ìš°íšŒ: í•­ìƒ ì„œë²„ì—ì„œ ìµœì‹  ë°ì´í„° ì½ê¸°
  try {
    const snap = await getDocsFromServer(collection(fsdb, col));
    return snap.docs.map(d => d.data());
  } catch(e) {
    // ì˜¤í”„ë¼ì¸ fallback
    const snap = await getDocs(collection(fsdb, col));
    return snap.docs.map(d => d.data());
  }
};
window.fsPut = async (col, obj) => {
  const key = obj.id !== undefined ? String(obj.id) : String(obj.key);
  await setDoc(doc(fsdb, col, key), obj);
};
window.fsDelete = async (col, id) => {
  await deleteDoc(doc(fsdb, col, String(id)));
};
window.fsAdd = async (col, obj) => {
  if(obj.id !== undefined){
    await setDoc(doc(fsdb, col, String(obj.id)), { ...obj });
  } else {
    await addDoc(collection(fsdb, col), { ...obj, _ts: serverTimestamp() });
  }
};
window.fsGetIndex = async (col, field, val) => {
  const q = query(collection(fsdb, col), where(field, '==', val));
  const snap = await getDocs(q);
  return snap.docs.map(d => d.data());
};

// â˜… Firebase Anonymous Auth - Firestore ê¶Œí•œ íšë“
const _fbAuth = getAuth(app);
window.firebaseReady = false;
signInAnonymously(_fbAuth)
  .then(() => {
    window.firebaseReady = true;
    console.log('[Firebase] ìµëª… ì¸ì¦ ì™„ë£Œ âœ…');
  })
  .catch((e) => {
    // Auth ì‹¤íŒ¨í•´ë„ Rulesê°€ publicì´ë©´ ë™ì‘í•˜ë„ë¡ fallback
    console.warn('[Firebase] ìµëª… ì¸ì¦ ì‹¤íŒ¨, Rules í™•ì¸ í•„ìš”:', e.message);
    window.firebaseReady = true;
  });
console.log('[Firebase] ì—°ê²° ì™„ë£Œ âœ…');
</script>
<style>
:root{
  --bg:#07080d;--bg2:#0d0f1a;--bg3:#131629;
  --surface:rgba(255,255,255,0.03);--border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --gold:#d4a853;--gold2:#f0c974;--gold-dim:rgba(212,168,83,0.15);
  --green:#3dd68c;--green-dim:rgba(61,214,140,0.12);
  --red:#f05d5d;--red-dim:rgba(240,93,93,0.12);
  --blue:#5b8dee;--blue-dim:rgba(91,141,238,0.12);
  --purple:#a78bfa;--purple-dim:rgba(167,139,250,0.12);
  --text:#ffffff;--text2:#c8cfe0;--text3:#8a94ac;
  --r:16px;--r2:24px;--r3:32px;
}
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:17px;line-height:1.75;font-weight:500;}
body::before{content:'';position:fixed;inset:0;
  background-image:linear-gradient(rgba(212,168,83,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(212,168,83,0.025) 1px,transparent 1px);
  background-size:60px 60px;pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;top:-30vh;left:50%;transform:translateX(-50%);
  width:80vw;height:80vh;background:radial-gradient(ellipse,rgba(212,168,83,0.05) 0%,transparent 65%);
  pointer-events:none;z-index:0;}
::-webkit-scrollbar{width:5px;}::-webkit-scrollbar-track{background:var(--bg);}::-webkit-scrollbar-thumb{background:var(--bg3);border-radius:10px;}
h1,h2,h3,.syne{font-family:'Syne',sans-serif;}
.mono{font-family:'Space Mono',monospace;}

/* â”€â”€ LAYOUT â”€â”€ */
#app{position:relative;z-index:1;}
.page{display:none;min-height:100vh;}
.page.active{display:block;}

/* TOPBAR */
#topbar{position:fixed;top:0;left:0;right:0;height:64px;background:rgba(7,8,13,0.93);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 28px;z-index:200;}
.topbar-logo{font-family:'Syne',sans-serif;font-weight:800;font-size:20px;letter-spacing:2px;color:var(--gold);cursor:pointer;}
.topbar-logo span{color:var(--text2);font-weight:400;}
.topbar-nav{display:flex;gap:2px;}
.nav-btn{background:none;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:600;
  color:var(--text2);padding:8px 16px;border-radius:10px;transition:all .2s;letter-spacing:.3px;}
.nav-btn:hover{color:var(--text);background:var(--surface);}
.nav-btn.active{color:var(--gold);background:var(--gold-dim);}
.topbar-right{display:flex;align-items:center;gap:12px;}
.user-chip{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:40px;padding:5px 14px 5px 5px;}
.user-avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--blue));
  display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:#000;font-family:'Syne',sans-serif;}
.user-name{font-size:15px;font-weight:600;color:var(--text);}
.btn-logout{background:var(--red-dim);border:1px solid rgba(240,93,93,0.2);color:var(--red);font-size:14px;font-weight:700;
  padding:8px 16px;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s;}
.btn-logout:hover{background:var(--red);color:#fff;}
.main{padding:88px 28px 48px;}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:24px;transition:border-color .2s;}
.card:hover{border-color:var(--border2);}
.card-sm{border-radius:var(--r);padding:18px;}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
.card-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--text2);letter-spacing:1px;text-transform:uppercase;}
.card-title-lg{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--text);}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r2);padding:22px 24px;}
.stat-label{font-size:14px;font-weight:700;color:var(--text2);letter-spacing:.5px;text-transform:uppercase;margin-bottom:10px;}
.stat-value{font-family:'Space Mono',monospace;font-size:30px;font-weight:700;color:var(--text);line-height:1;}
.stat-sub{font-size:14px;color:var(--text2);margin-top:8px;font-weight:600;}
.stat-badge{display:inline-flex;align-items:center;gap:4px;font-size:15px;font-weight:700;padding:3px 9px;border-radius:20px;font-family:'Space Mono',monospace;}
.badge-up{background:var(--green-dim);color:var(--green);}
.badge-down{background:var(--red-dim);color:var(--red);}
.badge-gold{background:var(--gold-dim);color:var(--gold);}
.badge-blue{background:var(--blue-dim);color:var(--blue);}
.badge-purple{background:var(--purple-dim);color:var(--purple);}
.badge-pend{background:rgba(212,168,83,0.15);color:var(--gold);}
.card-gold{border-left:3px solid var(--gold);}
.card-green{border-left:3px solid var(--green);}
.card-blue{border-left:3px solid var(--blue);}
.card-red{border-left:3px solid var(--red);}
.card-purple{border-left:3px solid var(--purple);}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:none;cursor:pointer;
  font-family:'DM Sans',sans-serif;font-weight:700;font-size:16px;border-radius:var(--r);padding:14px 26px;transition:all .2s;letter-spacing:.3px;}
.btn:active{transform:scale(0.97);}
.btn-primary{background:var(--gold);color:#0a0800;}
.btn-primary:hover{background:var(--gold2);}
.btn-secondary{background:var(--surface);border:1px solid var(--border2);color:var(--text);}
.btn-secondary:hover{border-color:var(--border2);background:var(--bg3);}
.btn-success{background:var(--green-dim);border:1px solid rgba(61,214,140,0.25);color:var(--green);}
.btn-success:hover{background:var(--green);color:#000;}
.btn-danger{background:var(--red-dim);border:1px solid rgba(240,93,93,0.25);color:var(--red);}
.btn-warning{background:#e67e22;border-color:#d35400;color:#fff;}
.btn-danger:hover{background:var(--red);color:#fff;}
.btn-purple{background:var(--purple-dim);border:1px solid rgba(167,139,250,0.25);color:var(--purple);}
.btn-purple:hover{background:var(--purple);color:#fff;}
.btn-sm{padding:9px 18px;font-size:15px;border-radius:10px;font-weight:700;}
.btn-lg{padding:18px 36px;font-size:18px;border-radius:18px;}
.btn-full{width:100%;}
.btn-icon{padding:10px;border-radius:10px;width:42px;height:42px;}
.btn:disabled{opacity:0.4;cursor:not-allowed;}

/* â”€â”€ FORMS â”€â”€ */
.form-group{margin-bottom:20px;}
.form-label{display:block;font-size:16px;font-weight:700;color:var(--text);margin-bottom:9px;letter-spacing:.3px;}
.form-input{width:100%;background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);
  padding:15px 18px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:17px;font-weight:500;outline:none;transition:all .2s;}
.form-input:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(212,168,83,0.15);}
.form-input::placeholder{color:var(--text3);}
.form-input.error{border-color:var(--red);}
.form-select{appearance:none;cursor:pointer;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%234a5068' stroke-width='1.5' fill='none'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 14px center;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-hint{font-size:14px;color:var(--text3);margin-top:6px;}
.form-error{font-size:14px;color:var(--red);margin-top:6px;font-weight:600;}

/* â”€â”€ TABLES â”€â”€ */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead tr{border-bottom:1px solid var(--border);}
th{font-size:13px;font-weight:800;color:var(--text2);letter-spacing:.8px;text-transform:uppercase;padding:12px 16px;text-align:left;}
td{padding:15px 16px;font-size:16px;border-bottom:1px solid var(--border);color:var(--text);}
tr:hover td{background:var(--surface);}
tr:last-child td{border-bottom:none;}
.td-amount{font-family:'Space Mono',monospace;color:var(--text);font-weight:700;}

/* STATUS */
.status{display:inline-flex;align-items:center;gap:5px;font-size:15px;font-weight:700;letter-spacing:.5px;padding:4px 10px;border-radius:20px;text-transform:uppercase;}
.status::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}
.status-done{background:var(--green-dim);color:var(--green);}
.status-pend{background:var(--gold-dim);color:var(--gold);}
.status-fail{background:var(--red-dim);color:var(--red);}
.status-stop{background:rgba(74,80,104,0.3);color:var(--text3);}

/* â”€â”€ TABS â”€â”€ */
.tabs{display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:24px;overflow-x:auto;}
.tab{background:none;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:15px;font-weight:700;
  color:var(--text2);padding:12px 22px;border-bottom:2px solid transparent;letter-spacing:.2px;transition:all .2s;white-space:nowrap;}
.tab:hover{color:var(--text);}
.tab.active{color:var(--gold);border-bottom-color:var(--gold);}

/* PROGRESS */
.progress-bar{height:6px;background:var(--bg3);border-radius:10px;overflow:hidden;}
.progress-fill{height:100%;border-radius:10px;transition:width .8s ease;}
.fill-gold{background:linear-gradient(90deg,var(--gold),var(--gold2));}
.fill-green{background:var(--green);}
.fill-blue{background:var(--blue);}
.fill-red{background:var(--red);}

/* ALERTS */
.alert{display:flex;align-items:flex-start;gap:10px;padding:14px 18px;border-radius:12px;font-size:16px;line-height:1.6;font-weight:500;}
.alert-info{background:var(--blue-dim);border:1px solid rgba(91,141,238,0.2);color:var(--blue);}
.alert-warning{background:var(--gold-dim);border:1px solid rgba(212,168,83,0.25);color:var(--gold);}
.alert-success{background:var(--green-dim);border:1px solid rgba(61,214,140,0.2);color:var(--green);}
.alert-danger{background:var(--red-dim);border:1px solid rgba(240,93,93,0.2);color:var(--red);}

/* GRID */
.dash-grid{display:grid;gap:20px;}
.dash-row-4{grid-template-columns:repeat(4,1fr);}
.dash-row-3{grid-template-columns:repeat(3,1fr);}
.dash-row-2{grid-template-columns:1fr 1fr;}
.dash-row-main{grid-template-columns:2fr 1fr;}
.page-header{display:flex;align-items:flex-end;justify-content:space-between;margin-bottom:28px;}
.page-title{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;}
.page-title span{color:var(--gold);}
.page-subtitle{font-size:16px;color:var(--text2);margin-top:5px;font-weight:600;}

/* ROI RING */
.roi-ring-wrap{display:flex;align-items:center;gap:28px;}
.roi-ring{position:relative;width:110px;height:110px;flex-shrink:0;}
.roi-ring canvas{position:absolute;inset:0;}
.roi-ring-text{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.roi-pct{font-family:'Space Mono',monospace;font-size:20px;font-weight:700;color:var(--gold);}
.roi-label{font-size:9px;color:var(--text3);letter-spacing:.5px;text-transform:uppercase;margin-top:2px;}

/* TREE */
.tree-node{background:var(--bg3);border:1px solid var(--border);border-radius:14px;padding:12px 16px;min-width:150px;position:relative;}
.tree-node.self{border-color:var(--gold);background:var(--gold-dim);}
.tree-node.suspended{border-color:var(--red);opacity:0.6;}
.tree-node-name{font-size:16px;font-weight:700;color:var(--text);}
.tree-node-id{font-size:15px;color:var(--text3);font-family:'Space Mono',monospace;margin-top:2px;}
.tree-node-amount{font-family:'Space Mono',monospace;font-size:14px;color:var(--gold);margin-top:5px;}

/* NETWORK CARD */
.net-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);padding:16px;display:flex;gap:14px;align-items:flex-start;}
.net-avatar{width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,var(--gold-dim),var(--blue-dim));
  display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:700;color:var(--gold);flex-shrink:0;}
.net-name{font-size:17px;font-weight:700;}
.net-id{font-size:14px;color:var(--text2);font-family:'Space Mono',monospace;margin-top:3px;font-weight:500;}
.net-meta{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
.net-meta-item{font-size:14px;color:var(--text3);background:var(--surface);border:1px solid var(--border);padding:3px 8px;border-radius:20px;}

/* STEP */
.step-indicator{display:flex;align-items:center;gap:0;margin-bottom:28px;}
.step-item{display:flex;align-items:center;gap:8px;flex:1;}
.step-circle{width:28px;height:28px;border-radius:50%;border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:var(--text3);flex-shrink:0;}
.step-item.active .step-circle{border-color:var(--gold);color:var(--gold);}
.step-item.done .step-circle{background:var(--gold);border-color:var(--gold);color:#000;}
.step-label{font-size:14px;color:var(--text3);font-weight:500;}
.step-item.active .step-label{color:var(--gold);}
.step-line{flex:1;height:1px;background:var(--border);margin:0 8px;}

/* COIN DOT */
.coin-dot{display:inline-block;width:7px;height:7px;border-radius:50%;background:var(--green);
  animation:pulse 2s infinite;margin-right:4px;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}
@keyframes spin{to{transform:rotate(360deg)}}

/* RANK BADGE */
.rank-badge{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:20px;font-size:14px;font-weight:700;letter-spacing:.3px;}
.rank-1{background:rgba(212,168,83,0.15);border:1px solid rgba(212,168,83,0.3);color:var(--gold);}
.rank-2{background:rgba(61,214,140,0.12);border:1px solid rgba(61,214,140,0.25);color:var(--green);}
.rank-3{background:rgba(91,141,238,0.12);border:1px solid rgba(91,141,238,0.25);color:var(--blue);}
.rank-4{background:rgba(167,139,250,0.12);border:1px solid rgba(167,139,250,0.25);color:var(--purple);}
.rank-5{background:rgba(240,93,93,0.12);border:1px solid rgba(240,93,93,0.25);color:var(--red);}
.rank-0{background:var(--surface);border:1px solid var(--border);color:var(--text3);}

/* TOAST */
#toast-container{position:fixed;bottom:28px;right:28px;display:flex;flex-direction:column;gap:10px;z-index:9999;}
.toast{display:flex;align-items:center;gap:12px;background:var(--bg3);border:1px solid var(--border);
  border-radius:14px;padding:14px 18px;font-size:15px;min-width:260px;max-width:360px;
  box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:slideIn .3s ease;}
@keyframes slideIn{from{opacity:0;transform:translateX(20px);}to{opacity:1;transform:translateX(0);}}
@keyframes slideOut{from{opacity:1;}to{opacity:0;transform:translateX(20px);}}
.toast i{font-size:16px;flex-shrink:0;}
.toast-success{border-left:3px solid var(--green);}.toast-success i{color:var(--green);}
.toast-error{border-left:3px solid var(--red);}.toast-error i{color:var(--red);}
.toast-info{border-left:3px solid var(--blue);}.toast-info i{color:var(--blue);}
.toast-warning{border-left:3px solid var(--gold);}.toast-warning i{color:var(--gold);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.78);backdrop-filter:blur(6px);
  display:flex;align-items:center;justify-content:center;z-index:500;padding:20px;}
.modal-overlay.hidden{display:none;}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:var(--r3);padding:32px;
  min-width:340px;max-width:520px;width:100%;box-shadow:0 40px 80px rgba(0,0,0,0.6);}
.modal-title{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:10px;}
.modal-sub{font-size:15px;color:var(--text2);line-height:1.6;margin-bottom:24px;}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;}
.modal-body-html{font-size:15px;color:var(--text2);line-height:1.7;margin-bottom:24px;}

/* LOGIN */
#page-login{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
.login-wrap{display:grid;grid-template-columns:1fr 1fr;max-width:920px;width:100%;
  background:var(--bg2);border:1px solid var(--border);border-radius:32px;overflow:hidden;
  box-shadow:0 40px 80px rgba(0,0,0,0.6);}
.login-left{background:var(--bg3);padding:60px 50px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden;}
.login-left::before{content:'';position:absolute;top:-50px;right:-50px;width:200px;height:200px;border:1px solid var(--border);border-radius:50%;opacity:.5;}
.login-left::after{content:'';position:absolute;bottom:-80px;left:-30px;width:250px;height:250px;border:1px solid var(--border);border-radius:50%;opacity:.3;}
.login-brand{position:relative;z-index:1;}
.login-brand-name{font-family:'Syne',sans-serif;font-weight:800;font-size:36px;color:var(--gold);letter-spacing:3px;}
.login-brand-sub{font-size:15px;color:var(--text2);letter-spacing:2px;margin-top:8px;text-transform:uppercase;font-weight:600;}
.login-stats{position:relative;z-index:1;display:grid;gap:14px;}
.login-stat{background:rgba(255,255,255,0.04);border:1px solid var(--border2);border-radius:14px;padding:18px 22px;}
.login-stat-label{font-size:15px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;font-weight:600;}
.login-stat-value{font-family:'Space Mono',monospace;font-size:22px;color:var(--gold);font-weight:700;}
.login-right{padding:60px 50px;}
.login-title{font-family:'Syne',sans-serif;font-size:27px;font-weight:800;margin-bottom:8px;color:var(--text);}
.login-sub{font-size:16px;color:var(--text2);margin-bottom:32px;font-weight:500;}
.login-tabs{display:flex;gap:0;margin-bottom:28px;background:var(--bg3);border-radius:12px;padding:4px;}
.login-tab{flex:1;background:none;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:16px;font-weight:700;
  color:var(--text2);padding:11px;border-radius:9px;transition:all .2s;}
.login-tab.active{background:var(--bg2);color:var(--gold);box-shadow:0 2px 8px rgba(0,0,0,0.3);}
.login-form-section{display:none;}
.login-form-section.active{display:block;}
.divider{display:flex;align-items:center;gap:12px;font-size:14px;color:var(--text3);margin:16px 0;}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:var(--border);}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;gap:12px;color:var(--text3);}
.empty i{font-size:28px;opacity:.4;}
.empty p{font-size:15px;}

/* ADMIN OVERRIDE PANEL */
.override-panel{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--r);padding:18px;margin-bottom:16px;}
.override-row{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.override-row:last-child{margin-bottom:0;}
.override-label{font-size:14px;color:var(--text2);flex:1;font-weight:500;}
.override-input{width:90px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;
  padding:7px 10px;color:var(--text);font-family:'Space Mono',monospace;font-size:15px;text-align:right;outline:none;}
.override-input:focus{border-color:var(--gold);}
.override-unit{font-size:14px;color:var(--text3);width:24px;}

/* SUSPENDED BANNER */
.suspended-banner{background:var(--red-dim);border:1px solid rgba(240,93,93,0.3);border-radius:var(--r);
  padding:16px 20px;display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.suspended-banner i{color:var(--red);font-size:18px;}

/* RANK PROGRESS */
.rank-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);}
.rank-row:last-child{border-bottom:none;}

/* RESPONSIVE */
/* â”€â”€ ë…¸ì¸/ëª¨ë°”ì¼ ê°€ë…ì„± ê°•í™” â”€â”€ */
body{font-size:16px;line-height:1.7;}
.nav-btn{font-size:14px !important;padding:8px 16px !important;}
.user-name{font-size:14px !important;font-weight:600 !important;}
.btn-logout{font-size:15px !important;}
.card-title{font-size:14px !important;}
.card-title-lg{font-size:19px !important;}
.stat-label{font-size:15px !important;font-weight:700 !important;}
.stat-value{font-size:28px !important;}
.stat-sub{font-size:15px !important;}
.btn{font-size:15px !important;padding:13px 24px !important;}
.btn-sm{font-size:14px !important;padding:9px 16px !important;border-radius:10px !important;}
.btn-lg{font-size:17px !important;padding:17px 34px !important;}
.form-label{font-size:14px !important;font-weight:700 !important;margin-bottom:8px !important;}
.form-input{font-size:16px !important;padding:13px 18px !important;}
.form-hint{font-size:14px !important;}
.tab{font-size:14px !important;padding:12px 20px !important;}
th{font-size:14px !important;padding:12px 16px !important;}
td{font-size:14px !important;padding:14px 16px !important;}
.status{font-size:14px !important;padding:5px 12px !important;}
.page-title{font-size:26px !important;}
.page-subtitle{font-size:14px !important;}
.tree-node-name{font-size:15px !important;}
.net-name{font-size:16px !important;}
.net-id{font-size:15px !important;}
.net-meta-item{font-size:15px !important;}
.alert{font-size:14px !important;padding:14px 18px !important;}
/* í…ìŠ¤íŠ¸ ë°ê¸° ê°•í™” */
--text:#f0f2fa;
--text2:#aab0c4;
--text3:#6b7280;


/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“± MOBILE-FIRST RESPONSIVE DESIGN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ í•˜ë‹¨ íƒ­ë°” (ëª¨ë°”ì¼ ì•± ë„¤ë¹„ê²Œì´ì…˜) â”€â”€ */
#bottom-nav{
  display:none;
  position:fixed;bottom:0;left:0;right:0;
  height:68px;
  background:rgba(10,11,18,0.97);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--border);
  z-index:300;
  padding-bottom:env(safe-area-inset-bottom);
}
#bottom-nav-inner{
  display:flex;align-items:stretch;
  height:100%;padding:0 4px;
}
.bnav-btn{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;background:none;border:none;cursor:pointer;
  color:var(--text3);font-family:'DM Sans',sans-serif;
  font-size:10px;font-weight:600;letter-spacing:.3px;
  padding:6px 2px 4px;border-radius:12px;
  transition:color .15s,background .15s;
  -webkit-tap-highlight-color:transparent;
  position:relative;
}
.bnav-btn i{ font-size:20px;transition:transform .2s; }
.bnav-btn.active{ color:var(--gold); }
.bnav-btn.active i{ transform:translateY(-2px); }
.bnav-btn:active{ background:rgba(255,255,255,0.05); }
.bnav-badge{
  position:absolute;top:5px;right:calc(50% - 18px);
  background:var(--red);color:#fff;font-size:9px;font-weight:800;
  padding:1px 5px;border-radius:10px;min-width:16px;text-align:center;
  font-family:'Space Mono',monospace;
}

/* â”€â”€ ëª¨ë°”ì¼ í—¤ë” (topbar ëŒ€ì²´) â”€â”€ */
@media(max-width:768px){
  /* ë ˆì´ì•„ì›ƒ */
  .login-wrap{grid-template-columns:1fr !important;}
  .login-left{display:none !important;}
  .form-row{grid-template-columns:1fr !important;}
  .dash-row-4,.dash-row-3{grid-template-columns:1fr 1fr !important;}
  .dash-row-2{grid-template-columns:1fr !important;}
  .dash-row-main{grid-template-columns:1fr !important;}

  /* ìƒë‹¨ topbar ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
  #topbar{
    height:58px !important;
    padding:0 16px !important;
  }
  .topbar-nav{display:none !important;}
  .topbar-logo{font-size:17px !important;}
  .user-name{display:none !important;}
  .btn-logout{font-size:12px !important;padding:7px 11px !important;}
  .user-chip{padding:4px 10px 4px 4px !important;}
  .user-avatar{width:30px !important;height:30px !important;font-size:13px !important;}

  /* ë©”ì¸ ì»¨í…ì¸  íŒ¨ë”© - ìƒë‹¨ topbar + í•˜ë‹¨ íƒ­ë°” ê³ ë ¤ */
  .main{padding:70px 14px 84px !important;}

  /* í•˜ë‹¨ íƒ­ë°” í‘œì‹œ */
  #bottom-nav{display:block !important;}

  /* í˜ì´ì§€ í—¤ë” */
  .page-header{margin-bottom:18px !important;flex-wrap:wrap;gap:10px;}
  .page-title{font-size:22px !important;}
  .page-subtitle{font-size:13px !important;}

  /* ì¹´ë“œ */
  .card{padding:16px !important;border-radius:18px !important;}
  .card-title-lg{font-size:17px !important;}
  .card-title{font-size:12px !important;}
  .card-header{margin-bottom:14px !important;}

  /* í†µê³„ ì¹´ë“œ */
  .stat-card{padding:16px !important;border-radius:16px !important;}
  .stat-value{font-size:24px !important;}
  .stat-label{font-size:11px !important;margin-bottom:6px !important;}
  .stat-sub{font-size:12px !important;margin-top:6px !important;}

  /* ë²„íŠ¼ */
  .btn{font-size:14px !important;padding:12px 18px !important;min-height:46px !important;}
  .btn-sm{font-size:13px !important;padding:9px 14px !important;min-height:40px !important;}
  .btn-lg{font-size:16px !important;min-height:52px !important;padding:16px 28px !important;}

  /* íƒ­ */
  .tabs{gap:0;overflow-x:auto;-webkit-overflow-scrolling:touch;
    scrollbar-width:none;margin:0 -14px;padding:0 14px;}
  .tabs::-webkit-scrollbar{display:none;}
  .tab{font-size:12px !important;padding:10px 14px !important;min-height:44px !important;white-space:nowrap;}

  /* í…Œì´ë¸” - ê°€ë¡œ ìŠ¤í¬ë¡¤ */
  .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin:0 -16px;padding:0 16px;}
  th{font-size:11px !important;padding:10px 10px !important;}
  td{font-size:13px !important;padding:12px 10px !important;}

  /* í¼ */
  .form-input{font-size:16px !important;padding:13px 14px !important;min-height:50px !important;}
  .form-label{font-size:14px !important;margin-bottom:7px !important;}
  .form-group{margin-bottom:16px !important;}

  /* ëª¨ë‹¬ - í•˜ë‹¨ ì‹œíŠ¸ ìŠ¤íƒ€ì¼ */
  .modal-overlay{align-items:flex-end !important;}
  .modal{
    width:100% !important;max-width:100% !important;
    margin:0 !important;
    border-radius:24px 24px 0 0 !important;
    max-height:92vh !important;overflow-y:auto !important;
    padding-bottom:calc(20px + env(safe-area-inset-bottom)) !important;
  }

  /* ì•Œë¦¼ */
  .alert{font-size:14px !important;padding:12px 14px !important;}

  /* ìƒíƒœ ë°°ì§€ */
  .status{font-size:11px !important;padding:4px 8px !important;}

  /* í† ìŠ¤íŠ¸ - í•˜ë‹¨ íƒ­ë°” ìœ„ë¡œ */
  #toast-container{
    bottom:calc(76px + env(safe-area-inset-bottom)) !important;
    right:14px !important;left:14px !important;
  }
  .toast{font-size:14px !important;padding:12px 16px !important;width:100% !important;}

  /* ë„¤íŠ¸ì›Œí¬ ì¹´ë“œ */
  .net-name{font-size:15px !important;}
  .net-meta-item{font-size:12px !important;}

  /* í°íŠ¸ ìë™í™•ëŒ€ ë°©ì§€ */
  *{-webkit-text-size-adjust:100% !important;text-size-adjust:100% !important;}

  /* ë¡œê·¸ì¸ í˜ì´ì§€ */
  .login-right{padding:28px 20px !important;border-radius:0 !important;}
  .login-title{font-size:26px !important;}

  /* ìˆ˜ìµ ì§„í–‰ ë§ - ëª¨ë°”ì¼ ìµœì í™” */
  .roi-ring-wrap{flex-direction:column !important;align-items:center !important;gap:20px !important;}
  .roi-ring{width:130px !important;height:130px !important;}

  /* ì–´ë“œë¯¼ íƒ­ ìŠ¤í¬ë¡¤ */
  #admin-tabs{overflow-x:auto;scrollbar-width:none;margin:0 -14px;padding:0 14px;}
  #admin-tabs::-webkit-scrollbar{display:none;}
  #admin-tabs .tab{min-width:90px;font-size:11px !important;padding:10px 12px !important;}

  /* ì–´ë“œë¯¼ KPI 2ì—´ */
  #admin-kpi{grid-template-columns:1fr 1fr !important;}

  /* íˆ¬ì ìŠ¹ì¸ ì¹´ë“œ */
  [data-inv-id]{flex-direction:column !important;gap:12px !important;}
  [data-inv-id] > div:last-child{width:100%;display:flex;gap:8px;}
  [data-inv-id] > div:last-child .btn{flex:1;}

  /* ìŠ¤í… ì¸ë””ì¼€ì´í„° */
  .step-label{font-size:10px !important;}

  /* ì„¹ì…˜ í—¤ë” ì»´íŒ©íŠ¸ */
  .section-header{padding:16px !important;}
}

/* í„°ì¹˜ ë””ë°”ì´ìŠ¤ ê³µí†µ */
@media(hover:none) and (pointer:coarse){
  .btn{min-height:44px;}
  .btn-sm{min-height:40px;}
  .form-input{min-height:48px;}
  .tab{min-height:44px;}
  .nav-btn{min-height:44px;}
  /* í„°ì¹˜ í”¼ë“œë°± */
  .btn:active,.card:active{opacity:.85;}
}

/* ì´ˆì†Œí˜• í™”ë©´ */
@media(max-width:360px){
  .dash-row-4,.dash-row-3{grid-template-columns:1fr !important;}
  .main{padding:66px 12px 80px !important;}
  .stat-value{font-size:20px !important;}
  .bnav-btn{font-size:9px;}
  .bnav-btn i{font-size:18px;}
}

/* ë°ìŠ¤í¬íƒ‘ - í•˜ë‹¨ íƒ­ë°” ìˆ¨ê¹€ */
@media(min-width:769px){
  #bottom-nav{display:none !important;}
  .main{padding:88px 28px 48px;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ“± EXTRA MOBILE UI COMPONENTS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* ëª¨ë°”ì¼ Pull-to-refresh íŒíŠ¸ */
@media(max-width:768px){
  /* ëŒ€ì‹œë³´ë“œ KPI ì¹´ë“œ - 2ì—´ ê· ë“± */
  #dash-kpi .stat-card{min-height:90px;}

  /* ì¹´ë“œ ë‚´ ë²„íŠ¼ë“¤ í’€ ë„ˆë¹„ */
  .card .btn-full{min-height:50px !important;}

  /* ë„¤íŠ¸ì›Œí¬ íŠ¸ë¦¬ ëª¨ë°”ì¼ */
  .net-tree{overflow-x:auto;-webkit-overflow-scrolling:touch;}

  /* ì¶œê¸ˆ í¼ ëª¨ë°”ì¼ */
  #page-wallet .main > .card{margin-bottom:12px;}

  /* ëª¨ë‹¬ ìƒë‹¨ í•¸ë“¤ í‘œì‹œ */
  .modal::before{
    content:'';display:block;
    width:40px;height:4px;
    background:var(--border2);border-radius:2px;
    margin:0 auto 16px;
  }

  /* ì–´ë“œë¯¼ íƒ­ ë±ƒì§€ */
  .stat-badge{font-size:10px !important;padding:2px 6px !important;}

  /* í…Œì´ë¸” ì…€ ì¤„ë°”ê¿ˆ í—ˆìš© */
  td{word-break:break-word;}

  /* ê±°ë˜ë‚´ì—­ í…Œì´ë¸” desc ì»¬ëŸ¼ ìˆ¨ê¸°ê¸° (ëª¨ë°”ì¼ì—ì„œ) */
  .tx-desc-col{display:none;}

  /* ë¡œê·¸ì¸ ë°•ìŠ¤ ì»´íŒ©íŠ¸ */
  .login-right{
    min-height:100vh;
    padding:env(safe-area-inset-top,20px) 20px 30px !important;
  }
  .login-title{margin-top:20px !important;}

  /* ì„¹ì…˜ ê°„ê²© */
  .page > .main > * + *{margin-top:0;}

  /* ë²„íŠ¼ ê·¸ë£¹ ëª¨ë°”ì¼ */
  .btn-group{flex-wrap:wrap !important;gap:8px !important;}
  .btn-group .btn{flex:1;min-width:120px;}

  /* ì–´ë“œë¯¼ ê±°ë˜ë¡œê·¸ ë²„íŠ¼ë“¤ */
  #admin-log-body td:last-child div{flex-wrap:wrap !important;gap:4px !important;}
  #admin-log-body td:last-child button{flex:1;min-width:60px;}

  /* íšŒì› ìƒì„¸ ëª¨ë‹¬ íƒ­ */
  #modal-member-detail .tabs{flex-wrap:nowrap;overflow-x:auto;}

  /* íˆ¬ì ì‹ ì²­ ìŠ¤í… */
  .step-indicator{overflow-x:auto;padding-bottom:8px;}
  .step-line{flex:0 0 20px !important;min-width:20px;}

  /* ROI ë§ ì»´íŒ©íŠ¸ */
  #roi-ring-canvas{width:100% !important;height:100% !important;}

  /* í”„ë¡œí•„ í˜ì´ì§€ */
  #page-profile .form-row{grid-template-columns:1fr !important;}

  /* ì¶œê¸ˆ ì •ë³´ ì¹´ë“œ */
  .wd-info-row{flex-direction:column !important;gap:4px !important;}
}

/* iOS Safe Area ëŒ€ì‘ */
@supports(padding-bottom: env(safe-area-inset-bottom)){
  #bottom-nav{
    padding-bottom:env(safe-area-inset-bottom);
    height:calc(68px + env(safe-area-inset-bottom));
  }
  @media(max-width:768px){
    .main{padding-bottom:calc(84px + env(safe-area-inset-bottom)) !important;}
  }
}

@media(max-width:768px){
  .mobile-back-btn{display:inline-flex !important;}
}
@media(min-width:769px){
  .mobile-back-btn{display:none !important;}
}
</style>
</head>
<body>
<div id="app">

<!-- â•â•â•â•â•â•â•â•â•â•â• LOGIN PAGE â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-login" class="page active" style="display:flex;">
  <div class="login-wrap">
    <div class="login-left">
      <div class="login-brand">
        <div class="login-brand-name">MEDI WORLD</div>
        <div class="login-brand-sub">Investment Platform v5.0</div>
        <div style="margin-top:20px;font-size:14px;color:var(--text3);line-height:1.8;">
          ë°”ì´ë„ˆë¦¬ êµ¬ì¡° ê¸°ë°˜<br>ìŠ¤ë§ˆíŠ¸ íˆ¬ì í”Œë«í¼
        </div>
      </div>
      <div class="login-stats">
        <div class="login-stat">
          <div class="login-stat-label">ì¼ì¼ ROI (ì£¼ 5ì¼)</div>
          <div class="login-stat-value">1.0%/ì¼</div>
        </div>
        <div class="login-stat">
          <div class="login-stat-label">ì§ì¶”ì²œ ìˆ˜ë‹¹</div>
          <div class="login-stat-value">5.0%</div>
        </div>
        <div class="login-stat">
          <div class="login-stat-label">ì†Œì‹¤ì  ìˆ˜ë‹¹ (2ëŒ€)</div>
          <div class="login-stat-value">3.0%</div>
        </div>
        <div class="login-stat">
          <div class="login-stat-label">ìµœëŒ€ ìˆ˜ìµ í•œë„</div>
          <div class="login-stat-value">300%</div>
        </div>
      </div>
    </div>
    <div class="login-right">
      <div class="login-title">ì•ˆë…•í•˜ì„¸ìš”</div>
      <div class="login-sub">ê³„ì •ì— ë¡œê·¸ì¸í•˜ê±°ë‚˜ ì¶”ì²œì½”ë“œë¡œ ê°€ì…í•˜ì„¸ìš”</div>
      <div class="login-tabs">
        <button class="login-tab active" onclick="switchLoginTab('login',this)">ë¡œê·¸ì¸</button>
        <button class="login-tab" onclick="switchLoginTab('register',this)">íšŒì›ê°€ì…</button>
      </div>

      <!-- LOGIN FORM -->
      <div id="lf-login" class="login-form-section active">
        <div class="form-group">
          <label class="form-label">ì•„ì´ë””</label>
          <input class="form-input" id="inp-lid" placeholder="ì•„ì´ë”” ì…ë ¥" autocomplete="username" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <div class="form-group">
          <label class="form-label">ë¹„ë°€ë²ˆí˜¸</label>
          <input class="form-input" type="password" id="inp-lpwd" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
        </div>
        <button class="btn btn-primary btn-full btn-lg" onclick="doLogin()" style="margin-top:4px;">
          <i class="fas fa-sign-in-alt"></i> ë¡œê·¸ì¸
        </button>

      </div>

      <!-- REGISTER FORM -->
      <div id="lf-register" class="login-form-section">
        <div class="alert alert-warning" style="margin-bottom:16px;">
          <i class="fas fa-key"></i>
          <div>ëˆ„êµ¬ë‚˜ ê°€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°€ì… í›„ <b>ê´€ë¦¬ì ìŠ¹ì¸</b>ì´ ì™„ë£Œë˜ë©´ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ì¶”ì²œì¸ ì½”ë“œê°€ ìˆìœ¼ë©´ ì…ë ¥í•˜ì„¸ìš” <span style="color:var(--text3);">(ì„ íƒì‚¬í•­)</span></div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì•„ì´ë”” *</label>
            <input class="form-input" id="inp-rid" placeholder="ì˜ë¬¸+ìˆ«ì, 4~20ì">
          </div>
          <div class="form-group">
            <label class="form-label">ì´ë¦„ *</label>
            <input class="form-input" id="inp-rname" placeholder="ì‹¤ëª… ì…ë ¥">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸ *</label>
            <input class="form-input" type="password" id="inp-rpwd" placeholder="8ì ì´ìƒ">
          </div>
          <div class="form-group">
            <label class="form-label">ë¹„ë°€ë²ˆí˜¸ í™•ì¸ *</label>
            <input class="form-input" type="password" id="inp-rpwd2" placeholder="ì¬ì…ë ¥">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ì´ë©”ì¼</label>
            <input class="form-input" type="email" id="inp-remail" placeholder="example@email.com">
          </div>
          <div class="form-group">
            <label class="form-label">ì—°ë½ì²˜</label>
            <input class="form-input" id="inp-rphone" placeholder="010-0000-0000">
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ì¶”ì²œì¸ ì½”ë“œ <span style="color:var(--text3);font-size:14px;">(ì„ íƒ)</span></label>
          <input class="form-input" id="inp-rref" placeholder="ì¶”ì²œì¸ ì•„ì´ë”” ì…ë ¥ (ì—†ìœ¼ë©´ ë¹„ì›Œë‘ì„¸ìš”)">
          <div class="form-hint">ì¶”ì²œì¸ ì½”ë“œê°€ ì—†ì–´ë„ ê°€ì…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
        </div>
        <button class="btn btn-primary btn-full" style="margin-top:4px;" onclick="doRegister()">
          <i class="fas fa-user-plus"></i> ê³„ì • ë§Œë“¤ê¸°
        </button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• TOPBAR â•â•â•â•â•â•â•â•â•â•â• -->
<nav id="topbar" style="display:none;">
  <div class="topbar-logo" onclick="goHome()">MEDI<span>WORLD</span></div>
  <div class="topbar-nav" id="topbar-nav"></div>
  <div class="topbar-right">
    <div class="user-chip">
      <div class="user-avatar" id="top-avatar"></div>
      <div class="user-name" id="top-name"></div>
    </div>
    <button class="btn-logout" onclick="doLogout()"><i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â• BOTTOM NAVIGATION (Mobile) â•â•â•â•â•â•â•â•â•â•â• -->
<div id="bottom-nav" style="display:none;">
  <div id="bottom-nav-inner"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-dashboard" class="page">
  <div class="main">
    <div class="page-header">
      <div>
        <div class="page-title">ëŒ€ì‹œë³´ë“œ <span>â€”</span></div>
        <div class="page-subtitle">íˆ¬ì í˜„í™© ë° ìˆ˜ìµ ìš”ì•½</div>
      </div>
      <button class="btn btn-primary btn-sm" onclick="goView('invest')"><i class="fas fa-plus"></i> íˆ¬ì ì‹ ì²­</button>
    </div>
    <div id="suspended-banner" style="display:none;" class="suspended-banner">
      <i class="fas fa-ban"></i>
      <div><b>ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</b> ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.</div>
    </div>
    <div class="dash-grid dash-row-4" style="margin-bottom:20px;" id="dash-kpi"></div>
    <div id="roi-timer-bar" style="display:flex;align-items:center;justify-content:space-between;
      background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--green);
      border-radius:var(--r);padding:12px 20px;margin-bottom:20px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span class="coin-dot"></span>
        <span style="font-size:14px;font-weight:600;color:var(--green);">ìë™ ROI ë°°ë‹¹ ê°€ë™ ì¤‘</span>
        <span style="font-size:14px;color:var(--text3);">â€” íˆ¬ì ìŠ¹ì¸ ìµì¼ë¶€í„° ì›”~ê¸ˆ ì£¼ 5ì¼ ìì • ì§€ê¸‰</span>
      </div>
      <div id="next-roi-timer" style="font-family:'Space Mono',monospace;font-size:14px;color:var(--text2);"></div>
    </div>
    <div class="dash-grid dash-row-main" style="margin-bottom:20px;">
      <div class="card card-gold">
        <div class="card-header">
          <div class="card-title">ìˆ˜ìµ ì§„í–‰ë„</div>
          <span class="stat-badge badge-gold">300% í•œë„</span>
        </div>
        <div class="roi-ring-wrap">
          <div class="roi-ring">
            <canvas id="roi-ring-canvas"></canvas>
            <div class="roi-ring-text">
              <div class="roi-pct" id="roi-pct-text">0%</div>
              <div class="roi-label">ë‹¬ì„±</div>
            </div>
          </div>
          <div style="flex:1;">
            <div style="font-size:14px;color:var(--text3);margin-bottom:12px;">ìˆ˜ìµ ì •ì‚° í˜„í™©</div>
            <div style="display:flex;flex-direction:column;gap:10px;">
              <div>
                <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                  <span style="font-size:14px;color:var(--text2);">ëˆ„ì  ë°°ë‹¹</span>
                  <span class="mono" style="font-size:14px;color:var(--gold);" id="dash-roi-now">â‚©0</span>
                </div>
                <div class="progress-bar"><div class="progress-fill fill-gold" id="dash-roi-bar" style="width:0%"></div></div>
              </div>
              <div style="display:flex;justify-content:space-between;">
                <span style="font-size:14px;color:var(--text2);">ëª©í‘œ (300%)</span>
                <span class="mono" style="font-size:14px;color:var(--text3);" id="dash-roi-max">â‚©0</span>
              </div>
              <div style="display:flex;justify-content:space-between;">
                <span style="font-size:14px;color:var(--text2);">ì”ì—¬ í•œë„</span>
                <span class="mono" style="font-size:14px;color:var(--green);" id="dash-roi-remain">â‚©0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div class="card card-green">
          <div class="card-title" style="margin-bottom:14px;">ì¶œê¸ˆ ê°€ëŠ¥ ì”ì•¡</div>
          <div class="mono" style="font-size:28px;color:var(--green);font-weight:700;" id="dash-wallet">â‚©0</div>
          <button class="btn btn-success btn-full btn-sm" style="margin-top:14px;" onclick="goView('wallet')">
            <i class="fas fa-paper-plane"></i> ì¶œê¸ˆ ì‹ ì²­
          </button>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:12px;">ì˜¤ëŠ˜ ì˜ˆìƒ ë°°ë‹¹</div>
          <div class="mono" style="font-size:22px;color:var(--blue);font-weight:700;" id="dash-today">â‚©0</div>
          <div style="font-size:14px;color:var(--text3);margin-top:6px;"><span class="coin-dot"></span>ì£¼ 5ì¼ ìš´ì˜</div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:10px;">ë‚´ ì§ê¸‰</div>
          <div id="dash-rank-badge"></div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-title-lg">ìµœê·¼ ê±°ë˜ ë‚´ì—­</div>
        <button class="btn btn-secondary btn-sm" onclick="goView('reports')">ì „ì²´ ë³´ê¸°</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ë‚ ì§œ</th><th>ìœ í˜•</th><th>ê¸ˆì•¡</th><th>ìƒíƒœ</th><th class="tx-desc-col">ì„¤ëª…</th></tr></thead>
          <tbody id="dash-tx-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• INVEST â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-invest" class="page">
  <div class="main">
    <div class="page-header">
      <div>
        <div class="page-title">íˆ¬ì <span>ì‹ ì²­</span></div>
        <div class="page-subtitle">ì›ê¸ˆì„ íˆ¬ìí•˜ê³  ì¼ì¼ ìˆ˜ìµì„ ì‹œì‘í•˜ì„¸ìš”</div>
      </div>
    </div>
    <div class="dash-grid dash-row-2">
      <div class="card">
        <div class="card-title-lg" style="margin-bottom:24px;">ì‹ ê·œ íˆ¬ì ì‹ ì²­</div>
        <div class="alert alert-warning" style="margin-bottom:16px;">
          <i class="fas fa-triangle-exclamation"></i>
          <div>ìµœì†Œ íˆ¬ìê¸ˆì•¡ <b>â‚©1,000,000</b> â€” ê´€ë¦¬ì ìŠ¹ì¸ í›„ ìµì¼ë¶€í„° ë°°ë‹¹ ì‹œì‘</div>
        </div>
        <div class="form-group">
          <label class="form-label">íˆ¬ì ê¸ˆì•¡ (ì›)</label>
          <input class="form-input mono" id="inp-invest-amount" type="number" placeholder="1000000" min="1000000" step="100000" oninput="calcSim()">
          <div class="form-hint">â‚©1,000,000 ì´ìƒ</div>
        </div>
        <div class="form-group">
          <label class="form-label">ì…ê¸ˆìëª…</label>
          <input class="form-input" id="inp-invest-name" placeholder="ì‹¤ì œ ì…ê¸ˆìëª… ì…ë ¥">
        </div>
        <div class="form-group">
          <label class="form-label">ë©”ëª¨ (ì„ íƒ)</label>
          <input class="form-input" id="inp-invest-memo" placeholder="íŠ¹ì´ì‚¬í•­ ê¸°ì¬">
        </div>
        <div class="card" style="background:var(--bg3);margin-bottom:20px;padding:16px;">
          <div style="font-size:14px;color:var(--text3);margin-bottom:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">ì…ê¸ˆ ê³„ì¢Œ ì •ë³´</div>
          <div id="deposit-account-info" style="display:flex;flex-direction:column;gap:8px;font-size:15px;"></div>
        </div>
        <button class="btn btn-primary btn-full" onclick="submitInvestment()">
          <i class="fas fa-coins"></i> íˆ¬ì ì‹ ì²­ì„œ ì œì¶œ
        </button>
        <div class="alert alert-info" style="margin-top:14px;">
          <i class="fas fa-circle-info"></i>
          <div>ì‹ ì²­ í›„ ê´€ë¦¬ì ìŠ¹ì¸ ì‹œ ìµì¼ë¶€í„° ë°°ë‹¹ì´ ì‹œì‘ë©ë‹ˆë‹¤. ì´ë¯¸ íˆ¬ì ì¤‘ì¸ ê²½ìš° ì¶”ê°€ íˆ¬ìë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="card card-gold">
          <div class="card-title" style="margin-bottom:16px;">ìˆ˜ìµ êµ¬ì¡°</div>
          <div style="display:flex;flex-direction:column;gap:0;">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
              <div><div style="font-size:15px;font-weight:600;">ì¼ì¼ ROI</div><div style="font-size:14px;color:var(--text3);">ì›”~ê¸ˆ ì£¼ 5ì¼</div></div>
              <span class="stat-badge badge-gold">+1.0%/ì¼</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
              <div><div style="font-size:15px;font-weight:600;">ì†Œì‹¤ì  ìˆ˜ë‹¹ (3%)</div><div style="font-size:14px;color:var(--text3);">2ëŒ€ ì¶”ì²œì¸ íˆ¬ì ìŠ¹ì¸ ì‹œ ì¦‰ì‹œ</div></div>
              <span class="stat-badge badge-up">+5.0%</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid var(--border);">
              <div><div style="font-size:15px;font-weight:600;">ì†Œì‹¤ì  ìˆ˜ë‹¹ (2ëŒ€)</div><div style="font-size:14px;color:var(--text3);">2ëŒ€ ì¶”ì²œì¸ì—ê²Œ 3%</div></div>
              <span class="stat-badge badge-blue">+3.0%</span>
            </div>
            <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 0;">
              <div><div style="font-size:15px;font-weight:600;">ìµœëŒ€ ìˆ˜ìµ í•œë„</div><div style="font-size:14px;color:var(--text3);">300% ë„ë‹¬ ì‹œ ëª¨ë“  ìˆ˜ë‹¹ ì¤‘ë‹¨</div></div>
              <span class="stat-badge badge-gold">300%</span>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:14px;">ìˆ˜ìµ ì‹œë®¬ë ˆì´í„°</div>
          <div class="form-group">
            <label class="form-label">íˆ¬ì ì˜ˆì • ê¸ˆì•¡</label>
            <input class="form-input mono" id="sim-amount" type="number" placeholder="10000000" oninput="calcSimBox()">
          </div>
          <div id="sim-result" style="display:none;margin-top:4px;display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;justify-content:space-between;font-size:14px;"><span style="color:var(--text2);">ì¼ì¼ ìˆ˜ìµ</span><b class="mono" id="sim-daily" style="color:var(--gold);">â‚©0</b></div>
            <div style="display:flex;justify-content:space-between;font-size:14px;"><span style="color:var(--text2);">ì›” ìˆ˜ìµ (22ì¼)</span><b class="mono" id="sim-monthly">â‚©0</b></div>
            <div style="display:flex;justify-content:space-between;font-size:14px;"><span style="color:var(--text2);">ìµœëŒ€ ìˆ˜ìµ (300%)</span><b class="mono" id="sim-max" style="color:var(--green);">â‚©0</b></div>
            <div style="display:flex;justify-content:space-between;font-size:14px;"><span style="color:var(--text2);">ì›ê¸ˆ íšŒìˆ˜ ì˜ˆìƒì¼</span><b class="mono" id="sim-days">ì•½ 0ì¼</b></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:14px;">ë‚´ íˆ¬ì í˜„í™©</div>
          <div id="invest-current"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• NETWORK â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-network" class="page">
  <div class="main">
    <div class="page-header">
      <div><div class="page-title">ì¡°ì§ <span>ê´€ë¦¬</span></div><div class="page-subtitle">ë‚´ ì¶”ì²œ ë„¤íŠ¸ì›Œí¬ í˜„í™©</div></div>
      <div id="my-invite-code" class="stat-badge badge-gold" style="font-size:14px;padding:8px 14px;cursor:pointer;" onclick="copyInvite()">
        <i class="fas fa-copy"></i> ì´ˆëŒ€ì½”ë“œ ë³µì‚¬
      </div>
    </div>
    <div class="dash-grid dash-row-4" style="margin-bottom:20px;">
      <div class="stat-card card-blue"><div class="stat-label">ì§ì¶”ì²œ ìˆ˜</div><div class="stat-value" id="net-direct-cnt">0</div><div class="stat-sub">ëª…</div></div>
      <div class="stat-card card-gold"><div class="stat-label">LíŒ€ ì´íˆ¬ì</div><div class="stat-value mono" id="net-left-pt">â‚©0</div></div>
      <div class="stat-card card-green"><div class="stat-label">RíŒ€ ì´íˆ¬ì</div><div class="stat-value mono" id="net-right-pt">â‚©0</div></div>
      <div class="stat-card card-purple"><div class="stat-label">ì†Œë¼ì¸ ê¸°ì¤€</div><div class="stat-value mono" id="net-small-line">â‚©0</div></div>
    </div>
    <div class="card" style="margin-bottom:20px;">
      <div class="card-header"><div class="card-title-lg">ì§ê¸‰ í˜„í™©</div></div>
      <div id="rank-progress-section"></div>
    </div>
    <div class="card" style="margin-bottom:20px;">
      <div class="card-header"><div class="card-title-lg">ë„¤íŠ¸ì›Œí¬ íŠ¸ë¦¬</div></div>
      <div id="network-tree" style="overflow-x:auto;padding:20px 0;"></div>
    </div>
    <div class="card">
      <div class="card-header"><div class="card-title-lg">í•˜ìœ„ ì „ì²´ ëª©ë¡</div></div>
      <div id="downline-list" style="display:flex;flex-direction:column;gap:10px;"></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• WALLET â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-wallet" class="page">
  <div class="main">
    <div class="page-header">
      <div><div class="page-title">ìˆ˜ìµ <span>ì¶œê¸ˆ</span></div><div class="page-subtitle">ìˆ˜ìµê¸ˆì„ ì•ˆì „í•˜ê²Œ ì¶œê¸ˆí•˜ì„¸ìš”</div></div>
    </div>
    <div class="dash-grid dash-row-2">
      <div>
        <!-- STEP INDICATOR -->
        <div class="step-indicator">
          <div class="step-item" id="step1"><div class="step-circle">1</div><div class="step-label">ê¸ˆì•¡ ì…ë ¥</div></div>
          <div class="step-line"></div>
          <div class="step-item" id="step2"><div class="step-circle">2</div><div class="step-label">ê³„ì¢Œ í™•ì¸</div></div>
          <div class="step-line"></div>
          <div class="step-item" id="step3"><div class="step-circle">3</div><div class="step-label">ìµœì¢… í™•ì¸</div></div>
        </div>
        <!-- STEP 1 -->
        <div id="wd-step1" class="card">
          <div class="card-title-lg" style="margin-bottom:20px;">ì¶œê¸ˆ ê¸ˆì•¡ ì…ë ¥</div>
          <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:20px;">
            <div style="font-size:14px;color:var(--text3);margin-bottom:6px;">ì¶œê¸ˆ ê°€ëŠ¥ ì”ì•¡</div>
            <div class="mono" style="font-size:28px;font-weight:700;color:var(--green);" id="wd-balance">â‚©0</div>
          </div>
          <div class="form-group">
            <label class="form-label">ì¶œê¸ˆ ì‹ ì²­ì•¡ (ì›)</label>
            <input class="form-input mono" id="wd-amount" type="number" placeholder="ì¶œê¸ˆ ê¸ˆì•¡ ì…ë ¥" min="10000" oninput="calcWdFee()">
          </div>
          <div id="wd-fee-preview" style="display:none;background:var(--bg3);border-radius:var(--r);padding:16px;margin-bottom:16px;">
            <div style="display:flex;justify-content:space-between;font-size:15px;margin-bottom:8px;"><span style="color:var(--text2);">ì‹ ì²­ì•¡</span><b class="mono" id="wd-fee-req">â‚©0</b></div>
            <div style="display:flex;justify-content:space-between;font-size:15px;margin-bottom:8px;"><span style="color:var(--text2);">ìˆ˜ìˆ˜ë£Œ (5%)</span><b class="mono" style="color:var(--red);" id="wd-fee-fee">-â‚©0</b></div>
            <div style="border-top:1px solid var(--border);padding-top:8px;display:flex;justify-content:space-between;font-size:14px;"><span>ì‹¤ìˆ˜ë ¹ ì˜ˆìƒ</span><b class="mono" style="color:var(--green);" id="wd-fee-net">â‚©0</b></div>
          </div>
          <button class="btn btn-primary btn-full" onclick="wdNextStep(2)"><i class="fas fa-arrow-right"></i> ë‹¤ìŒ</button>
        </div>
        <!-- STEP 2 -->
        <div id="wd-step2" class="card" style="display:none;">
          <div class="card-title-lg" style="margin-bottom:20px;">ê³„ì¢Œ ì •ë³´ í™•ì¸</div>
          <div id="wd-bank-info" style="display:flex;flex-direction:column;gap:8px;margin-bottom:20px;"></div>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-secondary" onclick="showWdStep(1)"><i class="fas fa-arrow-left"></i> ì´ì „</button>
            <button class="btn btn-primary btn-full" onclick="wdNextStep(3)">ë‹¤ìŒ <i class="fas fa-arrow-right"></i></button>
          </div>
        </div>
        <!-- STEP 3 -->
        <div id="wd-step3" class="card" style="display:none;">
          <div class="card-title-lg" style="margin-bottom:20px;">ìµœì¢… í™•ì¸</div>
          <div id="wd-final-summary" style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;"></div>
          <div class="alert alert-warning" style="margin-bottom:16px;">
            <i class="fas fa-triangle-exclamation"></i>
            <div>ì¶œê¸ˆ ì‹ ì²­ í›„ ê´€ë¦¬ì ìŠ¹ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ì˜ì—…ì¼ 1~2ì¼ ë‚´ ì²˜ë¦¬ë©ë‹ˆë‹¤.</div>
          </div>
          <div style="display:flex;gap:10px;">
            <button class="btn btn-secondary" onclick="showWdStep(2)"><i class="fas fa-arrow-left"></i> ì´ì „</button>
            <button class="btn btn-success btn-full" onclick="submitWithdrawal()"><i class="fas fa-paper-plane"></i> ì¶œê¸ˆ ì‹ ì²­ ì™„ë£Œ</button>
          </div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="card card-blue">
          <div class="card-title" style="margin-bottom:14px;">ê³„ì¢Œ ì •ë³´ ë“±ë¡</div>
          <div class="form-group">
            <label class="form-label">ì€í–‰ëª…</label>
            <input class="form-input" id="bank-name" placeholder="ì˜ˆ) êµ­ë¯¼ì€í–‰">
          </div>
          <div class="form-group">
            <label class="form-label">ì˜ˆê¸ˆì£¼</label>
            <input class="form-input" id="bank-holder" placeholder="ì˜ˆê¸ˆì£¼ëª…">
          </div>
          <div class="form-group">
            <label class="form-label">ê³„ì¢Œë²ˆí˜¸</label>
            <input class="form-input mono" id="bank-account" placeholder="000-0000-0000000">
          </div>
          <button class="btn btn-secondary btn-full btn-sm" onclick="updateBank()"><i class="fas fa-save"></i> ì €ì¥</button>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title-lg">ì¶œê¸ˆ ë‚´ì—­</div></div>
          <div id="wd-history-list" style="display:flex;flex-direction:column;gap:8px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• REPORTS â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-reports" class="page">
  <div class="main">
    <div class="page-header">
      <div style="display:flex;align-items:center;gap:12px;">
        <button class="btn btn-secondary btn-sm mobile-back-btn" onclick="goHome()" style="display:none;padding:8px 12px;"><i class="fas fa-arrow-left"></i></button>
        <div><div class="page-title">ê±°ë˜ <span>ë‚´ì—­</span></div><div class="page-subtitle">ëª¨ë“  ìˆ˜ìµ ë° ê±°ë˜ ê¸°ë¡</div></div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="exportReports()"><i class="fas fa-download"></i> CSV ë‹¤ìš´ë¡œë“œ</button>
    </div>
    <div class="dash-grid dash-row-3" style="margin-bottom:20px;" id="report-kpi"></div>
    <div class="card">
      <div id="report-tabs" class="tabs">
        <button class="tab active" onclick="filterReport('all',this)">ì „ì²´</button>
        <button class="tab" onclick="filterReport('roi',this)">ROI ë°°ë‹¹</button>
        <button class="tab" onclick="filterReport('bonus',this)">ì¶”ì²œìˆ˜ë‹¹</button>
        <button class="tab" onclick="filterReport('binary',this)">ë°”ì´ë„ˆë¦¬</button>
        <button class="tab" onclick="filterReport('rank',this)">ì§ê¸‰ìˆ˜ë‹¹</button>
        <button class="tab" onclick="filterReport('withdrawal',this)">ì¶œê¸ˆ</button>
        <button class="tab" onclick="filterReport('invest',this)">íˆ¬ì</button>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>ë‚ ì§œ</th><th>ìœ í˜•</th><th>ë‚´ìš©</th><th>ê¸ˆì•¡</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ì‹¤ìˆ˜ë ¹</th><th>ìƒíƒœ</th></tr></thead>
          <tbody id="report-table-body"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• PROFILE â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-profile" class="page">
  <div class="main">
    <div class="page-header">
      <div><div class="page-title">ë‚´ <span>ì •ë³´</span></div><div class="page-subtitle">ê³„ì • ì„¤ì • ë° ë³´ì•ˆ</div></div>
    </div>
    <div class="dash-grid dash-row-2">
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="card">
          <div class="card-title-lg" style="margin-bottom:20px;">ê¸°ë³¸ ì •ë³´</div>
          <div class="form-group"><label class="form-label">ì´ë¦„</label><input class="form-input" id="prof-name" placeholder="ì´ë¦„"></div>
          <div class="form-group"><label class="form-label">ì´ë©”ì¼</label><input class="form-input" type="email" id="prof-email" placeholder="ì´ë©”ì¼"></div>
          <div class="form-group"><label class="form-label">ì—°ë½ì²˜</label><input class="form-input" id="prof-phone" placeholder="ì—°ë½ì²˜"></div>
          <button class="btn btn-secondary btn-sm" onclick="saveProfile()"><i class="fas fa-save"></i> ì €ì¥</button>
        </div>
        <div class="card">
          <div class="card-title-lg" style="margin-bottom:20px;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
          <div class="form-group"><label class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label><input class="form-input" type="password" id="pw-current" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸"></div>
          <div class="form-group"><label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input class="form-input" type="password" id="pw-new" placeholder="8ì ì´ìƒ"></div>
          <div class="form-group"><label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label><input class="form-input" type="password" id="pw-confirm" placeholder="ì¬ì…ë ¥"></div>
          <button class="btn btn-primary btn-sm" onclick="changePassword()"><i class="fas fa-lock"></i> ë³€ê²½</button>
        </div>
      </div>
      <div class="card">
        <div class="card-title-lg" style="margin-bottom:20px;">ê³„ì • ì •ë³´</div>
        <div id="profile-info"></div>
        <div style="margin-top:20px;font-size:14px;color:var(--text3);">ë§ˆì§€ë§‰ ë¡œê·¸ì¸: <span id="prof-last-login">-</span></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• ADMIN â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-admin_dash" class="page">
  <div class="main">
    <!-- â˜… ë³´ì•ˆ ê²½ê³  ë°°ë„ˆ (ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ë¯¸ë³€ê²½ ì‹œ í‘œì‹œ) -->
    <div id="admin-pwd-warn" style="display:none;align-items:center;gap:12px;padding:14px 20px;margin-bottom:20px;
      background:rgba(240,93,93,0.12);border:1px solid rgba(240,93,93,0.35);border-left:4px solid var(--red);
      border-radius:var(--r);">
      <i class="fas fa-shield-halved" style="color:var(--red);font-size:20px;flex-shrink:0;"></i>
      <div style="flex:1;">
        <div style="font-weight:800;color:var(--red);font-size:16px;">âš ï¸ ë³´ì•ˆ ê²½ê³ : ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ë¥¼ ì¦‰ì‹œ ë³€ê²½í•˜ì„¸ìš”!</div>
        <div style="font-size:14px;color:var(--text2);margin-top:3px;">ê¸°ë³¸ ë¹„ë°€ë²ˆí˜¸(admin123!)ë¥¼ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. í•´í‚¹ ìœ„í—˜ì´ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ íƒ­ì—ì„œ ì¦‰ì‹œ ë³€ê²½í•´ ì£¼ì„¸ìš”.</div>
      </div>
    </div>
    <div class="page-header">
      <div><div class="page-title">ê´€ë¦¬ì <span>íŒ¨ë„</span></div><div class="page-subtitle">ì „ì²´ íšŒì› ë° ì‹œìŠ¤í…œ ê´€ë¦¬</div></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-success btn-sm" onclick="runSettlement()"><i class="fas fa-bolt"></i> ì „ì²´ ì •ì‚°</button>
        <button class="btn btn-secondary btn-sm" onclick="exportReports()"><i class="fas fa-download"></i> ê±°ë˜ CSV</button>
        <button class="btn btn-sm" onclick="exportMembersExcel()" style="background:var(--green);color:#000;font-weight:800;"><i class="fas fa-file-excel"></i> íšŒì› ì—‘ì…€</button>
      </div>
    </div>

    <!-- KPI -->
    <div class="dash-grid dash-row-4" style="margin-bottom:20px;" id="admin-kpi"></div>

    <!-- ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ -->
    <div class="card" style="margin-bottom:20px;" id="admin-pwd-section">
      <div class="card-header">
        <div class="card-title-lg">ğŸ”‘ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;align-items:end;">
        <div class="form-group" style="margin:0;">
          <label class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
          <input class="form-input" type="password" id="admin-pw-current" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ)</label>
          <input class="form-input" type="password" id="admin-pw-new" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
          <input class="form-input" type="password" id="admin-pw-confirm" placeholder="ì¬ì…ë ¥">
        </div>
      </div>
      <button class="btn btn-primary btn-sm" style="margin-top:14px;" onclick="changeAdminPassword()">
        <i class="fas fa-lock"></i> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
      </button>
    </div>

    <!-- ìˆ˜ë‹¹ ì„¤ì • íŒ¨ë„ -->
    <div class="card" style="margin-bottom:20px;border-color:rgba(212,168,83,0.3);">
      <div class="card-header">
        <div class="card-title-lg">âš™ï¸ ìˆ˜ë‹¹ ë¹„ìœ¨ ì‹¤ì‹œê°„ ì¡°ì •</div>
        <button class="btn btn-primary btn-sm" onclick="saveOverrides()"><i class="fas fa-save"></i> ì €ì¥ ì ìš©</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;">
        <div class="override-panel">
          <div style="font-size:14px;color:var(--text3);margin-bottom:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">ROI ë°°ë‹¹</div>
          <div class="override-row"><div class="override-label">ì¼ì¼ ROI (%)</div><input class="override-input" id="ov-roi" type="number" step="0.1" min="0" max="10"><div class="override-unit">%</div></div>
        </div>
        <div class="override-panel">
          <div style="font-size:14px;color:var(--text3);margin-bottom:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">ì¶”ì²œ ìˆ˜ë‹¹</div>
          <div class="override-row"><div class="override-label">ì§ì¶”ì²œ ìˆ˜ë‹¹ (%)</div><input class="override-input" id="ov-direct" type="number" step="0.1" min="0" max="50"><div class="override-unit">%</div></div>
          <div class="override-row"><div class="override-label">ì†Œì‹¤ì  2ëŒ€ ìˆ˜ë‹¹ (%)</div><input class="override-input" id="ov-binary" type="number" step="0.1" min="0" max="50"><div class="override-unit">%</div></div>
        </div>
        <div class="override-panel">
          <div style="font-size:14px;color:var(--text3);margin-bottom:10px;font-weight:700;letter-spacing:.8px;text-transform:uppercase;">ê¸°íƒ€ ì„¤ì •</div>
          <div class="override-row"><div class="override-label">ìµœëŒ€ ìˆ˜ìµ í•œë„ (%)</div><input class="override-input" id="ov-maxpayout" type="number" step="10" min="100" max="1000"><div class="override-unit">%</div></div>
          <div class="override-row"><div class="override-label">ì¶œê¸ˆ ìˆ˜ìˆ˜ë£Œ (%)</div><input class="override-input" id="ov-wdfee" type="number" step="0.5" min="0" max="30"><div class="override-unit">%</div></div>
        </div>
      </div>
    </div>

    <!-- ì…ê¸ˆ ê³„ì¢Œ ì„¤ì • -->
    <div class="card" style="margin-bottom:20px;">
      <div class="card-header">
        <div class="card-title-lg">ğŸ¦ ì…ê¸ˆ ê³„ì¢Œ ì„¤ì •</div>
        <button class="btn btn-secondary btn-sm" onclick="saveDepositAccount()"><i class="fas fa-save"></i> ì €ì¥</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:14px;">
        <div class="form-group" style="margin:0;"><label class="form-label">ì€í–‰ëª…</label><input class="form-input" id="admin-bank-name" placeholder="êµ­ë¯¼ì€í–‰"></div>
        <div class="form-group" style="margin:0;"><label class="form-label">ê³„ì¢Œë²ˆí˜¸</label><input class="form-input mono" id="admin-bank-account" placeholder="123-456-789012"></div>
        <div class="form-group" style="margin:0;"><label class="form-label">ì˜ˆê¸ˆì£¼</label><input class="form-input" id="admin-bank-holder" placeholder="ì˜ˆê¸ˆì£¼"></div>
      </div>
    </div>

    <!-- TABS -->
    <div id="admin-tabs" class="tabs">
      <button class="tab active" onclick="switchAdminTab('overview',this)">ğŸ“Š ê°œìš”</button>
      <button class="tab" onclick="switchAdminTab('approval',this)">âœ… ê°€ì…ìŠ¹ì¸ <span id="appr-badge" class="stat-badge badge-pend" style="margin-left:4px;"></span></button>
      <button class="tab" onclick="switchAdminTab('members',this)">ğŸ‘¥ íšŒì›ê´€ë¦¬</button>
      <button class="tab" onclick="switchAdminTab('investments',this)">ğŸ’° íˆ¬ììŠ¹ì¸ <span id="inv-badge" class="stat-badge badge-pend" style="margin-left:4px;"></span></button>
      <button class="tab" onclick="switchAdminTab('withdrawals',this)">ğŸ§ ì¶œê¸ˆìŠ¹ì¸ <span id="wd-badge" class="stat-badge badge-pend" style="margin-left:4px;"></span></button>
      <button class="tab" onclick="switchAdminTab('logs',this)">ğŸ“‹ ê±°ë˜ë¡œê·¸</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div id="admin-tab-overview">
      <div class="dash-grid dash-row-2">
        <div class="card">
          <div class="card-header"><div class="card-title-lg">íšŒì› íˆ¬ì í˜„í™©</div></div>
          <canvas id="admin-bar-chart" height="240"></canvas>
        </div>
        <div class="card">
          <div class="card-header"><div class="card-title-lg">ì§ê¸‰ë³„ í˜„í™©</div></div>
          <div id="admin-rank-overview"></div>
        </div>
      </div>
    </div>

    <!-- MEMBERS TAB -->
    <!-- APPROVAL TAB -->
    <div id="admin-tab-approval" style="display:none;">
      <div class="card">
        <div class="card-header"><div class="card-title-lg">ê°€ì… ìŠ¹ì¸ ëŒ€ê¸° íšŒì›</div></div>
        <div id="admin-approval-list"></div>
      </div>
    </div>

    <div id="admin-tab-members" style="display:none;">
      <div class="card">
        <div class="card-header">
          <div class="card-title-lg">íšŒì› ëª©ë¡</div>
          <div style="display:flex;gap:8px;">
            <input class="form-input" id="member-search" placeholder="ì´ë¦„/ì•„ì´ë”” ê²€ìƒ‰" style="width:200px;padding:8px 12px;font-size:14px;" oninput="searchMembers()">
            <select class="form-input form-select" id="member-status-filter" style="width:120px;padding:8px 12px;font-size:14px;" onchange="searchMembers()">
              <option value="all">ì „ì²´</option>
              <option value="active">íˆ¬ìì¤‘</option>
              <option value="inactive">ë¯¸íˆ¬ì</option>
              <option value="suspended">ì •ì§€</option>
            </select>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>íšŒì›</th><th>ì¶”ì²œì¸</th><th>íˆ¬ìê¸ˆ</th><th>ëˆ„ì ROI</th><th>ì”ì•¡</th><th>ì§ê¸‰</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
            <tbody id="admin-member-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- INVESTMENTS TAB -->
    <div id="admin-tab-investments" style="display:none;">
      <div class="card">
        <div class="card-header"><div class="card-title-lg">íˆ¬ì ìŠ¹ì¸ ëŒ€ê¸°</div></div>
        <div id="admin-invest-list"></div>
      </div>
    </div>

    <!-- WITHDRAWALS TAB -->
    <div id="admin-tab-withdrawals" style="display:none;">
      <div class="card">
        <div class="card-header"><div class="card-title-lg">ì¶œê¸ˆ ìŠ¹ì¸ ëŒ€ê¸°</div></div>
        <div id="admin-wd-list"></div>
      </div>
    </div>

    <!-- LOGS TAB -->
    <div id="admin-tab-logs" style="display:none;">
      <div class="card">
        <div class="card-header" style="flex-wrap:wrap;gap:10px;">
          <div class="card-title-lg">ğŸ“‹ ì „ì²´ ê±°ë˜ë‚´ì—­ ê´€ë¦¬</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;">
            <input class="form-input" id="log-search" placeholder="íšŒì›ID / ë‚´ìš© ê²€ìƒ‰" style="width:155px;padding:8px 12px;font-size:14px;" oninput="searchLogs()">
            <select class="form-input form-select" id="log-type-filter" style="width:110px;padding:8px 12px;font-size:14px;" onchange="searchLogs()">
              <option value="all">ì „ì²´ìœ í˜•</option>
              <option value="íˆ¬ì">íˆ¬ì</option>
              <option value="ROI">ROI</option>
              <option value="ë³´ë„ˆìŠ¤">ë³´ë„ˆìŠ¤</option>
              <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
              <option value="ì§ê¸‰ìˆ˜ë‹¹">ì§ê¸‰ìˆ˜ë‹¹</option>
            </select>
            <button class="btn btn-primary btn-sm" onclick="openAddTxModal('')" style="min-height:40px;white-space:nowrap;padding:0 16px;"><i class="fas fa-plus"></i> ê±°ë˜ ì¶”ê°€</button>
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr><th>ë‚ ì§œ</th><th>íšŒì›</th><th>ìœ í˜•</th><th>ê¸ˆì•¡</th><th>ìˆ˜ìˆ˜ë£Œ</th><th>ë‚´ìš©</th><th>ìƒíƒœ</th><th style="min-width:120px;">ê´€ë¦¬</th></tr></thead>
            <tbody id="admin-log-body"></tbody>
          </table>
        </div>
        <div id="log-count" style="padding:8px 0 2px;font-size:13px;color:var(--text3);"></div>
      </div>
    </div>

  </div>
</div>

<!-- â˜… ê±°ë˜ë‚´ì—­ ìˆ˜ì •/ì¶”ê°€ ëª¨ë‹¬ -->
<div id="modal-tx-edit" class="modal-overlay hidden" onclick="if(event.target===this)closeTxEdit()">
  <div class="modal" style="max-width:500px;width:96%;padding:28px;max-height:92vh;overflow-y:auto;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;">
      <div id="tx-edit-title" style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--text);">ê±°ë˜ë‚´ì—­ ìˆ˜ì •</div>
      <button class="btn btn-secondary btn-sm" onclick="closeTxEdit()"><i class="fas fa-times"></i></button>
    </div>
    <div style="display:flex;flex-direction:column;gap:14px;">
      <div class="form-group" style="margin:0;">
        <label class="form-label">íšŒì› ID *</label>
        <input class="form-input" id="tx-edit-userId" placeholder="íšŒì› ì•„ì´ë””">
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="form-group" style="margin:0;">
          <label class="form-label">ìœ í˜• *</label>
          <select class="form-input form-select" id="tx-edit-type">
            <option value="íˆ¬ì">íˆ¬ì</option>
            <option value="ROI">ROI</option>
            <option value="ë³´ë„ˆìŠ¤">ë³´ë„ˆìŠ¤</option>
            <option value="ì¶œê¸ˆ">ì¶œê¸ˆ</option>
            <option value="ì§ê¸‰ìˆ˜ë‹¹">ì§ê¸‰ìˆ˜ë‹¹</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
          </select>
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">ë‚ ì§œ *</label>
          <input class="form-input" id="tx-edit-date" type="date">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
        <div class="form-group" style="margin:0;">
          <label class="form-label">ê¸ˆì•¡ (ì›)</label>
          <input class="form-input mono" id="tx-edit-amount" type="number" min="0" placeholder="0" oninput="txAutoNet()">
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">ìˆ˜ìˆ˜ë£Œ (ì›)</label>
          <input class="form-input mono" id="tx-edit-fee" type="number" min="0" placeholder="0" oninput="txAutoNet()">
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label">ì‹¤ì§€ê¸‰ (ì›)</label>
          <input class="form-input mono" id="tx-edit-net" type="number" min="0" placeholder="ìë™">
        </div>
      </div>
      <div class="form-group" style="margin:0;">
        <label class="form-label">ë‚´ìš© / ë©”ëª¨</label>
        <input class="form-input" id="tx-edit-desc" placeholder="ê±°ë˜ ë‚´ìš© ì…ë ¥">
      </div>
      <div class="form-group" style="margin:0;">
        <label class="form-label">ìƒíƒœ</label>
        <select class="form-input form-select" id="tx-edit-status">
          <option value="completed">ì™„ë£Œ</option>
          <option value="pending">ëŒ€ê¸°</option>
          <option value="cancelled">ì·¨ì†Œ</option>
        </select>
      </div>
    </div>
    <div style="display:flex;gap:10px;margin-top:22px;">
      <button class="btn btn-primary" style="flex:1;min-height:48px;" onclick="saveTxEdit()"><i class="fas fa-save"></i> ì €ì¥</button>
      <button class="btn btn-secondary" style="min-height:48px;padding:0 20px;" onclick="closeTxEdit()">ì·¨ì†Œ</button>
    </div>
    <input type="hidden" id="tx-edit-id">
  </div>
</div>

<!-- MEMBER DETAIL MODAL -->
<div id="modal-member-detail" class="modal-overlay hidden" onclick="if(event.target===this)closeMemberDetail()">
  <div class="modal" style="max-width:720px;width:96%;max-height:92vh;overflow-y:auto;padding:28px;">

    <!-- í—¤ë” -->
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:22px;border-bottom:1px solid var(--border);padding-bottom:16px;">
      <div>
        <div id="mmd-title" style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--text);">íšŒì› ìƒì„¸</div>
        <div id="mmd-subtitle" style="font-size:15px;color:var(--text2);margin-top:4px;"></div>
      </div>
      <button class="btn btn-secondary btn-sm" onclick="closeMemberDetail()"><i class="fas fa-times"></i> ë‹«ê¸°</button>
    </div>

    <!-- íƒ­ -->
    <div style="display:flex;gap:4px;border-bottom:1px solid var(--border);margin-bottom:20px;overflow-x:auto;">
      <button class="tab active" id="mmd-tab-info" onclick="switchMmdTab('info',this)">ğŸ“‹ ê¸°ë³¸ì •ë³´</button>
      <button class="tab" id="mmd-tab-finance" onclick="switchMmdTab('finance',this)">ğŸ’° ê¸ˆìœµì •ë³´</button>
      <button class="tab" id="mmd-tab-tx" onclick="switchMmdTab('tx',this)">ğŸ“„ ê±°ë˜ë‚´ì—­</button>
      <button class="tab" id="mmd-tab-account" onclick="switchMmdTab('account',this)">ğŸ” ê³„ì •ê´€ë¦¬</button>
    </div>

    <!-- íƒ­ ë‚´ìš© -->
    <div id="mmd-tab-info-body"><!-- ê¸°ë³¸ì •ë³´ --></div>
    <div id="mmd-tab-finance-body" style="display:none;"><!-- ê¸ˆìœµì •ë³´ --></div>
    <div id="mmd-tab-tx-body" style="display:none;"><!-- ê±°ë˜ë‚´ì—­ --></div>
    <div id="mmd-tab-account-body" style="display:none;"><!-- ê³„ì •ê´€ë¦¬ --></div>

  </div>
</div>

</div><!-- /#app -->

<!-- TOAST -->
<div id="toast-container"></div>

<!-- íšŒì› ìƒì„¸ ëª¨ë‹¬ -->
<div id="modal-member-detail" class="modal-overlay hidden" onclick="if(event.target===this)closeMemberDetail()">
  <div class="modal" style="max-width:520px;width:95%;max-height:85vh;overflow-y:auto;">
    <div class="modal-title" id="mmd-title">íšŒì› ìƒì„¸</div>
    <div id="mmd-body" style="font-size:15px;color:var(--text2);line-height:1.7;margin-bottom:16px;"></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn btn-purple btn-sm" onclick="adminManualRoi()" id="mmd-roi-btn"><i class="fas fa-coins"></i> ROI ìˆ˜ë™ ì§€ê¸‰</button>
      <button class="btn btn-success btn-sm" onclick="adminAddWallet()" id="mmd-wallet-btn"><i class="fas fa-plus"></i> ì”ì•¡ ì¶”ê°€</button>
      <button class="btn btn-danger btn-sm" id="mmd-suspend-btn"><i class="fas fa-ban"></i> ê³„ì • ì •ì§€</button>
      <button class="btn btn-secondary btn-sm" onclick="closeMemberDetail()"><i class="fas fa-times"></i> ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- CONFIRM MODAL -->
<div id="modal-confirm" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title" id="modal-title">í™•ì¸</div>
    <div class="modal-sub" id="modal-body">ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
      <button class="btn btn-primary" id="modal-confirm-btn" onclick="confirmModal()">í™•ì¸</button>
    </div>
  </div>
</div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë³´ì•ˆ ì„¤ì • â€” XSS ë°©ì§€, CSRF í† í°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const _esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
let _sessionToken = null;
let _sessionStartTime = null;
const _SESSION_TIMEOUT_MS = 2 * 60 * 60 * 1000; // â˜… 2ì‹œê°„ ì„¸ì…˜ ë§Œë£Œ
function _genToken(){ return Array.from(crypto.getRandomValues(new Uint8Array(16))).map(b=>b.toString(16).padStart(2,'0')).join(''); }
function _validateSession(){
  if(!_sessionToken || !currentUser){ doLogout(); return false; }
  // â˜… ì„¸ì…˜ ë§Œë£Œ ì²´í¬ (2ì‹œê°„)
  if(_sessionStartTime && Date.now() - _sessionStartTime > _SESSION_TIMEOUT_MS){
    toast('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.','warning');
    doLogout(); return false;
  }
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DB â€” Firebase Firestore (í´ë¼ìš°ë“œ ì €ì¥)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function waitFirebase(timeout=8000){
  const start=Date.now();
  while(!window.firebaseReady){
    if(Date.now()-start>timeout) throw new Error('Firebase ì—°ê²° ì‹¤íŒ¨');
    await new Promise(r=>setTimeout(r,100));
  }
}
async function initDB(){ await waitFirebase(); console.log('[DB] Firebase ì¤€ë¹„ ì™„ë£Œ'); }
const dbGet=(s,k)=>window.fsGet(s,k);
const dbGetAll=(s)=>window.fsGetAll(s);
const dbPut=(s,o)=>window.fsPut(s,o);
const dbDelete=(s,k)=>window.fsDelete(s,k);
const dbAdd=(s,o)=>window.fsAdd(s,o);
const dbGetIndex=(s,idx,val)=>window.fsGetIndex(s,idx,val);

async function audit(action, detail, userId=null){
  try{
    await dbAdd('auditLog',{ id:Date.now()+'_'+Math.random().toString(36).slice(2,7), ts:Date.now(), date:localDateStr(new Date()), action, detail, by:userId||(currentUser?currentUser.id:'system') });
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS (ìˆ˜ë‹¹ ë¹„ìœ¨ - ê´€ë¦¬ì ì¡°ì • ê°€ëŠ¥)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CFG = {
  DAILY_ROI:    0.01,    // 1%
  DIRECT_BONUS: 0.05,    // 5%
  BINARY_BONUS: 0.03,    // 3%
  MAX_PAYOUT:   3.00,    // 300%
  WD_FEE:       0.05,    // 5%
  MIN_INVEST:   1000000,
  DEPOSIT_BANK: 'êµ­ë¯¼ì€í–‰',
  DEPOSIT_ACCOUNT: '123-456-789012',
  DEPOSIT_HOLDER: 'Medi World',
};
async function loadSettings(){
  try{
    const s=await dbGetAll('settings');
    s.forEach(item=>{ if(item && item.key && item.key in CFG) CFG[item.key]=item.value; });
  }catch(e){ console.warn('ì„¤ì • ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ê°’ ì‚¬ìš©'); }
}
async function saveSetting(key,val){ await dbPut('settings',{id:key, key, value:val}); CFG[key]=val; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ì§ê¸‰ í…Œì´ë¸” (ì†Œë¼ì¸ ê¸°ì¤€ íˆ¬ìê¸ˆ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RANK_TABLE=[
  { rank:0, label:'ì¼ë°˜', minSmall:0,         bonus:0,         class:'rank-0' },
  { rank:1, label:'ë¸Œë¡ ì¦ˆ', minSmall:30000000,   bonus:1000000,   class:'rank-1' },
  { rank:2, label:'ì‹¤ë²„',   minSmall:60000000,   bonus:2000000,   class:'rank-2' },
  { rank:3, label:'ê³¨ë“œ',   minSmall:120000000,  bonus:3000000,   class:'rank-3' },
  { rank:4, label:'í”Œë˜í‹°ë„˜',minSmall:240000000,  bonus:6000000,   class:'rank-4' },
  { rank:5, label:'ë‹¤ì´ì•„',  minSmall:480000000,  bonus:12000000,  class:'rank-5' },
];

function calcRank(smallLineAmt){
  let r=RANK_TABLE[0];
  for(const rr of RANK_TABLE){ if(smallLineAmt>=rr.minSmall) r=rr; }
  return r;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEED DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// âš ï¸  ë³´ì•ˆ ê²½ê³ : ì•„ë˜ ì´ˆê¸° ë°ì´í„°ëŠ” ìµœì´ˆ 1íšŒë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
//    ë°°í¬ í›„ ì¦‰ì‹œ ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì„¸ìš”!
//    ê¸°ë³¸ ê´€ë¦¬ì ê³„ì •: admin / admin123!  â† ë°˜ë“œì‹œ ë³€ê²½!
//    ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ê³„ì •: ydcho, userA, userB / pass1234! â† ì‹¤ì„œë¹„ìŠ¤ì—ì„œ ì‚­ì œ!
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
const SEED_USERS=[
  {id:'admin',pwd:_hashPwd('admin123!'),role:'admin',name:'ìµœê³ ê´€ë¦¬ì',inviteCode:'SYSTEM-ROOT',sponsorCode:null,
   wallet:0,investment:0,roi:0,leftPoints:0,rightPoints:0,leftInvest:0,rightInvest:0,
   paidRanks:[],children:{left:null,right:null},email:'admin@mediworld.net',phone:'010-0000-0000',
   bankName:'',accountNumber:'',accountHolder:'',registeredAt:'2026-01-01',lastLogin:null,suspended:false,approvalStatus:'approved',
   _pwdChangedAt:null, _mustChangePwd:true},
  {id:'ydcho',pwd:_hashPwd('pass1234!'),role:'member',name:'ì¡°ì˜ë•',inviteCode:'ydcho',sponsorCode:'admin',
   wallet:5000000,investment:10000000,roi:1200000,leftPoints:50000000,rightPoints:20000000,
   leftInvest:50000000,rightInvest:20000000,
   paidRanks:[],children:{left:'userA',right:'userB'},email:'ydcho@medi.net',phone:'010-1234-5678',
   bankName:'êµ­ë¯¼ì€í–‰',accountNumber:'110-123-456789',accountHolder:'ì¡°ì˜ë•',
   registeredAt:'2026-01-10',lastLogin:null,lastInvestmentDate:'2026-01-10',lastRoiDate:null,suspended:false,approvalStatus:'approved'},
  {id:'userA',pwd:_hashPwd('pass1234!'),role:'member',name:'íŒŒíŠ¸ë„ˆA',inviteCode:'userA',sponsorCode:'ydcho',
   wallet:1500000,investment:50000000,roi:500000,leftPoints:0,rightPoints:0,leftInvest:0,rightInvest:0,
   paidRanks:[],children:{left:null,right:null},email:'',phone:'',bankName:'',accountNumber:'',accountHolder:'',
   registeredAt:'2026-01-12',lastLogin:null,lastInvestmentDate:'2026-01-12',lastRoiDate:null,suspended:false,approvalStatus:'approved'},
  {id:'userB',pwd:_hashPwd('pass1234!'),role:'member',name:'íŒŒíŠ¸ë„ˆB',inviteCode:'userB',sponsorCode:'ydcho',
   wallet:800000,investment:20000000,roi:200000,leftPoints:0,rightPoints:0,leftInvest:0,rightInvest:0,
   paidRanks:[],children:{left:null,right:null},email:'',phone:'',bankName:'',accountNumber:'',accountHolder:'',
   registeredAt:'2026-01-15',lastLogin:null,lastInvestmentDate:'2026-01-15',lastRoiDate:null,suspended:false,approvalStatus:'approved'},
];
const SEED_TX=[
  {id:1001,userId:'ydcho',type:'íˆ¬ì',amount:10000000,fee:0,netAmount:10000000,date:'2026-01-10',status:'completed',desc:'ìµœì´ˆ íˆ¬ì ìŠ¹ì¸'},
  {id:1002,userId:'ydcho',type:'ROI',amount:100000,fee:0,netAmount:100000,date:'2026-01-13',status:'completed',desc:'ìë™ ROI 1.0%'},
  {id:1003,userId:'ydcho',type:'ë³´ë„ˆìŠ¤',amount:2500000,fee:0,netAmount:2500000,date:'2026-01-12',status:'completed',desc:'ì§ì¶”ì²œ ìˆ˜ë‹¹ (íŒŒíŠ¸ë„ˆA 5ì²œë§Œ íˆ¬ì 5%)'},
  {id:1004,userId:'userA',type:'íˆ¬ì',amount:50000000,fee:0,netAmount:50000000,date:'2026-01-12',status:'completed',desc:'íˆ¬ì ìŠ¹ì¸'},
];
async function seedIfEmpty(){
  try{
    const ex=await dbGetAll('users');
    if(ex.length===0){
      console.log('[Seed] Firebaseì— ì´ˆê¸° ë°ì´í„° ì €ì¥ ì¤‘...');
      for(const u of SEED_USERS) await dbPut('users',u);
      for(const t of SEED_TX) await dbPut('transactions',t);
      console.log('[Seed] ì´ˆê¸° ë°ì´í„° ì €ì¥ ì™„ë£Œ âœ…');
    }
  }catch(e){ console.error('[Seed] ì´ˆê¸°í™” ì‹¤íŒ¨:', e); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ë³´ì•ˆ â€” ë¹„ë°€ë²ˆí˜¸ í•´ì‹± (Web Crypto API SHA-256 + Salt)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// âš ï¸ ë™ê¸° í•´ì‹œ â†’ SHA-256 ê¸°ë°˜ ê°•í™” ë²„ì „
// ì‹¤ì„œë¹„ìŠ¤ ìµœê³  ë³´ì•ˆ = Firebase Authentication ì´ì „ ê¶Œì¥
const _HASH_VER = 'MW5v2'; // ë²„ì „ íƒœê·¸ (êµ¬ í•´ì‹œì™€ êµ¬ë³„)
const _APP_SALT = 'MediWorld2026!SecureSalt$#@'; // ì•± ê³ ì • ì†”íŠ¸

// SHA-256 ë™ê¸° ëŒ€ì²´ (Web CryptoëŠ” ë¹„ë™ê¸°ë¼ ê¸°ì¡´ ì½”ë“œì™€ í˜¸í™˜ ìœ ì§€)
// + ê¸°ì¡´ í•´ì‹œ í•˜ìœ„í˜¸í™˜ ìœ ì§€ë¥¼ ìœ„í•´ ë‘ í•¨ìˆ˜ ëª¨ë‘ ë³´ì¡´
function _hashPwd(pw){
  // êµ¬ë²„ì „ í•´ì‹œ (ê¸°ì¡´ DB ë°ì´í„° í˜¸í™˜ìš© â€” ì‹ ê·œ ì €ì¥ ì‹œ _hashPwdV2 ì‚¬ìš©)
  let h=0;
  const s='MW5_SALT_'+pw+'_2026';
  for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
  return 'mw5$'+Math.abs(h).toString(36)+'$'+btoa(pw.split('').reverse().join('')).replace(/=/g,'');
}
async function _hashPwdSecure(pw){
  // â˜… ê°•í™”ëœ SHA-256 í•´ì‹œ (ì‹ ê·œ ë¹„ë°€ë²ˆí˜¸ ì €ì¥ ì‹œ ì‚¬ìš©)
  const salt = _APP_SALT + pw.length;
  const msgBuffer = new TextEncoder().encode(salt + pw + _APP_SALT);
  const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  return _HASH_VER + '$' + hashHex;
}
async function _verifyPwdSecure(plain, hash){
  if(hash.startsWith(_HASH_VER)){
    // ì‹ ê·œ SHA-256 í•´ì‹œ ê²€ì¦
    const computed = await _hashPwdSecure(plain);
    return computed === hash;
  } else {
    // êµ¬ë²„ì „ í•´ì‹œ í•˜ìœ„í˜¸í™˜ (ê¸°ì¡´ íšŒì› ë¡œê·¸ì¸ ê°€ëŠ¥í•˜ë„ë¡)
    return _hashPwd(plain) === hash;
  }
}
function _verifyPwd(plain,hash){ return _hashPwd(plain)===hash; }
// ì…ë ¥ ê²€ì¦
function _sanitizeId(v){ return /^[a-zA-Z0-9_]{4,20}$/.test(v); }
function _sanitizePwd(v){
  // â˜… ê°•í™”ëœ ë¹„ë°€ë²ˆí˜¸ ì •ì±…: 8ì ì´ìƒ + ìˆ«ì í¬í•¨
  if(v.length < 8) return false;
  if(!/[0-9]/.test(v)) return false; // ìˆ«ì 1ê°œ ì´ìƒ í•„ìˆ˜
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  APP STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser=null, currentView='login', wdStep=1, wdAmountVal=0;
let adminCurrentTab='overview', modalCallback=null, reportFilter='all';
let roiRingChart=null, adminBarChart=null;
let _detailUserId=null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmt(n){ n=Math.round(n||0); if(Math.abs(n)>=100000000) return 'â‚©'+(n/100000000).toFixed(2).replace(/\.?0+$/,'')+'ì–µ'; if(Math.abs(n)>=10000000) return 'â‚©'+(n/10000000).toFixed(1).replace(/\.?0+$/,'')+'ì²œë§Œ'; if(Math.abs(n)>=10000) return 'â‚©'+(n/10000).toFixed(0)+'ë§Œ'; return 'â‚©'+n.toLocaleString(); }
function fmtFull(n){ return 'â‚©'+(Math.round(n||0)).toLocaleString(); }
function localDateStr(d){ return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function isWeekday(d){ const w=d.getDay(); return w>=1&&w<=5; } // ì›”~ê¸ˆ
function typeColor(t){ const m={ROI:'var(--gold)',ë³´ë„ˆìŠ¤:'var(--green)',ë°”ì´ë„ˆë¦¬:'var(--blue)',ì§ê¸‰ìˆ˜ë‹¹:'var(--purple)',ì¶œê¸ˆ:'var(--red)',íˆ¬ì:'var(--text)'}; return m[t]||'var(--text2)'; }
function typeLabel(t){ const m={ROI:'ROI ë°°ë‹¹',ë³´ë„ˆìŠ¤:'ì¶”ì²œìˆ˜ë‹¹',ë°”ì´ë„ˆë¦¬:'ì†Œì‹¤ì ìˆ˜ë‹¹',ì§ê¸‰ìˆ˜ë‹¹:'ì§ê¸‰ìˆ˜ë‹¹',ì¶œê¸ˆ:'ì¶œê¸ˆ',íˆ¬ì:'íˆ¬ì'}; return m[t]||t; }
function statusHtml(s){ const m={completed:'done',pending:'pend',rejected:'fail',suspended:'stop',cancelled:'fail'}; const l={completed:'ì™„ë£Œ',pending:'ëŒ€ê¸°',rejected:'ê±°ë¶€',suspended:'ì •ì§€',cancelled:'ì·¨ì†Œ'}; return `<span class="status status-${m[s]||'pend'}">${l[s]||s}</span>`; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST & MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type='info'){
  const icons={info:'fa-circle-info',success:'fa-circle-check',error:'fa-circle-xmark',warning:'fa-triangle-exclamation'};
  const el=document.createElement('div');
  el.className=`toast toast-${type}`;
  el.innerHTML=`<i class="fas ${icons[type]||icons.info}"></i><span>${_esc(msg)}</span>`;
  document.getElementById('toast-container').appendChild(el);
  setTimeout(()=>{ el.style.animation='slideOut .3s ease forwards'; setTimeout(()=>el.remove(),300); },3500);
}
function showModal(title,body,cb,btnLabel='í™•ì¸',btnClass='btn-primary'){
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-body').textContent=body;
  document.getElementById('modal-confirm-btn').className=`btn ${btnClass}`;
  document.getElementById('modal-confirm-btn').textContent=btnLabel;
  modalCallback=cb;
  document.getElementById('modal-confirm').classList.remove('hidden');
}
function closeModal(){ document.getElementById('modal-confirm').classList.add('hidden'); modalCallback=null; }
async function confirmModal(){
  const btn=document.getElementById('modal-confirm-btn');
  if(!modalCallback||btn.disabled)return;
  btn.disabled=true; btn.style.opacity='0.5';
  const origTxt=btn.textContent; btn.textContent='ì²˜ë¦¬ ì¤‘...';
  const cb=modalCallback;
  closeModal();
  try{ await cb(); }
  catch(e){ console.error('[confirmModal]',e); toast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: '+e.message,'error'); }
  finally{ btn.disabled=false; btn.style.opacity=''; btn.textContent=origTxt; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name){
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='none';});
  const pg=document.getElementById('page-'+name);
  if(pg){pg.style.display='block';pg.classList.add('active');}
  // ìƒë‹¨ nav active
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll(`.nav-btn[data-view="${name}"]`).forEach(b=>b.classList.add('active'));
  // í•˜ë‹¨ íƒ­ë°” active
  _updateBnavActive(name);
  currentView=name; window.scrollTo(0,0);
}
function goView(name){ showPage(name); renderPage(name); }
function goHome(){ if(!currentUser)return; goView(currentUser.role==='admin'?'admin_dash':'dashboard'); }
function renderPage(name){
  if(name==='dashboard') renderDashboard();
  else if(name==='invest') renderInvest();
  else if(name==='network') renderNetwork();
  else if(name==='wallet') renderWallet();
  else if(name==='reports') renderReports();
  else if(name==='profile') renderProfile();
  else if(name==='admin_dash') renderAdmin();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchLoginTab(tab,btn){
  document.querySelectorAll('.login-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.login-form-section').forEach(s=>s.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('lf-'+tab).classList.add('active');
}
async function doLogin(){
  const id=document.getElementById('inp-lid').value.trim();
  const pwd=document.getElementById('inp-lpwd').value;
  if(!id||!pwd){toast('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}

  // â˜… ê°•í™”ëœ ë¸Œë£¨íŠ¸í¬ìŠ¤ ë°©ì§€ (sessionStorage ì‚¬ìš© â€” ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€)
  const _attemptKey = 'mw_login_attempts';
  const _lockKey = 'mw_login_locktime';
  const lockUntil = parseInt(sessionStorage.getItem(_lockKey)||'0');
  if(Date.now() < lockUntil){
    const remain = Math.ceil((lockUntil - Date.now())/1000);
    toast(`â›” ë¡œê·¸ì¸ì´ ì ê²¼ìŠµë‹ˆë‹¤. ${remain}ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”`,'error');
    return;
  }
  const attempts = parseInt(sessionStorage.getItem(_attemptKey)||'0');
  if(attempts >= 5){
    sessionStorage.setItem(_lockKey, String(Date.now() + 5*60*1000)); // 5ë¶„ ì ê¸ˆ
    sessionStorage.setItem(_attemptKey, '0');
    toast('â›” ë¡œê·¸ì¸ ì‹œë„ 5íšŒ ì´ˆê³¼. 5ë¶„ê°„ ì ê¹ë‹ˆë‹¤','error');
    return;
  }

  const user=await dbGet('users',id);
  // â˜… ë³´ì•ˆ: ì¡´ì¬í•˜ì§€ ì•ŠëŠ” IDë„ ë™ì¼í•œ ì—ëŸ¬ ë©”ì‹œì§€ (ID ì¡´ì¬ ì—¬ë¶€ ë…¸ì¶œ ë°©ì§€)
  const pwdOk = user ? await _verifyPwdSecure(pwd, user.pwd) : false;
  if(!user||!pwdOk){
    const newAttempts = attempts + 1;
    sessionStorage.setItem(_attemptKey, String(newAttempts));
    const remain = 5 - newAttempts;
    toast(`ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤ (ë‚¨ì€ ì‹œë„: ${remain}íšŒ)`,'error');
    return;
  }
  // ë¡œê·¸ì¸ ì„±ê³µ â†’ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
  sessionStorage.removeItem(_attemptKey);
  sessionStorage.removeItem(_lockKey);

  if(user.suspended&&user.role!=='admin'){toast('ê³„ì •ì´ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”','error');return;}
  if(user.approvalStatus==='pending'&&user.role!=='admin'){toast('â³ ê°€ì… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤','error');return;}

  // â˜… ìµœì´ˆ ë¡œê·¸ì¸ ì‹œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê°•ì œ (ê´€ë¦¬ì ê³„ì •)
  if(user._mustChangePwd && user.role==='admin'){
    await loginUser(user);
    toast('âš ï¸ ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ë¥¼ ë°˜ë“œì‹œ ë³€ê²½í•´ì£¼ì„¸ìš”!','warning');
    setTimeout(()=>goView('admin_dash'),500);
    return;
  }
  await loginUser(user);
}
// â˜… quickLogin í•¨ìˆ˜ ë³´ì•ˆìƒ ì œê±°ë¨ (ìë™ ë¡œê·¸ì¸ ê¸°ëŠ¥ì€ ë³´ì•ˆ ìœ„í—˜)
async function loginUser(user){
  user.lastLogin=localDateStr(new Date());
  await dbPut('users',user);
  _sessionToken=_genToken();
  _sessionStartTime=Date.now(); // â˜… ì„¸ì…˜ ì‹œì‘ ì‹œê°„ ê¸°ë¡
  currentUser=user;
  setupTopbar();
  document.getElementById('page-login').style.display='none';
  document.getElementById('page-login').classList.remove('active');
  document.getElementById('topbar').style.display='flex';
  goView(user.role==='admin'?'admin_dash':'dashboard');
  toast(`ì•ˆë…•í•˜ì„¸ìš”, ${_esc(user.name)}ë‹˜!`,'success');
  await audit('LOGIN','ë¡œê·¸ì¸',user.id);
  setTimeout(()=>catchUpRoi(),800);
}
function doLogout(){
  currentUser=null; _sessionToken=null; _sessionStartTime=null;
  // â˜… ë¡œê·¸ì•„ì›ƒ ì‹œ ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡ ì´ˆê¸°í™”
  sessionStorage.removeItem('mw_login_attempts');
  sessionStorage.removeItem('mw_login_locktime');
  document.getElementById('topbar').style.display='none';
  document.getElementById('bottom-nav').style.display='none';
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='none';});
  document.getElementById('page-login').style.display='flex';
  document.getElementById('page-login').classList.add('active');
  document.getElementById('inp-lid').value=''; document.getElementById('inp-lpwd').value='';
}
async function doRegister(){
  const id=document.getElementById('inp-rid').value.trim();
  const name=document.getElementById('inp-rname').value.trim();
  const pwd=document.getElementById('inp-rpwd').value;
  const pwd2=document.getElementById('inp-rpwd2').value;
  const email=document.getElementById('inp-remail').value.trim();
  const phone=document.getElementById('inp-rphone').value.trim();
  const ref=document.getElementById('inp-rref').value.trim();
  // ë³´ì•ˆ ê²€ì¦
  if(!id||!name||!pwd){toast('í•„ìˆ˜ í•­ëª©ì„ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  if(!_sanitizeId(id)){toast('ì•„ì´ë””ëŠ” ì˜ë¬¸/ìˆ«ì 4~20ìì…ë‹ˆë‹¤','error');return;}
  if(!_sanitizePwd(pwd)){toast('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ìˆ«ì í¬í•¨ì´ì–´ì•¼ í•©ë‹ˆë‹¤','error');return;}
  if(pwd!==pwd2){toast('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤','error');return;}
  // â˜… ì´ë¦„ ê¸¸ì´ ì œí•œ
  if(name.length > 30){toast('ì´ë¦„ì€ 30ì ì´í•˜ë¡œ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  const existing=await dbGet('users',id);
  if(existing){toast('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤','error');return;}
  // ì¶”ì²œì¸ ì½”ë“œ â€” ì…ë ¥ ì‹œì—ë§Œ ìœ íš¨ì„± ê²€ì‚¬ (ì„ íƒì‚¬í•­)
  if(ref){
    const refUser=await dbGet('users',ref);
    if(!refUser||refUser.suspended){toast('ìœ íš¨í•˜ì§€ ì•Šì€ ì¶”ì²œì¸ ì½”ë“œì…ë‹ˆë‹¤','error');return;}
  }
  // â˜… ì‹ ê·œ ê°€ì… ì‹œ ê°•í™”ëœ SHA-256 í•´ì‹œ ì‚¬ìš©
  const hashedPwd = await _hashPwdSecure(pwd);
  const newUser={
    id, pwd:hashedPwd, role:'member', name,
    inviteCode:id, sponsorCode:ref||'',
    wallet:0, investment:0, roi:0,
    leftPoints:0, rightPoints:0, leftInvest:0, rightInvest:0,
    paidRanks:[], children:{left:null,right:null},
    email, phone, bankName:'', accountNumber:'', accountHolder:'',
    registeredAt:localDateStr(new Date()), lastLogin:null, suspended:false,
    approvalStatus:'pending',
  };
  await dbPut('users',newUser);
  await audit('REGISTER',`ì‹ ê·œ ê°€ì… (ìŠ¹ì¸ëŒ€ê¸°) ì¶”ì²œì¸:${ref||'ì—†ìŒ'}`,id);
  toast('ğŸ‰ ê°€ì… ì‹ ì²­ ì™„ë£Œ! ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë¡œê·¸ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤','success');
  document.querySelectorAll('.login-tab').forEach((t,i)=>{t.classList.remove('active');if(i===0)t.classList.add('active');});
  document.querySelectorAll('.login-form-section').forEach((s,i)=>{s.classList.remove('active');if(i===0)s.classList.add('active');});
  document.getElementById('inp-lid').value=id;
}
function setupTopbar(){
  document.getElementById('top-avatar').textContent=currentUser.name.charAt(0);
  document.getElementById('top-name').textContent=currentUser.name+' ('+currentUser.id+')';

  // ìƒë‹¨ nav (ë°ìŠ¤í¬íƒ‘)
  const nav=document.getElementById('topbar-nav'); nav.innerHTML='';
  const views=currentUser.role==='admin'
    ?[{id:'admin_dash',label:'ê´€ë¦¬ìí™ˆ'}]
    :[{id:'dashboard',label:'ëŒ€ì‹œë³´ë“œ'},{id:'invest',label:'íˆ¬ìí•˜ê¸°'},{id:'network',label:'ì¡°ì§ê´€ë¦¬'},{id:'wallet',label:'ìˆ˜ìµì¶œê¸ˆ'},{id:'reports',label:'ê±°ë˜ë‚´ì—­'},{id:'profile',label:'ë‚´ì •ë³´'}];
  views.forEach(v=>{
    const b=document.createElement('button');
    b.className='nav-btn'; b.dataset.view=v.id; b.textContent=v.label;
    b.onclick=()=>goView(v.id); nav.appendChild(b);
  });

  // í•˜ë‹¨ íƒ­ë°” (ëª¨ë°”ì¼)
  setupBottomNav();
}

function setupBottomNav(){
  const wrap=document.getElementById('bottom-nav-inner');
  if(!wrap) return;
  wrap.innerHTML='';
  document.getElementById('bottom-nav').style.display='block';

  const isMobile = window.innerWidth <= 768;

  if(currentUser.role==='admin'){
    // ì–´ë“œë¯¼: ê°„ë‹¨í•˜ê²Œ
    const items=[
      {id:'admin_dash',icon:'fa-chart-line',label:'ê´€ë¦¬ì'},
    ];
    items.forEach(v=>_makeBnavBtn(wrap,v));
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
    const lo=document.createElement('button');
    lo.className='bnav-btn';
    lo.innerHTML='<i class="fas fa-sign-out-alt"></i><span>ë¡œê·¸ì•„ì›ƒ</span>';
    lo.onclick=doLogout;
    wrap.appendChild(lo);
    return;
  }

  const items=[
    {id:'dashboard', icon:'fa-home',        label:'í™ˆ'},
    {id:'invest',    icon:'fa-coins',        label:'íˆ¬ì'},
    {id:'network',   icon:'fa-sitemap',      label:'ì¡°ì§'},
    {id:'wallet',    icon:'fa-paper-plane',  label:'ì¶œê¸ˆ'},
    {id:'profile',   icon:'fa-user',         label:'ë‚´ì •ë³´'},
  ];
  items.forEach(v=>_makeBnavBtn(wrap,v));
}

function _makeBnavBtn(wrap,v){
  const b=document.createElement('button');
  b.className='bnav-btn'; b.dataset.view=v.id;
  b.innerHTML=`<i class="fas ${v.icon}"></i><span>${v.label}</span>`;
  b.onclick=()=>goView(v.id);
  wrap.appendChild(b);
}

function _updateBnavActive(name){
  document.querySelectorAll('.bnav-btn').forEach(b=>{
    b.classList.toggle('active', b.dataset.view===name);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderDashboard(){
  const u=await dbGet('users',currentUser.id); currentUser=u;
  const susp=u.suspended;
  document.getElementById('suspended-banner').style.display=susp?'flex':'none';
  const max=u.investment*CFG.MAX_PAYOUT;
  const roiPct=max>0?Math.min(100,(u.roi/max*100)):0;
  const daily=susp?0:Math.round(u.investment*CFG.DAILY_ROI);
  document.getElementById('dash-kpi').innerHTML=`
    <div class="stat-card card-gold"><div class="stat-label">ì´ íˆ¬ìê¸ˆ</div><div class="stat-value">${fmt(u.investment)}</div><div class="stat-sub">ì›ê¸ˆ</div></div>
    <div class="stat-card card-green"><div class="stat-label">ëˆ„ì  ROI</div><div class="stat-value">${fmt(u.roi)}</div><div class="stat-sub">${roiPct.toFixed(1)}% ë‹¬ì„±</div></div>
    <div class="stat-card card-blue"><div class="stat-label">ì¶œê¸ˆ ì”ì•¡</div><div class="stat-value">${fmt(u.wallet)}</div></div>
    <div class="stat-card"><div class="stat-label">ì¼ì¼ ë°°ë‹¹</div><div class="stat-value">${fmt(daily)}</div><div class="stat-sub">ì£¼ 5ì¼ ì§€ê¸‰</div></div>
  `;
  document.getElementById('dash-wallet').textContent=fmtFull(u.wallet);
  document.getElementById('dash-today').textContent=fmtFull(daily);
  document.getElementById('dash-roi-now').textContent=fmtFull(u.roi);
  document.getElementById('dash-roi-max').textContent=fmtFull(max);
  document.getElementById('dash-roi-remain').textContent=fmtFull(Math.max(0,max-u.roi));
  document.getElementById('dash-roi-bar').style.width=roiPct+'%';
  document.getElementById('roi-pct-text').textContent=roiPct.toFixed(1)+'%';
  // ì§ê¸‰
  const smallLine=Math.min(u.leftInvest||0,u.rightInvest||0);
  const rank=calcRank(smallLine);
  document.getElementById('dash-rank-badge').innerHTML=`<div class="rank-badge ${rank.class}"><i class="fas fa-star"></i>${rank.label}</div><div style="font-size:14px;color:var(--text3);margin-top:6px;">ì†Œë¼ì¸: ${fmt(smallLine)}</div>`;
  // ROI ring
  if(roiRingChart){ roiRingChart.destroy(); roiRingChart=null; }
  const ctx=document.getElementById('roi-ring-canvas').getContext('2d');
  roiRingChart=new Chart(ctx,{type:'doughnut',data:{datasets:[{data:[roiPct,100-roiPct],backgroundColor:['rgba(212,168,83,0.9)','rgba(255,255,255,0.05)'],borderWidth:0,circumference:360}]},options:{cutout:'78%',plugins:{legend:{display:false},tooltip:{enabled:false}},animation:{duration:800}}});
  // TX
  const allTx=await dbGetAll('transactions');
  const myTx=allTx.filter(t=>t.userId===u.id).sort((a,b)=>b.id-a.id).slice(0,8);
  const tbody=document.getElementById('dash-tx-body');
  tbody.innerHTML=myTx.length===0?'<tr><td colspan="5" style="text-align:center;padding:30px;color:var(--text3);">ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>':myTx.map(t=>`<tr><td style="color:var(--text3);font-size:14px;">${t.date}</td><td><span style="color:${typeColor(t.type)};font-size:14px;font-weight:600;">${typeLabel(t.type)}</span></td><td class="td-amount">${fmt(t.amount)}</td><td>${statusHtml(t.status)}</td><td style="font-size:14px;color:var(--text3);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${_esc(t.desc||'')}</td></tr>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderInvest(){
  const u=await dbGet('users',currentUser.id);
  // ì…ê¸ˆ ê³„ì¢Œ í‘œì‹œ
  document.getElementById('deposit-account-info').innerHTML=`
    <div style="display:flex;justify-content:space-between;"><span style="color:var(--text2);">ì€í–‰</span><b>${_esc(CFG.DEPOSIT_BANK)}</b></div>
    <div style="display:flex;justify-content:space-between;"><span style="color:var(--text2);">ê³„ì¢Œë²ˆí˜¸</span><b class="mono">${_esc(CFG.DEPOSIT_ACCOUNT)}</b></div>
    <div style="display:flex;justify-content:space-between;"><span style="color:var(--text2);">ì˜ˆê¸ˆì£¼</span><b>${_esc(CFG.DEPOSIT_HOLDER)}</b></div>
  `;
  const max=u.investment*CFG.MAX_PAYOUT;
  document.getElementById('invest-current').innerHTML=u.investment>0?`
    <div style="display:flex;justify-content:space-between;font-size:15px;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="color:var(--text2);">í˜„ì¬ íˆ¬ìê¸ˆ</span><b class="mono" style="color:var(--gold);">${fmtFull(u.investment)}</b>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:15px;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="color:var(--text2);">ì¼ì¼ ë°°ë‹¹</span><b class="mono" style="color:var(--gold);">${fmtFull(Math.round(u.investment*CFG.DAILY_ROI))}</b>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:15px;padding:10px 0;border-bottom:1px solid var(--border);">
      <span style="color:var(--text2);">ëˆ„ì  ROI</span><b class="mono">${fmtFull(u.roi)}</b>
    </div>
    <div style="display:flex;justify-content:space-between;font-size:15px;padding:10px 0;">
      <span style="color:var(--text2);">ì”ì—¬ í•œë„</span><b class="mono" style="color:var(--green);">${fmtFull(Math.max(0,max-u.roi))}</b>
    </div>
    <div class="progress-bar" style="margin-top:10px;"><div class="progress-fill fill-gold" style="width:${Math.min(100,u.roi/max*100)}%"></div></div>
    <div style="font-size:15px;color:var(--text3);margin-top:5px;text-align:right;">${(u.roi/max*100).toFixed(1)}% / 300%</div>
  `:'<div class="empty"><i class="fas fa-chart-line"></i><p>íˆ¬ìë¥¼ ì‹œì‘í•˜ì„¸ìš”</p></div>';
}
function calcSim(){
  const amt=parseInt(document.getElementById('inp-invest-amount').value)||0;
  const sim=document.getElementById('sim-result');
  if(amt<CFG.MIN_INVEST){sim.style.display='none';return;}
  sim.style.display='flex';
  const daily=Math.round(amt*CFG.DAILY_ROI);
  document.getElementById('sim-daily').textContent=fmt(daily);
  document.getElementById('sim-monthly').textContent=fmt(daily*22);
  document.getElementById('sim-max').textContent=fmt(amt*CFG.MAX_PAYOUT);
  document.getElementById('sim-days').textContent=`ì•½ ${Math.ceil(amt/daily)}ì¼`;
}
function calcSimBox(){ const a=parseInt(document.getElementById('sim-amount').value)||0; const sim=document.getElementById('sim-result'); if(a<CFG.MIN_INVEST){sim.style.display='none';return;} sim.style.display='flex'; const d=Math.round(a*CFG.DAILY_ROI); document.getElementById('sim-daily').textContent=fmt(d); document.getElementById('sim-monthly').textContent=fmt(d*22); document.getElementById('sim-max').textContent=fmt(a*CFG.MAX_PAYOUT); document.getElementById('sim-days').textContent=`ì•½ ${Math.ceil(a/d)}ì¼`; }
async function submitInvestment(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  if(u.suspended){toast('ê³„ì •ì´ ì •ì§€ë˜ì–´ íˆ¬ìí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}
  const amt=parseInt(document.getElementById('inp-invest-amount').value)||0;
  const iname=document.getElementById('inp-invest-name').value.trim();
  if(amt<CFG.MIN_INVEST){toast(`ìµœì†Œ íˆ¬ìê¸ˆì•¡ì€ ${fmt(CFG.MIN_INVEST)}ì…ë‹ˆë‹¤`,'error');return;}
  if(!iname){toast('ì…ê¸ˆìëª…ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}

  // â˜… ì´ë¯¸ ëŒ€ê¸° ì¤‘ì¸ ì‹ ì²­ì´ ìˆìœ¼ë©´ ì°¨ë‹¨
  const allPend=await dbGetAll('pendingInvestments');
  if(allPend.some(p=>p.userId===currentUser.id)){
    toast('ì´ë¯¸ ëŒ€ê¸° ì¤‘ì¸ íˆ¬ì ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ë‹¤ì‹œ ì‹ ì²­í•´ ì£¼ì„¸ìš”.','error');
    return;
  }

  const inv={id:Date.now(),userId:currentUser.id,userName:currentUser.name,amount:amt,depositorName:_esc(iname),memo:_esc(document.getElementById('inp-invest-memo').value.trim()),requestedAt:localDateStr(new Date()),status:'pending'};
  await dbPut('pendingInvestments',inv);
  await audit('INVEST_REQUEST',`íˆ¬ìì‹ ì²­ ${fmt(amt)}`,currentUser.id);
  document.getElementById('inp-invest-amount').value='';
  document.getElementById('inp-invest-name').value='';
  document.getElementById('inp-invest-memo').value='';
  toast('íˆ¬ì ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ë°°ë‹¹ì´ ì‹œì‘ë©ë‹ˆë‹¤','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NETWORK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderNetwork(){
  const u=await dbGet('users',currentUser.id); currentUser=u;
  const allUsers=await dbGetAll('users');
  // í•˜ìœ„ ì „ì²´ ì§‘ê³„
  function getDownlineIds(uid,acc=[]){
    const ur=allUsers.find(x=>x.id===uid); if(!ur)return acc;
    const directs=allUsers.filter(x=>x.sponsorCode===uid&&x.role==='member');
    directs.forEach(d=>{ acc.push(d.id); getDownlineIds(d.id,acc); });
    return acc;
  }
  const downlineAll=allUsers.filter(x=>x.sponsorCode===u.id&&x.role==='member');
  const smallLine=Math.min(u.leftInvest||0,u.rightInvest||0);
  document.getElementById('net-direct-cnt').textContent=downlineAll.length;
  document.getElementById('net-left-pt').textContent=fmt(u.leftInvest||0);
  document.getElementById('net-right-pt').textContent=fmt(u.rightInvest||0);
  document.getElementById('net-small-line').textContent=fmt(smallLine);
  document.getElementById('my-invite-code').innerHTML=`<i class="fas fa-copy"></i> ${_esc(u.inviteCode)}`;
  // ì§ê¸‰ ì§„í–‰
  const rank=calcRank(smallLine);
  const nextRank=RANK_TABLE[rank.rank+1];
  const rankHtml=RANK_TABLE.slice(1).map(r=>{
    const achieved=smallLine>=r.minSmall;
    const isPaid=(u.paidRanks||[]).includes(r.rank);
    return `<div class="rank-row">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="rank-badge ${r.class}"><i class="fas fa-star"></i>${r.label}</div>
        <div style="font-size:14px;color:var(--text2);">ì†Œë¼ì¸ ${fmt(r.minSmall)}</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <div style="font-size:15px;font-weight:700;color:var(--gold);">${fmt(r.bonus)}</div>
        ${achieved?(isPaid?'<span class="stat-badge badge-up"><i class="fas fa-check"></i>ì§€ê¸‰ì™„ë£Œ</span>':'<span class="stat-badge badge-pend">ì§€ê¸‰ëŒ€ê¸°</span>'):('<div style="flex:1;max-width:160px;"><div class="progress-bar"><div class="progress-fill fill-gold" style="width:'+Math.min(100,smallLine/r.minSmall*100).toFixed(1)+'%"></div></div><div style="font-size:15px;color:var(--text3);margin-top:3px;">'+fmt(Math.max(0,r.minSmall-smallLine))+' ë” í•„ìš”</div></div>')}
      </div>
    </div>`;
  }).join('');
  document.getElementById('rank-progress-section').innerHTML=rankHtml;
  // íŠ¸ë¦¬
  const userMap={}; allUsers.forEach(x=>userMap[x.id]=x);
  renderTreeNode(u,userMap);
  // í•˜ìœ„ ëª©ë¡
  const dl=document.getElementById('downline-list');
  if(downlineAll.length===0){ dl.innerHTML='<div class="empty"><i class="fas fa-network-wired"></i><p>ì§ì¶”ì²œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'; }
  else{ dl.innerHTML=downlineAll.map(d=>`
    <div class="net-card">
      <div class="net-avatar">${d.name.charAt(0)}</div>
      <div style="flex:1;">
        <div class="net-name">${_esc(d.name)} ${d.suspended?'<span class="stat-badge badge-down">ì •ì§€</span>':''}</div>
        <div class="net-id">${_esc(d.id)}</div>
        <div class="net-meta">
          <div class="net-meta-item">íˆ¬ì: <b>${fmt(d.investment)}</b></div>
          <div class="net-meta-item">ê°€ì…: <b>${d.registeredAt}</b></div>
          <div class="net-meta-item">ì”ì•¡: <b>${fmt(d.wallet)}</b></div>
        </div>
      </div>
    </div>`).join(''); }
}
function renderTreeNode(u,userMap){
  const tree=document.getElementById('network-tree');
  const build=(uid,depth)=>{
    if(!uid||depth>4)return'';
    const user=userMap[uid]; if(!user)return'';
    const isSelf=uid===currentUser.id;
    const left=build(user.children?.left,depth+1);
    const right=build(user.children?.right,depth+1);
    const hasC=left||right;
    return `<div style="display:flex;flex-direction:column;align-items:center;">
      <div class="tree-node${isSelf?' self':''}${user.suspended?' suspended':''}">
        <div class="tree-node-name">${_esc(user.name)}</div>
        <div class="tree-node-id">${_esc(user.id)}</div>
        ${user.investment>0?`<div class="tree-node-amount">${fmt(user.investment)}</div>`:''}
      </div>
      ${hasC?`<div style="width:1px;height:20px;background:var(--border);"></div>
        <div style="display:flex;align-items:flex-start;gap:32px;">
          ${left?`<div style="display:flex;flex-direction:column;align-items:center;"><div style="height:20px;width:1px;background:var(--border);"></div>${left}</div>`:''}
          ${right?`<div style="display:flex;flex-direction:column;align-items:center;"><div style="height:20px;width:1px;background:var(--border);"></div>${right}</div>`:''}
        </div>`:''}
    </div>`;
  };
  tree.innerHTML=`<div style="display:flex;justify-content:center;">${build(u.id,0)}</div>`;
}
function copyInvite(){ navigator.clipboard.writeText(currentUser.inviteCode).then(()=>toast('ì´ˆëŒ€ ì½”ë“œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤: '+currentUser.inviteCode,'success')); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WALLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderWallet(){
  const u=await dbGet('users',currentUser.id); currentUser=u;
  wdStep=1; showWdStep(1);
  document.getElementById('wd-balance').textContent=fmtFull(u.wallet);
  document.getElementById('bank-name').value=u.bankName||'';
  document.getElementById('bank-holder').value=u.accountHolder||'';
  document.getElementById('bank-account').value=u.accountNumber||'';
  const allTx=await dbGetAll('transactions');
  const wdTx=allTx.filter(t=>t.userId===u.id&&t.type==='ì¶œê¸ˆ').sort((a,b)=>b.id-a.id);
  const pendingWd=await dbGetAll('pendingWithdrawals');
  const myPend=pendingWd.filter(w=>w.userId===u.id);
  const all=[...myPend.map(w=>({...w,status:'pending'})),...wdTx];
  const wdList=document.getElementById('wd-history-list');
  if(all.length===0){ wdList.innerHTML='<div class="empty"><i class="fas fa-inbox"></i><p>ì¶œê¸ˆ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>'; }
  else{ wdList.innerHTML=all.slice(0,10).map(w=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:var(--bg3);border-radius:var(--r);border:1px solid var(--border);">
      <div><div style="font-size:15px;font-weight:600;" class="mono">${fmtFull(w.amount)}</div>
        <div style="font-size:14px;color:var(--text3);margin-top:2px;">${w.requestedAt||w.date} Â· ìˆ˜ìˆ˜ë£Œ ${fmt(w.fee||0)}</div></div>
      <div style="text-align:right;">${statusHtml(w.status)}
        ${w.status==='completed'?`<div class="mono" style="font-size:14px;color:var(--green);margin-top:4px;">ì‹¤ìˆ˜ë ¹ ${fmt(w.netAmount||w.net)}</div>`:''}
      </div>
    </div>`).join(''); }
}
function calcWdFee(){
  const amt=parseInt(document.getElementById('wd-amount').value)||0;
  const prev=document.getElementById('wd-fee-preview');
  if(amt<=0){prev.style.display='none';return;}
  const fee=Math.floor(amt*CFG.WD_FEE);
  document.getElementById('wd-fee-req').textContent=fmtFull(amt);
  document.getElementById('wd-fee-fee').textContent='-'+fmtFull(fee);
  document.getElementById('wd-fee-net').textContent=fmtFull(amt-fee);
  prev.style.display='block';
}
function showWdStep(n){
  for(let i=1;i<=3;i++){
    document.getElementById('wd-step'+i).style.display=i===n?'block':'none';
    const s=document.getElementById('step'+i); s.classList.remove('active','done');
    if(i<n) s.classList.add('done'); else if(i===n) s.classList.add('active');
  }
  wdStep=n;
}
async function wdNextStep(n){
  if(n===2){
    wdAmountVal=parseInt(document.getElementById('wd-amount').value)||0;
    const u=await dbGet('users',currentUser.id);
    if(wdAmountVal<=0){toast('ì¶œê¸ˆ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
    if(wdAmountVal>u.wallet){toast('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤','error');return;}
    if(!u.bankName||!u.accountNumber){toast('ë¨¼ì € ê³„ì¢Œ ì •ë³´ë¥¼ ë“±ë¡í•˜ì„¸ìš”','error');return;}
    document.getElementById('wd-bank-info').innerHTML=`
      <div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:10px;font-size:15px;"><span style="color:var(--text2);">ì€í–‰</span><b>${_esc(u.bankName)}</b></div>
      <div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:10px;font-size:15px;"><span style="color:var(--text2);">ê³„ì¢Œë²ˆí˜¸</span><b class="mono">${_esc(u.accountNumber)}</b></div>
      <div style="display:flex;justify-content:space-between;padding:10px;background:var(--bg3);border-radius:10px;font-size:15px;"><span style="color:var(--text2);">ì˜ˆê¸ˆì£¼</span><b>${_esc(u.accountHolder)}</b></div>
    `;
  }
  if(n===3){
    const fee=Math.floor(wdAmountVal*CFG.WD_FEE);
    document.getElementById('wd-final-summary').innerHTML=`
      <div style="display:flex;justify-content:space-between;font-size:15px;"><span style="color:var(--text2);">ì¶œê¸ˆ ì‹ ì²­ì•¡</span><b class="mono">${fmtFull(wdAmountVal)}</b></div>
      <div style="display:flex;justify-content:space-between;font-size:15px;"><span style="color:var(--text2);">ìˆ˜ìˆ˜ë£Œ (${(CFG.WD_FEE*100).toFixed(1)}%)</span><b class="mono" style="color:var(--red);">-${fmtFull(fee)}</b></div>
      <div style="border-top:1px solid var(--border);padding-top:10px;display:flex;justify-content:space-between;font-size:14px;"><span>ì‹¤ìˆ˜ë ¹ ì˜ˆìƒì•¡</span><b class="mono" style="color:var(--green);">${fmtFull(wdAmountVal-fee)}</b></div>
    `;
  }
  showWdStep(n);
}
async function submitWithdrawal(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  if(u.suspended){toast('ê³„ì •ì´ ì •ì§€ë˜ì–´ ì¶œê¸ˆí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}
  if(wdAmountVal>u.wallet){toast('ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤','error');return;}
  const fee=Math.floor(wdAmountVal*CFG.WD_FEE);
  const wd={id:Date.now(),userId:u.id,userName:u.name,amount:wdAmountVal,fee,net:wdAmountVal-fee,
    bankName:u.bankName,accountNumber:u.accountNumber,accountHolder:u.accountHolder,
    requestedAt:localDateStr(new Date()),status:'pending'};
  await dbPut('pendingWithdrawals',wd);  // id ìˆìœ¼ë¯€ë¡œ fsPut ì‚¬ìš©
  u.wallet-=wdAmountVal;
  await dbPut('users',u); currentUser=u;
  await audit('WITHDRAW_REQUEST',`ì¶œê¸ˆì‹ ì²­ ${fmt(wdAmountVal)}`,u.id);
  toast('ì¶œê¸ˆ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ìŠ¹ì¸ í›„ ì²˜ë¦¬ë©ë‹ˆë‹¤','success');
  renderWallet();
}
async function updateBank(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  u.bankName=document.getElementById('bank-name').value.trim();
  u.accountHolder=document.getElementById('bank-holder').value.trim();
  u.accountNumber=document.getElementById('bank-account').value.trim();
  if(!u.bankName||!u.accountHolder||!u.accountNumber){toast('ëª¨ë“  ê³„ì¢Œ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  await dbPut('users',u); currentUser=u;
  toast('ê³„ì¢Œ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REPORTS & PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderReports(){
  const u=await dbGet('users',currentUser.id);
  const allTx=await dbGetAll('transactions');
  const myTx=allTx.filter(t=>t.userId===u.id);
  const roiTotal=myTx.filter(t=>t.type==='ROI').reduce((a,c)=>a+c.amount,0);
  const bonusTotal=myTx.filter(t=>['ë³´ë„ˆìŠ¤','ë°”ì´ë„ˆë¦¬','ì§ê¸‰ìˆ˜ë‹¹'].includes(t.type)).reduce((a,c)=>a+c.amount,0);
  const wdTotal=myTx.filter(t=>t.type==='ì¶œê¸ˆ').reduce((a,c)=>a+c.amount,0);
  document.getElementById('report-kpi').innerHTML=`
    <div class="stat-card card-gold"><div class="stat-label">ROI ëˆ„ì </div><div class="stat-value">${fmt(roiTotal)}</div></div>
    <div class="stat-card card-green"><div class="stat-label">ìˆ˜ë‹¹ í•©ê³„</div><div class="stat-value">${fmt(bonusTotal)}</div></div>
    <div class="stat-card card-red"><div class="stat-label">ì´ ì¶œê¸ˆ</div><div class="stat-value">${fmt(wdTotal)}</div></div>
  `;
  renderReportTable(myTx,reportFilter);
}
function filterReport(type,btn){
  reportFilter=type;
  document.querySelectorAll('#report-tabs .tab').forEach(t=>t.classList.remove('active'));
  btn.classList.add('active');
  dbGetAll('transactions').then(allTx=>{ const myTx=allTx.filter(t=>t.userId===currentUser.id); renderReportTable(myTx,type); });
}
function renderReportTable(myTx,filter){
  let filtered=myTx;
  if(filter==='roi') filtered=myTx.filter(t=>t.type==='ROI');
  else if(filter==='bonus') filtered=myTx.filter(t=>t.type==='ë³´ë„ˆìŠ¤');
  else if(filter==='binary') filtered=myTx.filter(t=>t.type==='ë°”ì´ë„ˆë¦¬');
  else if(filter==='rank') filtered=myTx.filter(t=>t.type==='ì§ê¸‰ìˆ˜ë‹¹');
  else if(filter==='withdrawal') filtered=myTx.filter(t=>t.type==='ì¶œê¸ˆ');
  else if(filter==='invest') filtered=myTx.filter(t=>t.type==='íˆ¬ì');
  const sorted=filtered.sort((a,b)=>b.id-a.id);
  const tbody=document.getElementById('report-table-body');
  if(sorted.length===0){ tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--text3);">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'; return; }
  tbody.innerHTML=sorted.map(t=>`<tr>
    <td style="color:var(--text3);font-size:14px;white-space:nowrap;">${t.date}</td>
    <td><span style="color:${typeColor(t.type)};font-size:14px;font-weight:600;">${typeLabel(t.type)}</span></td>
    <td style="font-size:14px;color:var(--text2);max-width:200px;overflow:hidden;">${_esc(t.desc||'')}</td>
    <td class="td-amount">${fmt(t.amount)}</td>
    <td class="td-amount" style="color:var(--red);">${t.fee>0?'-'+fmt(t.fee):'-'}</td>
    <td class="td-amount" style="color:var(--green);">${fmt(t.netAmount||t.amount)}</td>
    <td>${statusHtml(t.status)}</td>
  </tr>`).join('');
}
async function exportMembersExcel(){
  toast('íšŒì› ëª©ë¡ ì—‘ì…€ ìƒì„± ì¤‘...','info');
  try {
    const allUsers = await dbGetAll('users');
    // ê°€ì…ì¼ ìˆœì„œë¡œ ì •ë ¬
    const members = allUsers
      .filter(u => u.role === 'member')
      .sort((a,b) => (a.registeredAt||'').localeCompare(b.registeredAt||''));

    const RANK_LABELS = ['ì¼ë°˜','ë¸Œë¡ ì¦ˆ','ì‹¤ë²„','ê³¨ë“œ','í”Œë˜í‹°ë„˜','ë‹¤ì´ì•„'];

    // í—¤ë” ì •ì˜
    const headers = [
      'ë²ˆí˜¸','ì•„ì´ë””','ì´ë¦„','ì´ë©”ì¼','ì „í™”ë²ˆí˜¸',
      'ì¶”ì²œì¸','ê°€ì…ì¼','ìŠ¹ì¸ìƒíƒœ','ê³„ì •ìƒíƒœ',
      'íˆ¬ìê¸ˆ(ì›)','ëˆ„ì ROI(ì›)','ì¶œê¸ˆì”ì•¡(ì›)','ì”ì—¬í•œë„(ì›)',
      'ì€í–‰ëª…','ê³„ì¢Œë²ˆí˜¸','ì˜ˆê¸ˆì£¼',
      'ì§ê¸‰','ì¢Œì¸¡íˆ¬ì(ì›)','ìš°ì¸¡íˆ¬ì(ì›)',
      'ë§ˆì§€ë§‰ROIì¼','ë§ˆì§€ë§‰íˆ¬ìì¼','ë§ˆì§€ë§‰ë¡œê·¸ì¸'
    ];

    // ë°ì´í„° í–‰ ìƒì„±
    const rows = members.map((u, i) => {
      const sl = Math.min(u.leftInvest||0, u.rightInvest||0);
      const rankObj = calcRank(sl);
      const maxPayout = u.investment * (CFG.MAX_PAYOUT||3);
      const remaining = Math.max(0, maxPayout - (u.roi||0));
      return [
        i + 1,
        u.id || '',
        u.name || '',
        u.email || '',
        u.phone || '',
        (u.sponsorCode && u.sponsorCode !== 'SYSTEM-ROOT') ? u.sponsorCode : 'ì§ê°€ì…',
        u.registeredAt || '',
        u.approvalStatus === 'approved' ? 'ìŠ¹ì¸' : u.approvalStatus === 'pending' ? 'ëŒ€ê¸°ì¤‘' : 'ê±°ë¶€',
        u.suspended ? 'ì •ì§€' : 'ì •ìƒ',
        u.investment || 0,
        u.roi || 0,
        u.wallet || 0,
        remaining,
        u.bankName || '',
        u.accountNumber || '',
        u.accountHolder || '',
        rankObj.label || 'ì¼ë°˜',
        u.leftInvest || 0,
        u.rightInvest || 0,
        u.lastRoiDate || '',
        u.lastInvestmentDate || '',
        u.lastLogin || ''
      ];
    });

    // ì›Œí¬ë¶ ìƒì„±
    const wb = XLSX.utils.book_new();
    const wsData = [headers, ...rows];
    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // ì»¬ëŸ¼ ë„ˆë¹„ ì„¤ì •
    ws['!cols'] = [
      {wch:6},{wch:14},{wch:12},{wch:26},{wch:16},
      {wch:12},{wch:14},{wch:10},{wch:8},
      {wch:16},{wch:16},{wch:16},{wch:16},
      {wch:12},{wch:18},{wch:12},
      {wch:10},{wch:16},{wch:16},
      {wch:14},{wch:14},{wch:18}
    ];

    // í—¤ë” í–‰ ìŠ¤íƒ€ì¼ (ë°°ê²½ìƒ‰)
    const range = XLSX.utils.decode_range(ws['!ref']);
    for(let C = range.s.c; C <= range.e.c; C++){
      const cellAddr = XLSX.utils.encode_cell({r:0, c:C});
      if(!ws[cellAddr]) continue;
      ws[cellAddr].s = {
        fill:{fgColor:{rgb:'1A1A2E'}},
        font:{bold:true, color:{rgb:'D4A853'}, sz:12},
        alignment:{horizontal:'center', vertical:'center'},
        border:{bottom:{style:'medium', color:{rgb:'D4A853'}}}
      };
    }

    // ìˆ«ì ì»¬ëŸ¼ ì²œ ë‹¨ìœ„ í¬ë§·
    const numCols = [9,10,11,12,17,18]; // 0-indexed
    for(let R = 1; R <= rows.length; R++){
      for(const C of numCols){
        const cellAddr = XLSX.utils.encode_cell({r:R, c:C});
        if(ws[cellAddr] && typeof ws[cellAddr].v === 'number'){
          ws[cellAddr].z = '#,##0';
        }
      }
    }

    XLSX.utils.book_append_sheet(wb, ws, 'íšŒì›ëª©ë¡');

    // ìš”ì•½ ì‹œíŠ¸ ì¶”ê°€
    const today = localDateStr(new Date());
    const totalInvest = members.reduce((s,u) => s+(u.investment||0), 0);
    const totalWallet = members.reduce((s,u) => s+(u.wallet||0), 0);
    const totalRoi = members.reduce((s,u) => s+(u.roi||0), 0);
    const activeCount = members.filter(u => u.investment > 0 && !u.suspended).length;
    const pendingCount = members.filter(u => u.approvalStatus === 'pending').length;
    const suspendedCount = members.filter(u => u.suspended).length;

    const summaryData = [
      ['MEDI WORLD íšŒì› í˜„í™© ìš”ì•½', ''],
      ['ì¶”ì¶œì¼', today],
      ['', ''],
      ['í•­ëª©', 'ìˆ˜ì¹˜'],
      ['ì „ì²´ íšŒì› ìˆ˜', members.length],
      ['íˆ¬ì ì¤‘ íšŒì›', activeCount],
      ['ìŠ¹ì¸ ëŒ€ê¸°', pendingCount],
      ['ê³„ì • ì •ì§€', suspendedCount],
      ['', ''],
      ['ì´ íˆ¬ìê¸ˆ', totalInvest],
      ['ì´ ëˆ„ì ROI', totalRoi],
      ['ì´ ì¶œê¸ˆì”ì•¡', totalWallet],
    ];
    const ws2 = XLSX.utils.aoa_to_sheet(summaryData);
    ws2['!cols'] = [{wch:20},{wch:20}];
    XLSX.utils.book_append_sheet(wb, ws2, 'ìš”ì•½');

    // ë‹¤ìš´ë¡œë“œ
    const filename = `MEDIWORLD_íšŒì›ëª©ë¡_${today.replace(/-/g,'')}.xlsx`;
    XLSX.writeFile(wb, filename);
    toast(`âœ… ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ! (${members.length}ëª…)`, 'success');

  } catch(e) {
    console.error(e);
    toast('ì—‘ì…€ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
  }
}

async function exportReports(){
  const allTx=await dbGetAll('transactions');
  const myTx=currentUser.role==='admin'?allTx:allTx.filter(t=>t.userId===currentUser.id);
  const header='ë‚ ì§œ,íšŒì›ID,ìœ í˜•,ë‚´ìš©,ê¸ˆì•¡,ìˆ˜ìˆ˜ë£Œ,ì‹¤ìˆ˜ë ¹,ìƒíƒœ\n';
  const rows=myTx.map(t=>`${t.date},${t.userId},${typeLabel(t.type)},"${(t.desc||'').replace(/"/g,'""')}",${t.amount},${t.fee||0},${t.netAmount||t.amount},${t.status}`).join('\n');
  const blob=new Blob(['\uFEFF'+header+rows],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mediworld_report.csv'; a.click();
  toast('CSV ë‹¤ìš´ë¡œë“œ ì‹œì‘','success');
}
async function renderProfile(){
  const u=await dbGet('users',currentUser.id);
  document.getElementById('prof-name').value=u.name;
  document.getElementById('prof-email').value=u.email||'';
  document.getElementById('prof-phone').value=u.phone||'';
  document.getElementById('prof-last-login').textContent=u.lastLogin||'ê¸°ë¡ ì—†ìŒ';
  document.getElementById('profile-info').innerHTML=`
    <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);"><span style="font-size:14px;color:var(--text3);">ì•„ì´ë””</span><span class="mono" style="font-size:15px;">${_esc(u.id)}</span></div>
    <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);"><span style="font-size:14px;color:var(--text3);">ì´ˆëŒ€ ì½”ë“œ</span><span class="mono" style="font-size:15px;color:var(--gold);">${_esc(u.inviteCode)}</span></div>
    <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border);"><span style="font-size:14px;color:var(--text3);">ì¶”ì²œì¸</span><span style="font-size:15px;">${u.sponsorCode==='SYSTEM-ROOT'||!u.sponsorCode?'ì§ê°€ì…':_esc(u.sponsorCode)}</span></div>
    <div style="display:flex;justify-content:space-between;padding:12px 0;"><span style="font-size:14px;color:var(--text3);">ê°€ì…ì¼</span><span style="font-size:15px;">${u.registeredAt}</span></div>
  `;
}
async function saveProfile(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  u.name=document.getElementById('prof-name').value.trim()||u.name;
  u.email=document.getElementById('prof-email').value.trim();
  u.phone=document.getElementById('prof-phone').value.trim();
  await dbPut('users',u); currentUser=u; setupTopbar();
  toast('í”„ë¡œí•„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤','success');
}
// â”€â”€ íšŒì› ìƒì„¸ ëª¨ë‹¬ í•¨ìˆ˜ë“¤ â”€â”€
async function openMemberDetail(uid){
  _detailUserId=uid;
  const u=await dbGet('users',uid);
  if(!u){toast('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}
  const sl=Math.min(u.leftInvest||0,u.rightInvest||0);
  const rank=calcRank(sl);
  const max=u.investment*(CFG.MAX_PAYOUT||3);
  const statusHtml2=u.suspended?'<span class="status status-fail">ì •ì§€</span>':
    u.approvalStatus==='pending'?'<span class="status status-pend">ìŠ¹ì¸ëŒ€ê¸°</span>':
    u.investment>0?'<span class="status status-done">íˆ¬ìì¤‘</span>':'<span class="status status-stop">ë¯¸íˆ¬ì</span>';

  // í—¤ë”
  document.getElementById('mmd-title').textContent=`${_esc(u.name)} (${_esc(u.id)})`;
  document.getElementById('mmd-subtitle').innerHTML=`${statusHtml2} &nbsp; ê°€ì…ì¼: ${u.registeredAt||'-'} &nbsp; ë§ˆì§€ë§‰ ë¡œê·¸ì¸: ${u.lastLogin||'-'}`;

  // ì²« íƒ­ìœ¼ë¡œ ì´ˆê¸°í™”
  switchMmdTab('info', document.getElementById('mmd-tab-info'));

  // â”€â”€ íƒ­1: ê¸°ë³¸ ì •ë³´ (ìˆ˜ì • ê°€ëŠ¥) â”€â”€
  document.getElementById('mmd-tab-info-body').innerHTML=`
    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;color:var(--gold);margin-bottom:14px;">ğŸ‘¤ ê°œì¸ ì •ë³´ ìˆ˜ì •</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì´ë¦„</div>
          <input class="form-input" id="edit-name" value="${_esc(u.name||'')}" placeholder="ì´ë¦„">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì•„ì´ë”” (ë³€ê²½ë¶ˆê°€)</div>
          <input class="form-input" value="${_esc(u.id)}" disabled style="opacity:0.5;cursor:not-allowed;">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì´ë©”ì¼</div>
          <input class="form-input" id="edit-email" type="email" value="${_esc(u.email||'')}" placeholder="ì´ë©”ì¼ ì£¼ì†Œ">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì—°ë½ì²˜ (ì „í™”ë²ˆí˜¸)</div>
          <input class="form-input" id="edit-phone" type="tel" value="${_esc(u.phone||'')}" placeholder="010-0000-0000">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì¶”ì²œì¸ ì½”ë“œ</div>
          <input class="form-input" id="edit-sponsor" value="${_esc(u.sponsorCode&&u.sponsorCode!=='SYSTEM-ROOT'?u.sponsorCode:'')}" placeholder="ì¶”ì²œì¸ ì•„ì´ë””">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì´ˆëŒ€ ì½”ë“œ</div>
          <input class="form-input" value="${_esc(u.inviteCode||u.id)}" disabled style="opacity:0.5;">
        </div>
      </div>
      <div style="margin-top:12px;">
        <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥)</div>
        <input class="form-input" id="edit-newpwd" type="password" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (8ì ì´ìƒ, ë¹„ì›Œë‘ë©´ ë³€ê²½ ì•ˆ í•¨)">
      </div>
      <button class="btn btn-primary btn-sm" style="margin-top:14px;width:100%;" onclick="adminSaveBasicInfo()">
        <i class="fas fa-save"></i> ê¸°ë³¸ ì •ë³´ ì €ì¥
      </button>
    </div>

    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;">
      <div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:14px;">ğŸ“Š íˆ¬ì í˜„í™© (ì½ê¸° ì „ìš©)</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div style="background:var(--bg2);border-radius:12px;padding:14px;text-align:center;">
          <div style="font-size:13px;color:var(--text2);margin-bottom:6px;">ì§ê¸‰</div>
          <div class="rank-badge ${rank.class}" style="font-size:14px;display:inline-flex;">${rank.label}</div>
        </div>
        <div style="background:var(--bg2);border-radius:12px;padding:14px;text-align:center;">
          <div style="font-size:13px;color:var(--text2);margin-bottom:6px;">L/R íˆ¬ì</div>
          <div class="mono" style="font-size:16px;font-weight:700;">${fmt(u.leftInvest||0)} / ${fmt(u.rightInvest||0)}</div>
        </div>
        <div style="background:var(--bg2);border-radius:12px;padding:14px;text-align:center;">
          <div style="font-size:13px;color:var(--text2);margin-bottom:6px;">ë§ˆì§€ë§‰ ROI</div>
          <div style="font-size:15px;font-weight:700;">${u.lastRoiDate||'-'}</div>
        </div>
        <div style="background:var(--bg2);border-radius:12px;padding:14px;text-align:center;">
          <div style="font-size:13px;color:var(--text2);margin-bottom:6px;">ê°€ì…ì¼</div>
          <div style="font-size:15px;font-weight:700;">${u.registeredAt||'-'}</div>
        </div>
      </div>
    </div>
  `;

  // â”€â”€ íƒ­2: ê¸ˆìœµ ì •ë³´ (ìˆ˜ì • ê°€ëŠ¥) â”€â”€
  document.getElementById('mmd-tab-finance-body').innerHTML=`
    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;color:var(--green);margin-bottom:14px;">ğŸ’³ ì¶œê¸ˆ ê³„ì¢Œ ì •ë³´</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì€í–‰ëª…</div>
          <input class="form-input" id="edit-bank" value="${_esc(u.bankName||'')}" placeholder="êµ­ë¯¼ì€í–‰">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ê³„ì¢Œë²ˆí˜¸</div>
          <input class="form-input mono" id="edit-account" value="${_esc(u.accountNumber||'')}" placeholder="000-0000-0000">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì˜ˆê¸ˆì£¼</div>
          <input class="form-input" id="edit-holder" value="${_esc(u.accountHolder||'')}" placeholder="í™ê¸¸ë™">
        </div>
      </div>
      <button class="btn btn-success btn-sm" style="margin-top:14px;width:100%;" onclick="adminSaveBankInfo()">
        <i class="fas fa-save"></i> ê³„ì¢Œ ì •ë³´ ì €ì¥
      </button>
    </div>

    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;color:var(--gold);margin-bottom:14px;">âœï¸ ê¸ˆì•¡ ì§ì ‘ ìˆ˜ì •</div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">íˆ¬ìê¸ˆ (ì›)</div>
          <input class="form-input mono" id="admin-edit-investment" type="number" value="${u.investment}">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ëˆ„ì ROI (ì›)</div>
          <input class="form-input mono" id="admin-edit-roi" type="number" value="${u.roi}">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì¶œê¸ˆì”ì•¡ (ì›)</div>
          <input class="form-input mono" id="admin-edit-wallet" type="number" value="${u.wallet}">
        </div>
      </div>
      <button class="btn btn-sm" style="margin-top:14px;width:100%;background:var(--gold);color:#000;font-weight:800;" onclick="adminEditAmounts()">
        <i class="fas fa-edit"></i> ê¸ˆì•¡ ìˆ˜ì • ì €ì¥
      </button>
    </div>

    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;">
      <div style="font-size:16px;font-weight:800;color:var(--blue);margin-bottom:14px;">ğŸ’¸ ì”ì•¡ ê¸´ê¸‰ ì¶”ê°€</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì¶”ê°€ ê¸ˆì•¡ (ì›)</div>
          <input class="form-input mono" id="admin-add-wallet-amount" type="number" placeholder="ê¸ˆì•¡ ì…ë ¥">
        </div>
        <div>
          <div style="font-size:14px;color:var(--text2);margin-bottom:6px;font-weight:700;">ì§€ê¸‰ ì‚¬ìœ </div>
          <input class="form-input" id="admin-add-wallet-desc" placeholder="ì˜ˆ: ì´ë²¤íŠ¸ ë³´ë„ˆìŠ¤">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;">
        <button class="btn btn-success btn-sm" onclick="adminAddWallet()">
          <i class="fas fa-plus"></i> ì”ì•¡ ì¶”ê°€
        </button>
        <button class="btn btn-purple btn-sm" onclick="adminManualRoi()">
          <i class="fas fa-coins"></i> ROI ìˆ˜ë™ ì§€ê¸‰
        </button>
      </div>
    </div>
  `;

  // â”€â”€ íƒ­3: ê³„ì • ê´€ë¦¬ â”€â”€
  document.getElementById('mmd-tab-account-body').innerHTML=`
    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;margin-bottom:16px;">
      <div style="font-size:16px;font-weight:800;color:var(--text);margin-bottom:16px;">ğŸ” ê³„ì • ìƒíƒœ</div>
      <div style="display:flex;flex-direction:column;gap:10px;font-size:16px;margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:12px;">
          <span style="color:var(--text2);font-weight:600;">í˜„ì¬ ìƒíƒœ</span>
          <span>${statusHtml2}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:12px;">
          <span style="color:var(--text2);font-weight:600;">ê°€ì… ìŠ¹ì¸ ìƒíƒœ</span>
          <span class="mono" style="font-weight:700;">${u.approvalStatus==='approved'?'âœ… ìŠ¹ì¸ë¨':'â³ ëŒ€ê¸°ì¤‘'}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:12px;">
          <span style="color:var(--text2);font-weight:600;">ê³„ì • ì •ì§€ ì—¬ë¶€</span>
          <span class="mono" style="font-weight:700;color:${u.suspended?'var(--red)':'var(--green)'};">${u.suspended?'ğŸš« ì •ì§€ë¨':'âœ… ì •ìƒ'}</span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:var(--bg2);border-radius:12px;">
          <span style="color:var(--text2);font-weight:600;">ë§ˆì§€ë§‰ ë¡œê·¸ì¸</span>
          <span style="font-weight:700;">${u.lastLogin||'-'}</span>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <button class="btn btn-sm ${u.suspended?'btn-success':'btn-danger'}" style="min-height:52px;" onclick="toggleSuspend('${_esc(uid)}')">
          <i class="fas fa-${u.suspended?'unlock':'ban'}"></i>
          ${u.suspended?'ê³„ì • ì •ì§€ í•´ì œ':'ê³„ì • ì •ì§€'}
        </button>
        <button class="btn btn-danger btn-sm" style="min-height:52px;" onclick="adminDeleteMember('${_esc(uid)}')">
          <i class="fas fa-trash"></i> íšŒì› ì‚­ì œ
        </button>
      </div>
    </div>

    <div style="background:var(--bg3);border-radius:var(--r);padding:18px;">
      <div style="font-size:16px;font-weight:800;color:var(--red);margin-bottom:10px;">âš ï¸ ì£¼ì˜ì‚¬í•­</div>
      <div style="font-size:15px;color:var(--text2);line-height:1.8;">
        â€¢ ê³„ì • ì •ì§€: í•´ë‹¹ íšŒì›ì€ ë¡œê·¸ì¸ ë¶ˆê°€<br>
        â€¢ íšŒì› ì‚­ì œ: ëª¨ë“  ë°ì´í„° ì˜êµ¬ ì‚­ì œ (ë³µêµ¬ ë¶ˆê°€)<br>
        â€¢ ê¸ˆì•¡ ìˆ˜ì •: ê±°ë˜ ë‚´ì—­ì€ ìë™ ê¸°ë¡ë¨
      </div>
    </div>
  `;

  document.getElementById('modal-member-detail').classList.remove('hidden');
}

function closeMemberDetail(){
  document.getElementById('modal-member-detail').classList.add('hidden');
  _detailUserId=null;
}
async function adminSaveBasicInfo(){
  if(!_detailUserId)return;
  const u=await dbGet('users',_detailUserId);
  if(!u){toast('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}
  const newName=document.getElementById('edit-name').value.trim();
  const newEmail=document.getElementById('edit-email').value.trim();
  const newPhone=document.getElementById('edit-phone').value.trim();
  const newSponsor=document.getElementById('edit-sponsor').value.trim();
  const newPwd=document.getElementById('edit-newpwd').value;
  if(!newName){toast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  u.name=newName;
  u.email=newEmail;
  u.phone=newPhone;
  if(newSponsor) u.sponsorCode=newSponsor;
  if(newPwd){
    if(!_sanitizePwd(newPwd)){toast('ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ìˆ«ì í¬í•¨ì´ì–´ì•¼ í•©ë‹ˆë‹¤','error');return;}
    u.pwd=await _hashPwdSecure(newPwd);
  }
  await dbPut('users',u);
  await audit('ADMIN_EDIT_INFO',`ê¸°ë³¸ì •ë³´ ìˆ˜ì • [${u.id}] ì´ë¦„:${newName} ì´ë©”ì¼:${newEmail} ì „í™”:${newPhone}`,'admin');
  toast(`âœ… ${newName} ê¸°ë³¸ ì •ë³´ ì €ì¥ ì™„ë£Œ`,'success');
  openMemberDetail(_detailUserId);
}

async function adminSaveBankInfo(){
  if(!_detailUserId)return;
  const u=await dbGet('users',_detailUserId);
  if(!u){toast('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}
  u.bankName=document.getElementById('edit-bank').value.trim();
  u.accountNumber=document.getElementById('edit-account').value.trim();
  u.accountHolder=document.getElementById('edit-holder').value.trim();
  await dbPut('users',u);
  await audit('ADMIN_EDIT_BANK',`ê³„ì¢Œ ìˆ˜ì • [${u.id}] ${u.bankName} ${u.accountNumber} ${u.accountHolder}`,'admin');
  toast(`âœ… ${u.name} ê³„ì¢Œ ì •ë³´ ì €ì¥ ì™„ë£Œ`,'success');
  openMemberDetail(_detailUserId);
}

async function adminDeleteMember(uid){
  showModal('íšŒì› ì‚­ì œ',`[${uid}] íšŒì›ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤. ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,async()=>{
    await dbDelete('users',uid);
    await audit('DELETE_MEMBER',`íšŒì› ì‚­ì œ: ${uid}`,'admin');
    toast(`íšŒì› [${uid}]ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤`,'success');
    closeMemberDetail();
    renderAdmin();
  },'ì‚­ì œ','btn-danger');
}

async function toggleSuspend(uid){
  const u=await dbGet('users',uid);
  u.suspended=!u.suspended;
  await dbPut('users',u);
  await audit('SUSPEND',`ê³„ì • ${u.suspended?'ì •ì§€':'í•´ì œ'} ëŒ€ìƒ:${uid}`,'admin');
  toast(`${u.name} ê³„ì •ì´ ${u.suspended?'ì •ì§€':'í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤`,u.suspended?'error':'success');
  openMemberDetail(uid);
}
async function adminManualRoi(){
  if(!_detailUserId)return;
  const u=await dbGet('users',_detailUserId);
  if(!u||u.investment===0){toast('íˆ¬ì ì›ê¸ˆì´ ì—†ìŠµë‹ˆë‹¤','error');return;}
  const max=u.investment*(CFG.MAX_PAYOUT||3);
  if(u.roi>=max){toast('ì´ë¯¸ ìµœëŒ€ ìˆ˜ìµ í•œë„ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤','error');return;}
  const payout=Math.round(u.investment*(CFG.DAILY_ROI||0.01));
  const actual=Math.min(payout,max-u.roi);
  const today=localDateStr(new Date());
  u.roi+=actual; u.wallet+=actual; u.lastRoiDate=today;
  await dbPut('users',u);
  await dbPut('transactions',{id:Date.now(),userId:u.id,type:'ROI',amount:actual,fee:0,netAmount:actual,date:today,status:'completed',desc:'ê´€ë¦¬ì ìˆ˜ë™ ë°°ë‹¹ ì§€ê¸‰'});
  await audit('MANUAL_ROI',`ìˆ˜ë™ë°°ë‹¹ ${fmt(actual)} ëŒ€ìƒ:${u.id}`,'admin');
  toast(`${u.name}ì—ê²Œ ${fmt(actual)} ìˆ˜ë™ ì§€ê¸‰ ì™„ë£Œ`,'success');
  closeMemberDetail(); renderAdmin();
}
async function adminAddWallet(){
  if(!_detailUserId)return;
  const amt=parseInt(document.getElementById('admin-add-wallet-amount').value)||0;
  const desc=document.getElementById('admin-add-wallet-desc').value.trim();
  if(amt<=0){toast('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  const u=await dbGet('users',_detailUserId);
  u.wallet+=amt; u.roi+=amt;
  await dbPut('users',u);
  await dbPut('transactions',{id:Date.now(),userId:u.id,type:'ROI',amount:amt,fee:0,netAmount:amt,date:localDateStr(new Date()),status:'completed',desc:desc||'ê´€ë¦¬ì ìˆ˜ë™ ì”ì•¡ ì¶”ê°€'});
  await audit('ADD_WALLET',`ì”ì•¡ì¶”ê°€ ${fmt(amt)} ëŒ€ìƒ:${u.id} ì‚¬ìœ :${desc}`,'admin');
  toast(`${u.name}ì—ê²Œ ${fmt(amt)} ì¶”ê°€ ì™„ë£Œ`,'success');
  closeMemberDetail(); renderAdmin();
}
async function adminEditAmounts(){
  if(!_detailUserId)return;
  const u=await dbGet('users',_detailUserId);
  if(!u){toast('íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}

  const newInvestment=parseInt(document.getElementById('admin-edit-investment').value);
  const newRoi=parseInt(document.getElementById('admin-edit-roi').value);
  const newWallet=parseInt(document.getElementById('admin-edit-wallet').value);

  if(isNaN(newInvestment)||isNaN(newRoi)||isNaN(newWallet)){
    toast('ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;
  }
  if(newInvestment<0||newRoi<0||newWallet<0){
    toast('ê¸ˆì•¡ì€ 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤','error');return;
  }

  const oldInv=u.investment, oldRoi=u.roi, oldWallet=u.wallet;
  u.investment=newInvestment;
  u.roi=newRoi;
  u.wallet=newWallet;
  await dbPut('users',u);

  const today=localDateStr(new Date());
  await audit('ADMIN_EDIT_AMOUNTS',
    `ê¸ˆì•¡ìˆ˜ì • [${u.id}] íˆ¬ì:${fmt(oldInv)}â†’${fmt(newInvestment)} ROI:${fmt(oldRoi)}â†’${fmt(newRoi)} ì”ì•¡:${fmt(oldWallet)}â†’${fmt(newWallet)}`,
    'admin');

  toast(`âœ… ${u.name} ê¸ˆì•¡ ìˆ˜ì • ì™„ë£Œ`,'success');
  closeMemberDetail();
  renderAdmin();
}
async function rejectInvestment(id){
  const invId=String(id);
  showModal('íˆ¬ì ê±°ë¶€','ì´ íˆ¬ì ì‹ ì²­ì„ ê±°ë¶€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',async()=>{
    try{
      await dbDelete('pendingInvestments',invId);
      await audit('INV_REJECT','íˆ¬ì ê±°ë¶€','admin');
      // DOM ì¦‰ì‹œ ì œê±°
      const itemEl=document.querySelector(`[data-inv-id="${invId}"]`);
      if(itemEl) itemEl.remove();
      const list=document.getElementById('admin-invest-list');
      if(list&&list.children.length===0) list.innerHTML='<div class="empty"><i class="fas fa-check-circle" style="color:var(--green);"></i><p>ëŒ€ê¸° ì¤‘ì¸ íˆ¬ì ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
      toast('íˆ¬ì ì‹ ì²­ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤');
      await renderAdmin();
    }catch(e){ toast('ê±°ë¶€ ì˜¤ë¥˜: '+e.message,'error'); }
  },'ê±°ë¶€','btn-danger');
}
async function rejectWithdrawal(id){
  showModal('ì¶œê¸ˆ ê±°ë¶€','ì¶œê¸ˆì„ ê±°ë¶€í•˜ê³  ì”ì•¡ì„ ë°˜í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',async()=>{
    const wd=await dbGet('pendingWithdrawals',id); if(!wd)return;
    const user=await dbGet('users',wd.userId);
    if(user){user.wallet+=wd.amount; await dbPut('users',user);}
    await dbDelete('pendingWithdrawals',id);
    await audit('WD_REJECT',`ì¶œê¸ˆ ê±°ë¶€+ë°˜í™˜ ${fmt(wd.amount)} íšŒì›:${wd.userId}`,'admin');
    toast('ì¶œê¸ˆì´ ê±°ë¶€ë˜ì—ˆê³  ì”ì•¡ì´ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤');
    renderAdmin();
  },'ê±°ë¶€ ë° ë°˜í™˜','btn-danger');
}

async function changeAdminPassword(){
  if(!_validateSession())return;
  const cur=document.getElementById('admin-pw-current').value;
  const nw=document.getElementById('admin-pw-new').value;
  const cf=document.getElementById('admin-pw-confirm').value;
  if(!cur||!nw||!cf){toast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  const u=await dbGet('users',currentUser.id);
  if(!u){toast('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}
  if(!await _verifyPwdSecure(cur,u.pwd)){toast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤','error');return;}
  if(!_sanitizePwd(nw)){toast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ìˆ«ì í¬í•¨ì´ì–´ì•¼ í•©ë‹ˆë‹¤','error');return;}
  if(nw!==cf){toast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤','error');return;}
  if(nw===cur){toast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  u.pwd=await _hashPwdSecure(nw);
  u._mustChangePwd=false;
  u._pwdChangedAt=localDateStr(new Date());
  await dbPut('users',u);
  currentUser=u;
  document.getElementById('admin-pw-current').value='';
  document.getElementById('admin-pw-new').value='';
  document.getElementById('admin-pw-confirm').value='';
  await audit('PWD_CHANGE','ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ ë³€ê²½',u.id);
  toast('âœ… ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!','success');
}
async function changePassword(){
  if(!_validateSession())return;
  const u=await dbGet('users',currentUser.id);
  const cur=document.getElementById('pw-current').value;
  const nw=document.getElementById('pw-new').value;
  const cf=document.getElementById('pw-confirm').value;
  if(!await _verifyPwdSecure(cur,u.pwd)){toast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë¦½ë‹ˆë‹¤','error');return;}
  if(!_sanitizePwd(nw)){toast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 8ì ì´ìƒ, ìˆ«ì í¬í•¨ì´ì–´ì•¼ í•©ë‹ˆë‹¤','error');return;}
  if(nw!==cf){toast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤','error');return;}
  if(nw===cur){toast('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  u.pwd=await _hashPwdSecure(nw);
  await dbPut('users',u); currentUser=u;
  document.getElementById('pw-current').value='';document.getElementById('pw-new').value='';document.getElementById('pw-confirm').value='';
  await audit('PWD_CHANGE','ë¹„ë°€ë²ˆí˜¸ ë³€ê²½',u.id);
  toast('ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤','success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderAdmin(){
  if(currentUser.role!=='admin')return;

  // â˜… ì´ˆê¸° ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ê²½ê³ 
  const adminUser=await dbGet('users',currentUser.id);
  if(adminUser && adminUser._mustChangePwd){
    const warnEl=document.getElementById('admin-pwd-warn');
    if(warnEl) warnEl.style.display='flex';
  }

  const allUsers=await dbGetAll('users');
  const members=allUsers.filter(u=>u.role==='member');
  const pendInv=await dbGetAll('pendingInvestments');
  const pendWd=await dbGetAll('pendingWithdrawals');
  const allTx=await dbGetAll('transactions');
  const totalInvest=members.reduce((a,u)=>a+u.investment,0);
  const totalRoi=members.reduce((a,u)=>a+u.roi,0);
  const totalWallet=members.reduce((a,u)=>a+u.wallet,0);
  document.getElementById('admin-kpi').innerHTML=`
    <div class="stat-card card-gold"><div class="stat-label">ì´ íšŒì›</div><div class="stat-value">${members.length}</div><div class="stat-sub">ëª…</div></div>
    <div class="stat-card card-blue"><div class="stat-label">ì´ íˆ¬ìê¸ˆ</div><div class="stat-value">${fmt(totalInvest)}</div></div>
    <div class="stat-card card-green"><div class="stat-label">ì´ ROI ì§€ê¸‰</div><div class="stat-value">${fmt(totalRoi)}</div></div>
    <div class="stat-card"><div class="stat-label">ì´ ì”ì•¡</div><div class="stat-value">${fmt(totalWallet)}</div></div>
  `;
  // ë°°ì§€
  const pendApproval=allUsers.filter(u=>u.role==='member'&&u.approvalStatus==='pending');
  document.getElementById('appr-badge').textContent=pendApproval.length>0?pendApproval.length:'';
  document.getElementById('inv-badge').textContent=pendInv.length>0?pendInv.length:'';
  document.getElementById('wd-badge').textContent=pendWd.length>0?pendWd.length:'';
  // ìˆ˜ë‹¹ ì„¤ì •
  document.getElementById('ov-roi').value=(CFG.DAILY_ROI*100).toFixed(1);
  document.getElementById('ov-direct').value=(CFG.DIRECT_BONUS*100).toFixed(1);
  document.getElementById('ov-binary').value=(CFG.BINARY_BONUS*100).toFixed(1);
  document.getElementById('ov-maxpayout').value=(CFG.MAX_PAYOUT*100).toFixed(0);
  document.getElementById('ov-wdfee').value=(CFG.WD_FEE*100).toFixed(1);
  // ì…ê¸ˆ ê³„ì¢Œ
  document.getElementById('admin-bank-name').value=CFG.DEPOSIT_BANK;
  document.getElementById('admin-bank-account').value=CFG.DEPOSIT_ACCOUNT;
  document.getElementById('admin-bank-holder').value=CFG.DEPOSIT_HOLDER;
  // íƒ­
  const tab=adminCurrentTab;
  ['overview','approval','members','investments','withdrawals','logs'].forEach(t=>{
    const el=document.getElementById('admin-tab-'+t); if(el) el.style.display=t===tab?'block':'none';
  });
  if(tab==='overview') renderAdminOverview(members);
  if(tab==='approval') renderAdminApproval(pendApproval);
  if(tab==='members') renderAdminMembers(members);
  if(tab==='investments') renderAdminInvestments(pendInv);
  if(tab==='withdrawals') renderAdminWithdrawals(pendWd);
  if(tab==='logs') renderAdminLogs(allTx);
}
function renderAdminApproval(pendList){
  const el=document.getElementById('admin-approval-list');
  if(!pendList||pendList.length===0){
    el.innerHTML='<div style="padding:40px;text-align:center;color:var(--text3);font-size:14px;">âœ… ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ê°€ì… ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }
  el.innerHTML=`
    <div class="table-wrap">
      <table>
        <thead><tr><th>ì•„ì´ë””</th><th>ì´ë¦„</th><th>ì—°ë½ì²˜</th><th>ì´ë©”ì¼</th><th>ì¶”ì²œì¸</th><th>ì‹ ì²­ì¼</th><th>ì²˜ë¦¬</th></tr></thead>
        <tbody>
          ${pendList.map(u=>`
            <tr>
              <td><span style="font-weight:700;font-family:monospace;">${_esc(u.id)}</span></td>
              <td>${_esc(u.name)}</td>
              <td>${_esc(u.phone||'-')}</td>
              <td style="font-size:14px;">${_esc(u.email||'-')}</td>
              <td>${u.sponsorCode?_esc(u.sponsorCode):'<span style="color:var(--text3);">ì—†ìŒ</span>'}</td>
              <td style="font-size:14px;color:var(--text3);">${_esc(u.registeredAt)}</td>
              <td>
                <div style="display:flex;gap:6px;">
                  <button class="btn btn-success btn-sm" onclick="approveUser('${u.id}')">âœ… ìŠ¹ì¸</button>
                  <button class="btn btn-danger btn-sm" onclick="rejectUser('${u.id}')">âŒ ê±°ë¶€</button>
                </div>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    </div>
  `;
}
async function approveUser(userId){
  if(!confirm(`[${userId}] íšŒì›ì˜ ê°€ì…ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  const u=await dbGet('users',userId);
  if(!u)return;
  u.approvalStatus='approved';
  await dbPut('users',u);
  await audit('APPROVE_MEMBER','ê°€ì… ìŠ¹ì¸: '+userId,currentUser.id);
  toast('âœ… '+u.name+' íšŒì›ì˜ ê°€ì…ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤','success');
  renderAdmin();
}
async function rejectUser(userId){
  if(!confirm(`[${userId}] íšŒì›ì˜ ê°€ì…ì„ ê±°ë¶€í•˜ê³  ê³„ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  const u=await dbGet('users',userId);
  if(!u)return;
  await dbDelete('users',userId);
  await audit('REJECT_MEMBER','ê°€ì… ê±°ë¶€ ì‚­ì œ: '+userId,currentUser.id);
  toast('âŒ '+u.name+' íšŒì›ì˜ ê°€ì…ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤','error');
  renderAdmin();
}
function renderAdminOverview(members){
  // bar chart
  if(adminBarChart){ adminBarChart.destroy(); adminBarChart=null; }
  const top=members.filter(m=>m.investment>0).sort((a,b)=>b.investment-a.investment).slice(0,8);
  const ctx=document.getElementById('admin-bar-chart')?.getContext('2d');
  if(ctx&&top.length>0){
    adminBarChart=new Chart(ctx,{type:'bar',
      data:{labels:top.map(u=>u.name),datasets:[{label:'íˆ¬ìê¸ˆ',data:top.map(u=>u.investment),backgroundColor:'rgba(212,168,83,0.6)',borderColor:'var(--gold)',borderWidth:1},{label:'ROI',data:top.map(u=>u.roi),backgroundColor:'rgba(61,214,140,0.5)',borderColor:'var(--green)',borderWidth:1}]},
      options:{responsive:true,plugins:{legend:{labels:{color:'#8890a4',font:{size:11}}}},scales:{x:{ticks:{color:'#4a5068',font:{size:10}},grid:{color:'rgba(255,255,255,0.04)'}},y:{ticks:{color:'#4a5068',font:{size:10},callback:v=>fmt(v)},grid:{color:'rgba(255,255,255,0.04)'}}}}
    });
  }
  // ì§ê¸‰ í˜„í™©
  const rankCounts={}; RANK_TABLE.forEach(r=>rankCounts[r.rank]=0);
  members.forEach(u=>{ const sl=Math.min(u.leftInvest||0,u.rightInvest||0); rankCounts[calcRank(sl).rank]++; });
  document.getElementById('admin-rank-overview').innerHTML=RANK_TABLE.map(r=>`
    <div class="rank-row">
      <div class="rank-badge ${r.class}"><i class="fas fa-star"></i>${r.label}</div>
      <div style="font-size:14px;color:var(--text2);">${rankCounts[r.rank]}ëª…</div>
      ${r.rank>0?`<div style="font-size:14px;color:var(--text3);">ìˆ˜ë‹¹ ${fmt(r.bonus)}</div>`:''}
    </div>`).join('');
}
function renderAdminMembers(members){
  const tbody=document.getElementById('admin-member-body');
  tbody.innerHTML=members.map(u=>{
    const sl=Math.min(u.leftInvest||0,u.rightInvest||0);
    const rank=calcRank(sl);
    const maxPayout=u.investment*CFG.MAX_PAYOUT;
    const isMaxed=u.roi>=maxPayout&&maxPayout>0;
    return `<tr>
      <td><div style="font-weight:600;">${_esc(u.name)}</div><div style="font-size:14px;color:var(--text3);font-family:'Space Mono',monospace;">${_esc(u.id)}</div></td>
      <td style="font-size:14px;color:var(--text3);">${u.sponsorCode&&u.sponsorCode!=='SYSTEM-ROOT'?_esc(u.sponsorCode):'-'}</td>
      <td class="td-amount">${fmt(u.investment)}</td>
      <td class="td-amount" style="color:var(--gold);">${fmt(u.roi)}${isMaxed?'<span class="stat-badge badge-down" style="margin-left:4px;font-size:9px;">300%</span>':''}</td>
      <td class="td-amount" style="color:var(--green);">${fmt(u.wallet)}</td>
      <td><div class="rank-badge ${rank.class}" style="font-size:15px;">${rank.label}</div></td>
      <td>${u.approvalStatus==='pending'?'<span class="status status-pend">ìŠ¹ì¸ëŒ€ê¸°</span>':u.suspended?'<span class="status status-fail">ì •ì§€</span>':u.investment>0?'<span class="status status-done">íˆ¬ìì¤‘</span>':'<span class="status status-stop">ë¯¸íˆ¬ì</span>'}</td>
      <td><button class="btn btn-secondary btn-sm" onclick="openMemberDetail('${_esc(u.id)}')"><i class="fas fa-cog"></i> ê´€ë¦¬</button></td>
    </tr>`;
  }).join('');
  if(members.length===0) tbody.innerHTML='<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3);">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
}
function renderAdminInvestments(pendInv){
  const list=document.getElementById('admin-invest-list');
  if(pendInv.length===0){list.innerHTML='<div class="empty"><i class="fas fa-check-circle" style="color:var(--green);"></i><p>ëŒ€ê¸° ì¤‘ì¸ íˆ¬ì ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';return;}
  list.innerHTML=pendInv.map(inv=>`
    <div data-inv-id="${inv.id}" style="display:flex;justify-content:space-between;align-items:center;padding:18px 20px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;flex-wrap:wrap;gap:10px;">
      <div>
        <div style="font-size:16px;font-weight:700;" class="mono">${fmtFull(inv.amount)}</div>
        <div style="font-size:14px;color:var(--text3);margin-top:4px;">${_esc(inv.userId)} (${_esc(inv.userName)}) Â· ì‹ ì²­ì¼: ${inv.requestedAt}</div>
        <div style="font-size:14px;color:var(--text2);margin-top:2px;">ì…ê¸ˆì: ${_esc(inv.depositorName)} ${inv.memo?'Â· '+_esc(inv.memo):''}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-success btn-sm" onclick="approveInvestment('${inv.id}')"><i class="fas fa-check"></i> ìŠ¹ì¸</button>
        <button class="btn btn-danger btn-sm" onclick="rejectInvestment('${inv.id}')"><i class="fas fa-times"></i> ê±°ë¶€</button>
      </div>
    </div>`).join('');
}
function renderAdminWithdrawals(pendWd){
  const list=document.getElementById('admin-wd-list');
  if(pendWd.length===0){list.innerHTML='<div class="empty"><i class="fas fa-check-circle" style="color:var(--green);"></i><p>ëŒ€ê¸° ì¤‘ì¸ ì¶œê¸ˆ ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';return;}
  list.innerHTML=pendWd.map(wd=>`
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 20px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--r);margin-bottom:10px;">
      <div>
        <div style="font-size:16px;font-weight:700;" class="mono">${fmtFull(wd.amount)}</div>
        <div style="font-size:14px;color:var(--text3);margin-top:4px;">${_esc(wd.userId)} (${_esc(wd.userName)}) Â· ${wd.requestedAt}</div>
        <div style="font-size:14px;color:var(--text2);margin-top:2px;">${_esc(wd.bankName)} ${_esc(wd.accountNumber)} (${_esc(wd.accountHolder)})</div>
        <div style="font-size:14px;margin-top:2px;">ì‹¤ì§€ê¸‰: <span class="mono" style="color:var(--green);">${fmtFull(wd.net)}</span> Â· ìˆ˜ìˆ˜ë£Œ: ${fmtFull(wd.fee)}</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-success btn-sm" onclick="approveWithdrawal(${wd.id})"><i class="fas fa-check"></i> ìŠ¹ì¸</button>
        <button class="btn btn-danger btn-sm" onclick="rejectWithdrawal(${wd.id})"><i class="fas fa-times"></i> ê±°ë¶€</button>
      </div>
    </div>`).join('');
}
function renderAdminLogs(allTx){
  const sorted=allTx.sort((a,b)=>b.id-a.id).slice(0,500);
  const c=document.getElementById('log-count');
  if(c) c.textContent=`ì „ì²´ ${allTx.length}ê±´`;
  document.getElementById('admin-log-body').innerHTML=sorted.length===0
    ?'<tr><td colspan="8" style="text-align:center;padding:40px;color:var(--text3);">ê±°ë˜ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'
    :sorted.map(t=>`<tr style="${t.status==='cancelled'?'opacity:0.55;':''}">
    <td style="font-size:13px;color:var(--text3);white-space:nowrap;">${t.date}</td>
    <td style="font-size:13px;font-family:monospace;">${_esc(t.userId||'')}</td>
    <td><span style="color:${typeColor(t.type)};font-size:13px;font-weight:700;">${typeLabel(t.type)}</span></td>
    <td class="td-amount" style="font-size:13px;${t.status==='cancelled'?'text-decoration:line-through;color:var(--text3);':''}">
      ${t.status==='cancelled'?'<span style="color:var(--red);font-size:11px;font-weight:700;">âœ— ì·¨ì†Œ</span> ':''} ${fmt(t.amount)}</td>
    <td style="font-size:13px;color:var(--text3);">${t.fee>0?fmt(t.fee):'-'}</td>
    <td style="font-size:13px;color:var(--text3);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${_esc(t.desc||'')}">${_esc(t.desc||'')}</td>
    <td>${statusHtml(t.status)}</td>
    <td><div style="display:flex;gap:4px;flex-wrap:wrap;">
      ${t.status!=='cancelled'?`<button class="btn btn-secondary btn-sm" style="padding:4px 8px;font-size:11px;" onclick="openTxEditModal('${String(t.id)}')"><i class="fas fa-edit"></i></button>`:''}
      ${t.status==='completed'?`<button class="btn btn-warning btn-sm" style="padding:4px 8px;font-size:11px;background:#e67e22;border-color:#e67e22;color:#fff;" onclick="cancelTxLog('${String(t.id)}')"><i class="fas fa-undo"></i> ì·¨ì†Œ</button>`:''}
      <button class="btn btn-danger btn-sm" style="padding:4px 8px;font-size:11px;" onclick="deleteTxLog('${String(t.id)}')"><i class="fas fa-trash"></i></button>
    </div></td>
  </tr>`).join('');
}

// â”€â”€ ê±°ë˜ë‚´ì—­ ê²€ìƒ‰ (ìœ í˜• í•„í„° í¬í•¨) â”€â”€
function searchLogs(){
  const q=(document.getElementById('log-search')?.value||'').toLowerCase();
  const tf=document.getElementById('log-type-filter')?.value||'all';
  dbGetAll('transactions').then(all=>{
    let r=all;
    if(q) r=r.filter(t=>(t.userId||'').toLowerCase().includes(q)||(t.desc||'').toLowerCase().includes(q));
    if(tf!=='all') r=r.filter(t=>t.type===tf);
    renderAdminLogs(r);
  });
}

// â”€â”€ ê±°ë˜ë‚´ì—­ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° â”€â”€
async function openTxEditModal(txId){
  const tx=await dbGet('transactions',String(txId));
  if(!tx){toast('ê±°ë˜ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error');return;}
  document.getElementById('tx-edit-title').textContent='ê±°ë˜ë‚´ì—­ ìˆ˜ì •';
  document.getElementById('tx-edit-id').value=String(tx.id);
  document.getElementById('tx-edit-userId').value=tx.userId||'';
  document.getElementById('tx-edit-type').value=tx.type||'ê¸°íƒ€';
  document.getElementById('tx-edit-date').value=tx.date||localDateStr(new Date());
  document.getElementById('tx-edit-amount').value=tx.amount||0;
  document.getElementById('tx-edit-fee').value=tx.fee||0;
  document.getElementById('tx-edit-net').value=tx.netAmount!=null?tx.netAmount:tx.amount||0;
  document.getElementById('tx-edit-desc').value=tx.desc||'';
  document.getElementById('tx-edit-status').value=tx.status||'completed';
  document.getElementById('modal-tx-edit').classList.remove('hidden');
}

// â”€â”€ ìƒˆ ê±°ë˜ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸° â”€â”€
function openAddTxModal(prefillUid){
  document.getElementById('tx-edit-title').textContent='ê±°ë˜ë‚´ì—­ ì¶”ê°€';
  document.getElementById('tx-edit-id').value='';
  document.getElementById('tx-edit-userId').value=prefillUid||'';
  document.getElementById('tx-edit-type').value='ROI';
  document.getElementById('tx-edit-date').value=localDateStr(new Date());
  document.getElementById('tx-edit-amount').value='';
  document.getElementById('tx-edit-fee').value='0';
  document.getElementById('tx-edit-net').value='';
  document.getElementById('tx-edit-desc').value='';
  document.getElementById('tx-edit-status').value='completed';
  document.getElementById('modal-tx-edit').classList.remove('hidden');
}

function closeTxEdit(){ document.getElementById('modal-tx-edit').classList.add('hidden'); }

function txAutoNet(){
  const a=parseInt(document.getElementById('tx-edit-amount').value)||0;
  const f=parseInt(document.getElementById('tx-edit-fee').value)||0;
  document.getElementById('tx-edit-net').value=Math.max(0,a-f);
}

// â”€â”€ ê±°ë˜ë‚´ì—­ ì €ì¥ (ìˆ˜ì • / ì¶”ê°€) â”€â”€
async function saveTxEdit(){
  const txId=document.getElementById('tx-edit-id').value;
  const userId=document.getElementById('tx-edit-userId').value.trim();
  const type=document.getElementById('tx-edit-type').value;
  const date=document.getElementById('tx-edit-date').value;
  const amount=parseInt(document.getElementById('tx-edit-amount').value)||0;
  const fee=parseInt(document.getElementById('tx-edit-fee').value)||0;
  const net=parseInt(document.getElementById('tx-edit-net').value)||Math.max(0,amount-fee);
  const desc=document.getElementById('tx-edit-desc').value.trim();
  const status=document.getElementById('tx-edit-status').value;
  if(!userId){toast('íšŒì› IDë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  if(!date){toast('ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”','error');return;}
  try{
    const ux=await dbGet('users',userId);
    if(!ux){toast(`íšŒì› [${userId}] ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤`,'error');return;}
    const isNew=!txId;
    const id=isNew?Date.now():(parseInt(txId)||txId);
    await dbPut('transactions',{id,userId,type,date,amount,fee,netAmount:net,desc,status});
    await audit(isNew?'TX_ADD':'TX_EDIT',`ê±°ë˜ ${isNew?'ì¶”ê°€':'ìˆ˜ì •'} [${id}] ${userId} ${type} ${fmt(amount)}`,'admin');
    toast(isNew?'âœ… ê±°ë˜ë‚´ì—­ ì¶”ê°€ ì™„ë£Œ':'âœ… ê±°ë˜ë‚´ì—­ ìˆ˜ì • ì™„ë£Œ','success');
    closeTxEdit();
    if(_detailUserId) await renderMemberTxTab(_detailUserId);
    await renderAdmin();
  }catch(e){
    console.error('ì €ì¥ ì˜¤ë¥˜:',e);
    toast('ì €ì¥ ì˜¤ë¥˜: '+e.message,'error');
  }
}

// â”€â”€ ê±°ë˜ë‚´ì—­ ì‚­ì œ (ë¡œê·¸ íƒ­) â”€â”€
// â”€â”€ ê±°ë˜ë‚´ì—­ ì·¨ì†Œ (ì—­ì°¨ê°) â”€â”€
async function cancelTxLog(txId){
  const tx = await dbGet('transactions', String(txId));
  if(!tx){ toast('ê±°ë˜ë‚´ì—­ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error'); return; }
  if(tx.status === 'cancelled'){ toast('ì´ë¯¸ ì·¨ì†Œëœ ê±°ë˜ì…ë‹ˆë‹¤','error'); return; }

  const typeStr = tx.type || 'ê±°ë˜';
  const amtStr = fmt(tx.amount);
  const userStr = tx.userId;

  showModal(
    `${typeStr} ì·¨ì†Œ`,
    `[${userStr}] ${typeStr} ${amtStr} ì„ ì·¨ì†Œí•©ë‹ˆë‹¤.<br><br>` +
    `<b style="color:var(--red);">âš ï¸ í•´ë‹¹ ê¸ˆì•¡ì´ íšŒì› ì”ì•¡/íˆ¬ìê¸ˆì—ì„œ ì—­ì°¨ê°ë©ë‹ˆë‹¤.</b><br>` +
    `ëŒ€ì‹œë³´ë“œ ì§‘ê³„ë„ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.`,
    async()=>{
      try{
        const user = await dbGet('users', tx.userId);
        if(user){
          const amt = tx.amount || 0;
          const net = tx.netAmount || tx.amount || 0;

          if(tx.type === 'íˆ¬ì'){
            // íˆ¬ìê¸ˆ ì°¨ê° (0 ë¯¸ë§Œ ë°©ì§€)
            user.investment = Math.max(0, (user.investment||0) - amt);
          } else if(tx.type === 'ROI'){
            // ROIëŠ” wallet + roi ì°¨ê°
            user.wallet = Math.max(0, (user.wallet||0) - net);
            user.roi    = Math.max(0, (user.roi||0)    - net);
          } else if(tx.type === 'ë³´ë„ˆìŠ¤'){
            // ì¶”ì²œ ìˆ˜ë‹¹: wallet + roi ì°¨ê°
            user.wallet = Math.max(0, (user.wallet||0) - net);
            user.roi    = Math.max(0, (user.roi||0)    - net);
          } else if(tx.type === 'ì§ê¸‰ìˆ˜ë‹¹'){
            // ì§ê¸‰ ìˆ˜ë‹¹: wallet + roi ì°¨ê°
            user.wallet = Math.max(0, (user.wallet||0) - net);
            user.roi    = Math.max(0, (user.roi||0)    - net);
          } else if(tx.type === 'ì¶œê¸ˆ'){
            // ì¶œê¸ˆ ì·¨ì†Œ: wallet ë³µì›
            user.wallet = (user.wallet||0) + net;
          }
          await dbPut('users', user);
        }

        // ê±°ë˜ ìƒíƒœë¥¼ 'cancelled'ë¡œ ë³€ê²½ (ì‚­ì œ X - ê°ì‚¬ ì¶”ì  ë³´ì¡´)
        const updated = { ...tx, status:'cancelled', cancelledAt: localDateStr(new Date()), cancelledBy:'admin', cancelDesc:`[ê´€ë¦¬ì ì·¨ì†Œ] ì›ê±°ë˜: ${tx.desc||''}` };
        await dbPut('transactions', updated);

        // ì·¨ì†Œ ê°ì‚¬ ë¡œê·¸
        await audit('TX_CANCEL', `ê±°ë˜ì·¨ì†Œ [${txId}] ${tx.userId} ${tx.type} ${fmt(tx.amount)} â†’ ì—­ì°¨ê° ì™„ë£Œ`, 'admin');

        toast(`âœ… ${typeStr} ì·¨ì†Œ ì™„ë£Œ - ${userStr} ì”ì•¡ ë°˜ì˜ë¨`, 'success');
        await renderAdmin();
      }catch(e){
        console.error('ì·¨ì†Œ ì˜¤ë¥˜:',e);
        toast('ì·¨ì†Œ ì˜¤ë¥˜: '+e.message,'error');
      }
    },
    'ì·¨ì†Œ ì‹¤í–‰', 'btn-danger'
  );
}

async function deleteTxLog(txId){
  showModal('ê±°ë˜ë‚´ì—­ ì‚­ì œ','ì´ ê±°ë˜ë‚´ì—­ì„ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤. ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',async()=>{
    try{
      await dbDelete('transactions',String(txId));
      await audit('TX_DELETE',`ê±°ë˜ë‚´ì—­ ì‚­ì œ [${txId}]`,'admin');
      toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤','success');
      await renderAdmin();
    }catch(e){
      console.error('ì‚­ì œ ì˜¤ë¥˜:',e);
      toast('ì‚­ì œ ì˜¤ë¥˜: '+e.message,'error');
    }
  },'ì‚­ì œ','btn-danger');
}

// â”€â”€ switchMmdTab (ê±°ë˜ë‚´ì—­ íƒ­ í¬í•¨) â”€â”€
function switchMmdTab(tab,btn){
  ['info','finance','tx','account'].forEach(t=>{
    document.getElementById('mmd-tab-'+t+'-body').style.display=t===tab?'block':'none';
    document.getElementById('mmd-tab-'+t).classList.toggle('active',t===tab);
  });
  if(tab==='tx') renderMemberTxTab(_detailUserId);
}

// â”€â”€ íšŒì›ë³„ ê±°ë˜ë‚´ì—­ íƒ­ ë Œë” â”€â”€
async function renderMemberTxTab(uid){
  const body=document.getElementById('mmd-tab-tx-body');
  if(!body||!uid) return;
  body.innerHTML='<div style="padding:30px;text-align:center;color:var(--text3);"><i class="fas fa-spinner fa-spin"></i> ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
  const all=await dbGetAll('transactions');
  const txs=all.filter(t=>t.userId===uid).sort((a,b)=>b.id-a.id);
  body.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px;">
      <span style="font-size:14px;color:var(--text2);">ì´ <b style="color:var(--text);">${txs.length}ê±´</b></span>
      <button class="btn btn-primary btn-sm" onclick="openAddTxModal('${_esc(uid)}')"><i class="fas fa-plus"></i> ê±°ë˜ ì¶”ê°€</button>
    </div>
    <div class="table-wrap" style="max-height:380px;overflow-y:auto;">
      <table>
        <thead><tr><th>ë‚ ì§œ</th><th>ìœ í˜•</th><th>ê¸ˆì•¡</th><th>ë‚´ìš©</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead>
        <tbody>${txs.length===0
          ?'<tr><td colspan="6" style="text-align:center;padding:30px;color:var(--text3);">ê±°ë˜ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>'
          :txs.map(t=>`<tr>
          <td style="font-size:13px;color:var(--text3);white-space:nowrap;">${t.date}</td>
          <td><span style="color:${typeColor(t.type)};font-size:13px;font-weight:700;">${typeLabel(t.type)}</span></td>
          <td style="font-size:13px;text-align:right;font-family:monospace;">${fmt(t.amount)}</td>
          <td style="font-size:12px;color:var(--text3);max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${_esc(t.desc||'')}">${_esc(t.desc||'')}</td>
          <td>${statusHtml(t.status)}</td>
          <td><div style="display:flex;gap:3px;flex-wrap:wrap;">
            ${t.status!=='cancelled'?`<button class="btn btn-secondary btn-sm" style="padding:3px 7px;font-size:11px;" onclick="openTxEditModal('${String(t.id)}')"><i class="fas fa-edit"></i></button>`:''}
            ${t.status==='completed'?`<button class="btn btn-sm" style="padding:3px 7px;font-size:11px;background:#e67e22;border:1px solid #e67e22;color:#fff;border-radius:var(--r);" onclick="cancelTxLog('${String(t.id)}')"><i class="fas fa-undo"></i></button>`:''}
            <button class="btn btn-danger btn-sm" style="padding:3px 7px;font-size:11px;" onclick="deleteTxMember('${String(t.id)}','${_esc(uid)}')"><i class="fas fa-trash"></i></button>
          </div></td>
        </tr>`).join('')}</tbody>
      </table>
    </div>`;
}

// â”€â”€ íšŒì› ìƒì„¸ì—ì„œ ê±°ë˜ë‚´ì—­ ì‚­ì œ â”€â”€
async function deleteTxMember(txId,uid){
  showModal('ê±°ë˜ë‚´ì—­ ì‚­ì œ','ì´ ê±°ë˜ë‚´ì—­ì„ ì˜êµ¬ ì‚­ì œí•©ë‹ˆë‹¤.',async()=>{
    try{
      await dbDelete('transactions',String(txId));
      await audit('TX_DELETE',`ê±°ë˜ë‚´ì—­ ì‚­ì œ [${txId}] íšŒì›:${uid}`,'admin');
      toast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤','success');
      await renderMemberTxTab(uid);
      await renderAdmin();
    }catch(e){
      console.error('ì‚­ì œ ì˜¤ë¥˜:',e);
      toast('ì‚­ì œ ì˜¤ë¥˜: '+e.message,'error');
    }
  },'ì‚­ì œ','btn-danger');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN ACTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchAdminTab(tab,btn){
  ['overview','approval','members','investments','withdrawals','logs'].forEach(t=>{
    const el=document.getElementById('admin-tab-'+t); if(el) el.style.display=t===tab?'block':'none';
  });
  document.querySelectorAll('#admin-tabs .tab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active'); adminCurrentTab=tab;
  renderAdmin();
}
function searchMembers(){
  const q=document.getElementById('member-search').value.toLowerCase();
  const status=document.getElementById('member-status-filter').value;
  dbGetAll('users').then(allUsers=>{
    let members=allUsers.filter(u=>u.role==='member');
    if(q) members=members.filter(u=>u.name.toLowerCase().includes(q)||u.id.toLowerCase().includes(q));
    if(status==='active') members=members.filter(u=>u.investment>0&&!u.suspended);
    if(status==='inactive') members=members.filter(u=>u.investment===0);
    if(status==='suspended') members=members.filter(u=>u.suspended);
    renderAdminMembers(members);
  });
}
async function saveOverrides(){
  const roi=parseFloat(document.getElementById('ov-roi').value)/100;
  const direct=parseFloat(document.getElementById('ov-direct').value)/100;
  const binary=parseFloat(document.getElementById('ov-binary').value)/100;
  const maxP=parseFloat(document.getElementById('ov-maxpayout').value)/100;
  const wdfee=parseFloat(document.getElementById('ov-wdfee').value)/100;
  if(isNaN(roi)||isNaN(direct)||isNaN(binary)||isNaN(maxP)||isNaN(wdfee)){toast('ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  await saveSetting('DAILY_ROI',roi); await saveSetting('DIRECT_BONUS',direct);
  await saveSetting('BINARY_BONUS',binary); await saveSetting('MAX_PAYOUT',maxP); await saveSetting('WD_FEE',wdfee);
  await audit('SETTINGS','ìˆ˜ë‹¹ ë¹„ìœ¨ ë³€ê²½','admin');
  toast('ìˆ˜ë‹¹ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤','success');
}
async function saveDepositAccount(){
  const bank=document.getElementById('admin-bank-name').value.trim();
  const acc=document.getElementById('admin-bank-account').value.trim();
  const holder=document.getElementById('admin-bank-holder').value.trim();
  if(!bank||!acc||!holder){toast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”','error');return;}
  await saveSetting('DEPOSIT_BANK',bank); await saveSetting('DEPOSIT_ACCOUNT',acc); await saveSetting('DEPOSIT_HOLDER',holder);
  toast('ì…ê¸ˆ ê³„ì¢Œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤','success');
}
// â˜… íˆ¬ì ìŠ¹ì¸ ì²˜ë¦¬ ì¤‘ ID ì§‘í•© (ì¤‘ë³µ ë°©ì§€)
const _invProcessing = new Set();

async function approveInvestment(id){
  const invId = String(id);
  if(_invProcessing.has(invId)){ toast('ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.','error'); return; }

  showModal('íˆ¬ì ìŠ¹ì¸','ì´ íˆ¬ì ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async()=>{
    if(_invProcessing.has(invId)){ toast('ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤.','error'); return; }
    _invProcessing.add(invId);

    // ìŠ¹ì¸ ë²„íŠ¼ ì¦‰ì‹œ ë¹„í™œì„±í™”
    const itemEl = document.querySelector(`[data-inv-id="${invId}"]`);
    if(itemEl) itemEl.querySelectorAll('button').forEach(b=>{b.disabled=true; b.style.opacity='0.4';});

    try{
      // DB ì¬ì¡°íšŒ â€” ì´ë¯¸ ì²˜ë¦¬ëëŠ”ì§€ ìµœì¢… í™•ì¸
      const inv = await dbGet('pendingInvestments', invId);
      if(!inv){
        toast('ì´ë¯¸ ì²˜ë¦¬ëœ ì‹ ì²­ì…ë‹ˆë‹¤.','error');
        if(itemEl) itemEl.remove();
        renderAdmin(); return;
      }
      const user = await dbGet('users', inv.userId);
      if(!user){ toast('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤','error'); return; }

      const today = localDateStr(new Date());
      user.investment += inv.amount;
      user.lastInvestmentDate = today;
      await dbPut('users', user);

      const txBase = Date.now();
      await dbPut('transactions',{id:txBase,userId:inv.userId,type:'íˆ¬ì',amount:inv.amount,fee:0,netAmount:inv.amount,date:today,status:'completed',desc:'íˆ¬ì ìŠ¹ì¸ ì™„ë£Œ'});

      if(user.sponsorCode&&user.sponsorCode!=='SYSTEM-ROOT'){
        const sponsor1 = await dbGet('users', user.sponsorCode);
        if(sponsor1&&!sponsor1.suspended){
          const max1 = sponsor1.investment*CFG.MAX_PAYOUT;
          if(sponsor1.roi<max1||sponsor1.investment===0){
            const bonus1=Math.floor(inv.amount*CFG.DIRECT_BONUS);
            const actual1=sponsor1.investment>0?Math.min(bonus1,max1-sponsor1.roi):bonus1;
            if(actual1>0){
              sponsor1.wallet+=actual1; sponsor1.roi+=actual1;
              await dbPut('users',sponsor1);
              await dbPut('transactions',{id:txBase+1+Math.floor(Math.random()*9999),userId:sponsor1.id,type:'ë³´ë„ˆìŠ¤',amount:actual1,fee:0,netAmount:actual1,date:today,status:'completed',desc:`ì§ì¶”ì²œ ìˆ˜ë‹¹ 1ëŒ€ (${user.id} íˆ¬ìê¸ˆì˜ ${(CFG.DIRECT_BONUS*100).toFixed(0)}%)`});
            }
          }
          if(sponsor1.sponsorCode&&sponsor1.sponsorCode!=='SYSTEM-ROOT'){
            const sponsor2 = await dbGet('users', sponsor1.sponsorCode);
            if(sponsor2&&!sponsor2.suspended){
              const max2=sponsor2.investment*CFG.MAX_PAYOUT;
              if(sponsor2.roi<max2||sponsor2.investment===0){
                const bonus2=Math.floor(inv.amount*CFG.BINARY_BONUS);
                const actual2=sponsor2.investment>0?Math.min(bonus2,max2-sponsor2.roi):bonus2;
                if(actual2>0){
                  sponsor2.wallet+=actual2; sponsor2.roi+=actual2;
                  await dbPut('users',sponsor2);
                  await dbPut('transactions',{id:txBase+2+Math.floor(Math.random()*9999),userId:sponsor2.id,type:'ë³´ë„ˆìŠ¤',amount:actual2,fee:0,netAmount:actual2,date:today,status:'completed',desc:`ì†Œì‹¤ì  ìˆ˜ë‹¹ 2ëŒ€ (${user.id} íˆ¬ìê¸ˆì˜ ${(CFG.BINARY_BONUS*100).toFixed(0)}%)`});
                }
              }
            }
          }
        }
      }

      // â˜… ë¼ì¸ í¬ì¸íŠ¸/ì§ê¸‰ ìˆ˜ë‹¹ì€ ë¶€ê°€ê¸°ëŠ¥ - ì—ëŸ¬ë‚˜ë„ ìŠ¹ì¸ì€ ê³„ì†
      try{ await updateLinePoints(user.id, inv.amount); }
      catch(e){ console.warn('[ë¼ì¸í¬ì¸íŠ¸ ì˜¤ë¥˜ ë¬´ì‹œ]', e.message); }
      try{ await checkRankBonuses(user.id, today); }
      catch(e){ console.warn('[ì§ê¸‰ìˆ˜ë‹¹ ì˜¤ë¥˜ ë¬´ì‹œ]', e.message); }

      // â˜… pending ì‚­ì œ (í•µì‹¬ - ì—¬ê¸°ì„œ ì‹¤íŒ¨í•˜ë©´ ì§„ì§œ ì‹¤íŒ¨)
      await dbDelete('pendingInvestments', invId);
      await audit('INV_APPROVE',`íˆ¬ì ìŠ¹ì¸ ${fmt(inv.amount)} íšŒì›:${inv.userId}`,'admin');
      toast(`âœ… ${inv.userName||inv.userId} íˆ¬ì ìŠ¹ì¸ ì™„ë£Œ (${fmt(inv.amount)})`,'success');

      // â˜… DOMì—ì„œ ì¦‰ì‹œ ì œê±° í›„ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
      if(itemEl) itemEl.remove();
      const list = document.getElementById('admin-invest-list');
      if(list&&!list.querySelector('[data-inv-id]')){
        list.innerHTML='<div class="empty"><i class="fas fa-check-circle" style="color:var(--green);"></i><p>ëŒ€ê¸° ì¤‘ì¸ íˆ¬ì ì‹ ì²­ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
      }
      await renderAdmin();

    } catch(err){
      console.error('íˆ¬ì ìŠ¹ì¸ ì˜¤ë¥˜:',err);
      toast('ìŠ¹ì¸ ì˜¤ë¥˜: '+err.message,'error');
      if(itemEl) itemEl.querySelectorAll('button').forEach(b=>{b.disabled=false; b.style.opacity='';});
    } finally{
      _invProcessing.delete(invId);
    }
  },'ìŠ¹ì¸','btn-success');
}
async function updateLinePoints(newUserId,amount){
  // ì¶”ì²œ ì²´ì¸ ì˜¬ë¼ê°€ë©´ì„œ ì¢Œìš° í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
  const newUser=await dbGet('users',newUserId);
  if(!newUser||!newUser.sponsorCode)return;
  const allUsers=await dbGetAll('users');
  // BFSë¡œ ìƒìœ„ ì¶”ì²œì¸ë“¤ ì°¾ê¸° - ìµœëŒ€ 10ë ˆë²¨
  let curId=newUser.sponsorCode;
  for(let i=0;i<10&&curId;i++){
    const cur=await dbGet('users',curId);
    if(!cur)break;
    // ì´ íšŒì›ì˜ ì™¼ìª½/ì˜¤ë¥¸ìª½ ì¤‘ newUserIdê°€ ì–´ëŠìª½?
    // ë‹¨ìˆœí™”: ì§ì ‘ ì™¼ìª½ ìì‹ì˜ í•˜ìœ„ë©´ leftInvest, ì•„ë‹ˆë©´ rightInvest
    const leftDown=getDownlineIds(cur.children?.left,allUsers);
    if(leftDown.includes(newUserId)||cur.children?.left===newUserId){
      cur.leftInvest=(cur.leftInvest||0)+amount;
      cur.leftPoints=(cur.leftPoints||0)+amount;
    } else {
      cur.rightInvest=(cur.rightInvest||0)+amount;
      cur.rightPoints=(cur.rightPoints||0)+amount;
    }
    await dbPut('users',cur);
    curId=cur.sponsorCode;
  }
}
function getDownlineIds(uid,allUsers){
  if(!uid)return[];
  const acc=[uid];
  const children=allUsers.filter(u=>u.sponsorCode===uid);
  children.forEach(c=>{ acc.push(...getDownlineIds(c.id,allUsers)); });
  return acc;
}
async function checkRankBonuses(newUserId,date){
  // ì¶”ì²œ ë¼ì¸ ìƒìœ„ ëª¨ë‘ ì§ê¸‰ ìˆ˜ë‹¹ ì²´í¬
  let curId=(await dbGet('users',newUserId))?.sponsorCode;
  let depth=0;
  while(curId&&depth<10){
    const cur=await dbGet('users',curId);
    if(!cur||cur.role==='admin')break;
    const sl=Math.min(cur.leftInvest||0,cur.rightInvest||0);
    const rank=calcRank(sl);
    if(rank.rank>0&&!( (cur.paidRanks||[]).includes(rank.rank) )){
      // ë¯¸ì§€ê¸‰ ì§ê¸‰ ìˆ˜ë‹¹ ì§€ê¸‰
      const max=cur.investment*CFG.MAX_PAYOUT;
      if(cur.investment===0||cur.roi<max){
        const actual=cur.investment>0?Math.min(rank.bonus,max-cur.roi):rank.bonus;
        if(actual>0){
          cur.wallet+=actual; cur.roi+=actual;
          if(!cur.paidRanks) cur.paidRanks=[];
          cur.paidRanks.push(rank.rank);
          await dbPut('users',cur);
          await dbPut('transactions',{id:Date.now()+depth,userId:cur.id,type:'ì§ê¸‰ìˆ˜ë‹¹',amount:actual,fee:0,netAmount:actual,date,status:'completed',desc:`${rank.label} ì§ê¸‰ ìˆ˜ë‹¹ ë‹¬ì„± (ì†Œë¼ì¸ ${fmt(sl)})`});
          toast(`${cur.name}ë‹˜ ${rank.label} ì§ê¸‰ ë‹¬ì„±! ${fmt(actual)} ì§€ê¸‰`,'success');
        }
      }
    }
    curId=cur.sponsorCode; depth++;
  }
}
async function approveWithdrawal(id){
  showModal('ì¶œê¸ˆ ìŠ¹ì¸','ì´ ì¶œê¸ˆ ì‹ ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',async()=>{
    const wd=await dbGet('pendingWithdrawals',id); if(!wd)return;
    const today=localDateStr(new Date());
    await dbPut('transactions',{id:Date.now(),userId:wd.userId,type:'ì¶œê¸ˆ',amount:wd.amount,fee:wd.fee,netAmount:wd.net,date:today,status:'completed',desc:'ì¶œê¸ˆ ìŠ¹ì¸ ì™„ë£Œ'});
    await dbDelete('pendingWithdrawals',id);
    await audit('WD_APPROVE',`ì¶œê¸ˆ ìŠ¹ì¸ ${fmt(wd.amount)} íšŒì›:${wd.userId}`,'admin');
    toast('ì¶œê¸ˆì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤','success');
    await renderAdmin();
  },'ìŠ¹ì¸','btn-success');
}
async function runSettlement(){
  const today=new Date();
  const dow=today.getDay();
  if(dow===0||dow===6){toast('ì£¼ë§(í† /ì¼)ì€ ë°°ë‹¹ì¼ì´ ì•„ë‹™ë‹ˆë‹¤','error');return;}
  showModal('ì „ì²´ ì •ì‚° ì‹¤í–‰',`ì˜¤ëŠ˜(${localDateStr(today)}) ì „ì²´ íšŒì› ROI ${(CFG.DAILY_ROI*100).toFixed(1)}% ë°°ë‹¹ì„ ì§€ê¸‰í•˜ê² ìŠµë‹ˆê¹Œ?`,async()=>{
    const allUsers=await dbGetAll('users');
    const todayStr=localDateStr(today);
    let count=0;
    for(const u of allUsers){
      if(u.role!=='member'||u.investment===0||u.suspended)continue;
      const max=u.investment*CFG.MAX_PAYOUT;
      if(u.roi>=max)continue;
      const payout=Math.round(u.investment*CFG.DAILY_ROI);
      const actual=Math.min(payout,max-u.roi);
      if(actual<=0)continue;
      u.roi+=actual; u.wallet+=actual; u.lastRoiDate=todayStr;
      await dbPut('users',u);
      await dbPut('transactions',{id:Date.now()+count,userId:u.id,type:'ROI',amount:actual,fee:0,netAmount:actual,date:todayStr,status:'completed',desc:`ì¼ê´„ ìë™ ì •ì‚° ROI ${(CFG.DAILY_ROI*100).toFixed(1)}%`});
      count++;
    }
    await audit('SETTLEMENT',`ì „ì²´ ì •ì‚° ${count}ëª… ì™„ë£Œ`,'admin');
    toast(`ì •ì‚° ì™„ë£Œ â€” ${count}ëª…ì—ê²Œ ROI ì§€ê¸‰ë¨`,'success');
    renderAdmin();
  },'ì •ì‚° ì‹¤í–‰','btn-primary');
}

//  ROI AUTO SCHEDULER (ì£¼ 5ì¼ ì›”~ê¸ˆ)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getPayableDates(lastPaidDate,approvedDate,todayDate){
  const dates=[];
  const start=new Date(approvedDate); start.setDate(start.getDate()+1);
  const last=lastPaidDate?new Date(lastPaidDate):null;
  const end=new Date(todayDate);
  let cur=new Date(start);
  while(cur<=end){
    const dow=cur.getDay();
    const curStr=localDateStr(cur);
    if(dow>=1&&dow<=5&&(!last||cur>last)) dates.push(curStr); // ì›”~ê¸ˆë§Œ
    cur.setDate(cur.getDate()+1);
  }
  return dates;
}
async function processUserRoi(userId){
  const u=await dbGet('users',userId);
  if(!u||u.role!=='member'||u.investment===0||u.suspended)return 0;
  const max=u.investment*CFG.MAX_PAYOUT;
  if(u.roi>=max)return 0;
  const today=localDateStr(new Date());
  const approvedDate=u.lastInvestmentDate; if(!approvedDate)return 0;
  const payableDates=getPayableDates(u.lastRoiDate||null,approvedDate,today);
  if(payableDates.length===0)return 0;
  let totalPaid=0; let upd={...u};
  for(const dateStr of payableDates){
    if(upd.roi>=max)break;
    const payout=Math.round(upd.investment*CFG.DAILY_ROI);
    const actual=Math.min(payout,max-upd.roi);
    if(actual<=0)break;
    upd.roi+=actual; upd.wallet+=actual; upd.lastRoiDate=dateStr; totalPaid+=actual;
    await dbPut('transactions',{id:Date.now()+Math.floor(Math.random()*9999),userId:u.id,type:'ROI',amount:actual,fee:0,netAmount:actual,date:dateStr,status:'completed',desc:`ìë™ ROI ${(CFG.DAILY_ROI*100).toFixed(1)}% â€” ${dateStr}`});
    await new Promise(r=>setTimeout(r,2));
  }
  if(totalPaid>0) await dbPut('users',upd);
  return totalPaid;
}
async function catchUpRoi(){
  if(!currentUser||currentUser.role==='admin')return;
  const paid=await processUserRoi(currentUser.id);
  if(paid>0){
    const u=await dbGet('users',currentUser.id); currentUser=u;
    toast(`ë¯¸ì§€ê¸‰ ROI ${fmt(paid)} ìë™ ë³´ì • ì™„ë£Œ`,'success');
    if(currentView==='dashboard') renderDashboard();
  }
}
async function autoSettleAll(label){
  // ìŠ¹ì¸ëœ íˆ¬ì íšŒì›ë§Œ ìë™ ì •ì‚° (ì£¼ 5ì¼ ì›”~ê¸ˆ ìë™ ì‹¤í–‰)
  const allUsers=await dbGetAll('users');
  let count=0, totalAmt=0;
  for(const u of allUsers){
    if(u.role!=='member') continue;
    if(u.approvalStatus!=='approved') continue; // ë¯¸ìŠ¹ì¸ ì œì™¸
    if(u.suspended) continue;                   // ì •ì§€ íšŒì› ì œì™¸
    if(!u.investment||u.investment<=0) continue;// ë¯¸íˆ¬ì ì œì™¸
    const paid=await processUserRoi(u.id);
    if(paid>0){ count++; totalAmt+=paid; }
  }
  // ì •ì‚° ë¡œê·¸ ì €ì¥
  const runTime=new Date().toLocaleString('ko-KR');
  await dbPut('settings',{key:'__scheduler__',value:{lastRun:localDateStr(new Date()),runTime,count,totalAmt,ts:Date.now()}});
  console.log(`[ìë™ì •ì‚° ${label}] ${runTime} â€” ${count}ëª… / ${fmt(totalAmt)} ì§€ê¸‰ ì™„ë£Œ`);
  if(count>0){
    if(currentUser&&currentUser.role!=='admin'&&currentUser.investment>0){
      const myPayout=Math.round(currentUser.investment*CFG.DAILY_ROI);
      toast(`ğŸ’° ì˜¤ëŠ˜ì˜ ROI ${fmt(myPayout)}ì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!`,'success');
      if(currentView==='dashboard') renderDashboard();
    }
    if(currentUser&&currentUser.role==='admin'){
      toast(`âœ… ìë™ ì •ì‚° ì™„ë£Œ â€” ${count}ëª… / ${fmt(totalAmt)}`, 'success');
      renderAdmin();
    }
  }
}
let _schedulerTimer=null;

function startScheduler(){
  // ì •í™•íˆ ë‹¤ìŒë‚  00:00:01ì— ì‹¤í–‰ë˜ë„ë¡ setTimeout ê³„ì‚°
  scheduleNextRun();
  updateNextRoiTimer();
}

function scheduleNextRun(){
  if(_schedulerTimer) clearTimeout(_schedulerTimer);
  const now=new Date();
  // ë‹¤ìŒë‚  00:00:01 ê³„ì‚°
  const next=new Date(now);
  next.setDate(next.getDate()+1);
  next.setHours(0,0,1,0); // ì˜¤ì „ 12ì‹œ 00ë¶„ 01ì´ˆ
  const msUntilNext=next-now;
  console.log(`[Scheduler] ë‹¤ìŒ ì •ì‚° ì˜ˆì •: ${next.toLocaleString('ko-KR')} (${Math.round(msUntilNext/1000)}ì´ˆ í›„)`);
  _schedulerTimer=setTimeout(async()=>{
    const now2=new Date();
    const today=localDateStr(now2);
    const dow=now2.getDay();
    console.log(`[Scheduler] ${today} ìì • ì •ì‚° ì‹¤í–‰ (ìš”ì¼:${dow})`);
    if(dow>=1&&dow<=5){
      // ì›”~ê¸ˆ: ì •ì‚° ì‹¤í–‰
      await autoSettleAll(today);
    } else {
      // í† /ì¼: ì •ì‚° ì—†ìŒ â€” ë¡œê·¸ë§Œ
      console.log(`[Scheduler] ì£¼ë§(${today}) â€” ë°°ë‹¹ ì—†ìŒ`);
    }
    updateNextRoiTimer();
    scheduleNextRun(); // ë‹¤ìŒë‚  ì˜ˆì•½ ì¬ì„¤ì •
  }, msUntilNext);
}
let _timerInterval=null;
function updateNextRoiTimer(){
  if(_timerInterval) clearInterval(_timerInterval);
  _timerInterval=setInterval(()=>{
    const el=document.getElementById('next-roi-timer'); if(!el)return;
    const now=new Date(); const dow=now.getDay();
    // ë‹¤ìŒ ì •ì‚°ì¼ ê³„ì‚° (í•­ìƒ ë‚´ì¼ 00:00:01)
    let daysAhead=1;
    if(dow===5) daysAhead=3;      // ê¸ˆìš”ì¼ â†’ ì›”ìš”ì¼
    else if(dow===6) daysAhead=2; // í† ìš”ì¼ â†’ ì›”ìš”ì¼
    const next=new Date(now);
    next.setDate(next.getDate()+daysAhead);
    next.setHours(0,0,1,0); // 00:00:01
    const diff=Math.max(0,next-now);
    const h=String(Math.floor(diff/3600000)).padStart(2,'0');
    const m=String(Math.floor((diff%3600000)/60000)).padStart(2,'0');
    const s=String(Math.floor((diff%60000)/1000)).padStart(2,'0');
    const dayNames=['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
    const targetDow=(dow+daysAhead)%7;
    const dayLabel=daysAhead===1?'ë‚´ì¼':dayNames[targetDow]+'ìš”ì¼';
    el.textContent=`ë‹¤ìŒ ë°°ë‹¹ (${dayLabel} ì˜¤ì „ 12ì‹œ 01ì´ˆ) â€” ${h}:${m}:${s}`;
  },1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  // ë¡œë”© í‘œì‹œ
  document.body.insertAdjacentHTML('beforeend',`
    <div id="fb-loading" style="position:fixed;inset:0;background:#07080d;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;padding:20px;text-align:center;">
      <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:#d4a853;margin-bottom:20px;letter-spacing:2px;">MEDI WORLD</div>
      <div id="fb-spinner" style="width:44px;height:44px;border:3px solid rgba(212,168,83,0.2);border-top-color:#d4a853;border-radius:50%;animation:spin 0.8s linear infinite;"></div>
      <div id="fb-status" style="margin-top:18px;font-size:16px;color:#6b7280;">ì„œë²„ì— ì—°ê²°í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
      <button id="fb-retry-btn" onclick="location.reload()" style="display:none;margin-top:22px;padding:14px 32px;background:#d4a853;color:#07080d;border:none;border-radius:12px;font-size:16px;font-weight:800;cursor:pointer;min-height:52px;">&#128260; ë‹¤ì‹œ ì‹œë„</button>
    </div>
  `);
  try{
    await initDB();
    await loadSettings();
    await seedIfEmpty();
  }catch(e){
    console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', e);
    const st=document.getElementById('fb-status');
    const sp=document.getElementById('fb-spinner');
    const rb=document.getElementById('fb-retry-btn');
    if(st){st.textContent='ì—°ê²° ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.';st.style.color='#f05d5d';}
    if(sp) sp.style.display='none';
    if(rb) rb.style.display='block';
    return;
  }
  document.getElementById('fb-loading').remove();
  startScheduler();
  document.querySelectorAll('.page').forEach(p=>{p.classList.remove('active');p.style.display='none';});
  document.getElementById('page-login').style.display='flex';
  document.getElementById('page-login').classList.add('active');
  console.log('[MEDI WORLD v5.0] Firebase ì—°ê²° ì™„ë£Œ âœ…');
}
init();
</script>
</body>
</html>
